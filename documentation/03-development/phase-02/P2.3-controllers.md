# P2.3 Controllers Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing all controllers for The Strengths Toolbox website, including web controllers for public-facing pages, admin controllers for content management, and API controllers for chatbot functionality.

### 1.2 Scope
This implementation plan covers tasks P2.3.1 through P2.3.9:
- **P2.3.1**: Create HomeController
- **P2.3.2**: Create PageController
- **P2.3.3**: Create BlogController
- **P2.3.4**: Create ContactController
- **P2.3.5**: Create AdminDashboardController
- **P2.3.6**: Create AdminPageController
- **P2.3.7**: Create AdminBlogController
- **P2.3.8**: Create AdminFormController
- **P2.3.9**: Create ChatbotController (API)

### 1.3 Success Criteria
- All web controllers created and functional
- All admin controllers created with proper authentication
- API controller for chatbot implemented
- Routes properly configured
- Request validation implemented
- Error handling in place
- Controllers follow clean code principles

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel MVC pattern
- Controller organization
- Request validation
- Route definition
- Middleware usage
- Dependency injection

### 2.2 Dependencies
- Task P1.3.4 completed (Base controllers created)
- Task P1.4.3 completed (Admin authentication)
- Task P2.1.1-P2.1.6 completed (Services created)
- Task P2.2.1-P2.2.3 completed (Repositories created)
- Models created and relationships defined

### 2.3 Reference Documents
- Laravel MVC Architecture: `documentation/01-architecture/02-laravel-mvc-architecture.md`
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`
- System Architecture Overview: `documentation/01-architecture/01-system-architecture-overview.md`

## 3. Controller Organization

### 3.1 Directory Structure
```
app/Http/Controllers/
├── Controller.php (base controller)
├── Web/
│   ├── HomeController.php
│   ├── PageController.php
│   ├── BlogController.php
│   └── ContactController.php
├── Admin/
│   ├── AdminDashboardController.php
│   ├── AdminPageController.php
│   ├── AdminBlogController.php
│   └── AdminFormController.php
└── Api/
    └── ChatbotController.php
```

### 3.2 Controller Responsibilities
- Handle HTTP requests
- Validate input via Form Requests
- Call service layer for business logic
- Return appropriate responses (views, JSON, redirects)
- Handle errors gracefully

## 4. Task P2.3.1: Create HomeController

### 4.1 Overview
Create a controller to handle the homepage, displaying hero sections, testimonials, and processing eBook sign-up forms.

### 4.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Web/HomeController.php`**
```php
<?php

namespace App\Http\Controllers\Web;

use App\Http\Controllers\Controller;
use App\Services\BlogPostService;
use App\Services\SEOService;
use App\Services\FormService;
use App\Models\Testimonial;
use Illuminate\Http\Request;

class HomeController extends Controller
{
    protected BlogPostService $blogPostService;
    protected SEOService $seoService;
    protected FormService $formService;

    public function __construct(
        BlogPostService $blogPostService,
        SEOService $seoService,
        FormService $formService
    ) {
        $this->blogPostService = $blogPostService;
        $this->seoService = $seoService;
        $this->formService = $formService;
    }

    /**
     * Display the homepage
     *
     * @return \Illuminate\View\View
     */
    public function index()
    {
        // Get recent blog posts
        $recentPosts = $this->blogPostService->getRecent(3);

        // Get featured testimonials
        $testimonials = Testimonial::where('is_featured', true)
            ->orderBy('created_at', 'desc')
            ->limit(6)
            ->get();

        // Get SEO metadata
        $seo = $this->seoService->getDefaultMeta();

        return view('pages.home', compact('recentPosts', 'testimonials', 'seo'));
    }

    /**
     * Handle eBook sign-up form submission
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function submitEbookForm(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|email|max:255',
        ]);

        try {
            // Get or create eBook form
            $form = $this->formService->getBySlug('ebook-signup');
            
            if (!$form) {
                // Create form if it doesn't exist
                $form = $this->formService->create([
                    'name' => 'eBook Sign-up',
                    'slug' => 'ebook-signup',
                    'email_to' => config('mail.contact_to'),
                    'is_active' => true,
                    'fields' => json_encode([
                        ['name' => 'name', 'type' => 'text', 'required' => true],
                        ['name' => 'email', 'type' => 'email', 'required' => true],
                    ]),
                ]);
            }

            // Submit form
            $this->formService->submit($form->id, $validated);

            return redirect()->back()->with('success', 'Thank you! Your eBook will be sent to your email shortly.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withInput()
                ->withErrors(['error' => 'Something went wrong. Please try again.']);
        }
    }
}
```

### 4.3 Routes
Add to `routes/web.php`:
```php
Route::get('/', [HomeController::class, 'index'])->name('home');
Route::post('/ebook-signup', [HomeController::class, 'submitEbookForm'])->name('ebook.signup');
```

## 5. Task P2.3.2: Create PageController

### 5.1 Overview
Create a controller to handle static and dynamic page display, including SEO metadata.

### 5.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Web/PageController.php`**
```php
<?php

namespace App\Http\Controllers\Web;

use App\Http\Controllers\Controller;
use App\Services\PageService;
use App\Services\SEOService;
use Illuminate\Http\Request;

class PageController extends Controller
{
    protected PageService $pageService;
    protected SEOService $seoService;

    public function __construct(PageService $pageService, SEOService $seoService)
    {
        $this->pageService = $pageService;
        $this->seoService = $seoService;
    }

    /**
     * Display a page by slug
     *
     * @param string $slug
     * @return \Illuminate\View\View|\Illuminate\Http\Response
     */
    public function show(string $slug)
    {
        $page = $this->pageService->getBySlug($slug);

        if (!$page) {
            abort(404);
        }

        // Get SEO metadata
        $seo = $this->seoService->getPageMeta($page);

        return view('pages.show', compact('page', 'seo'));
    }
}
```

### 5.3 Routes
Add to `routes/web.php`:
```php
// Static pages
Route::get('/about-us', [PageController::class, 'show'])->name('about');
Route::get('/strengths-programme', [PageController::class, 'show'])->name('strengths-programme');

// Dynamic pages (catch-all - must be last)
Route::get('/{slug}', [PageController::class, 'show'])->name('page.show');
```

## 6. Task P2.3.3: Create BlogController

### 6.1 Overview
Create a controller to handle blog listing, individual post display, category/tag archives, and search functionality.

### 6.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Web/BlogController.php`**
```php
<?php

namespace App\Http\Controllers\Web;

use App\Http\Controllers\Controller;
use App\Services\BlogPostService;
use App\Services\SEOService;
use App\Models\Category;
use App\Models\Tag;
use Illuminate\Http\Request;

class BlogController extends Controller
{
    protected BlogPostService $blogPostService;
    protected SEOService $seoService;

    public function __construct(BlogPostService $blogPostService, SEOService $seoService)
    {
        $this->blogPostService = $blogPostService;
        $this->seoService = $seoService;
    }

    /**
     * Display blog listing page
     *
     * @param Request $request
     * @return \Illuminate\View\View
     */
    public function index(Request $request)
    {
        $posts = $this->blogPostService->getPublishedPaginated(10);
        
        $categories = Category::all();
        $tags = Tag::all();

        $seo = [
            'title' => 'Blog - ' . config('app.name'),
            'description' => 'Read our latest articles and insights on team building, leadership, and organizational development.',
        ];

        return view('blog.index', compact('posts', 'categories', 'tags', 'seo'));
    }

    /**
     * Display a single blog post
     *
     * @param string $slug
     * @return \Illuminate\View\View|\Illuminate\Http\Response
     */
    public function show(string $slug)
    {
        $post = $this->blogPostService->getPublishedBySlug($slug);

        if (!$post) {
            abort(404);
        }

        // Get related posts
        $relatedPosts = $this->blogPostService->getRelated($post, 3);

        // Get SEO metadata
        $seo = $this->seoService->getBlogPostMeta($post);

        return view('blog.show', compact('post', 'relatedPosts', 'seo'));
    }

    /**
     * Display posts by category
     *
     * @param string $slug
     * @return \Illuminate\View\View|\Illuminate\Http\Response
     */
    public function category(string $slug)
    {
        $category = Category::where('slug', $slug)->first();

        if (!$category) {
            abort(404);
        }

        $posts = $this->blogPostService->getByCategory($slug, 10);

        $seo = [
            'title' => $category->name . ' - Blog - ' . config('app.name'),
            'description' => "Browse all posts in the {$category->name} category.",
        ];

        return view('blog.category', compact('category', 'posts', 'seo'));
    }

    /**
     * Display posts by tag
     *
     * @param string $slug
     * @return \Illuminate\View\View|\Illuminate\Http\Response
     */
    public function tag(string $slug)
    {
        $tag = Tag::where('slug', $slug)->first();

        if (!$tag) {
            abort(404);
        }

        $posts = $this->blogPostService->getByTag($slug, 10);

        $seo = [
            'title' => $tag->name . ' - Blog - ' . config('app.name'),
            'description' => "Browse all posts tagged with {$tag->name}.",
        ];

        return view('blog.tag', compact('tag', 'posts', 'seo'));
    }

    /**
     * Search blog posts
     *
     * @param Request $request
     * @return \Illuminate\View\View
     */
    public function search(Request $request)
    {
        $query = $request->get('q', '');

        if (empty($query)) {
            return redirect()->route('blog.index');
        }

        $posts = $this->blogPostService->search($query, 10);

        $seo = [
            'title' => "Search: {$query} - Blog - " . config('app.name'),
            'description' => "Search results for: {$query}",
        ];

        return view('blog.search', compact('posts', 'query', 'seo'));
    }
}
```

### 6.3 Routes
Add to `routes/web.php`:
```php
Route::get('/blog', [BlogController::class, 'index'])->name('blog.index');
Route::get('/blog/search', [BlogController::class, 'search'])->name('blog.search');
Route::get('/blog/category/{slug}', [BlogController::class, 'category'])->name('blog.category');
Route::get('/blog/tag/{slug}', [BlogController::class, 'tag'])->name('blog.tag');
Route::get('/blog/{slug}', [BlogController::class, 'show'])->name('blog.show');
```

## 7. Task P2.3.4: Create ContactController

### 7.1 Overview
Create a controller to handle contact page display and contact form submissions.

### 7.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Web/ContactController.php`**
```php
<?php

namespace App\Http\Controllers\Web;

use App\Http\Controllers\Controller;
use App\Services\FormService;
use App\Services\EmailService;
use App\Services\SEOService;
use Illuminate\Http\Request;

class ContactController extends Controller
{
    protected FormService $formService;
    protected EmailService $emailService;
    protected SEOService $seoService;

    public function __construct(
        FormService $formService,
        EmailService $emailService,
        SEOService $seoService
    ) {
        $this->formService = $formService;
        $this->emailService = $emailService;
        $this->seoService = $seoService;
    }

    /**
     * Display contact page
     *
     * @return \Illuminate\View\View
     */
    public function show()
    {
        $seo = [
            'title' => 'Contact Us - ' . config('app.name'),
            'description' => 'Get in touch with The Strengths Toolbox. We\'d love to hear from you.',
        ];

        return view('pages.contact', compact('seo'));
    }

    /**
     * Handle contact form submission
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function submit(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|email|max:255',
            'phone' => 'nullable|string|max:20',
            'subject' => 'required|string|max:255',
            'message' => 'required|string|max:5000',
        ]);

        try {
            // Get or create contact form
            $form = $this->formService->getBySlug('contact');
            
            if (!$form) {
                $form = $this->formService->create([
                    'name' => 'Contact Form',
                    'slug' => 'contact',
                    'email_to' => config('mail.contact_to', config('mail.from.address')),
                    'is_active' => true,
                    'fields' => json_encode([
                        ['name' => 'name', 'type' => 'text', 'required' => true],
                        ['name' => 'email', 'type' => 'email', 'required' => true],
                        ['name' => 'phone', 'type' => 'text', 'required' => false],
                        ['name' => 'subject', 'type' => 'text', 'required' => true],
                        ['name' => 'message', 'type' => 'textarea', 'required' => true],
                    ]),
                ]);
            }

            // Submit form
            $this->formService->submit($form->id, $validated);

            // Also send direct email
            $this->emailService->sendContactForm($validated);

            return redirect()->route('contact')
                ->with('success', 'Thank you for your message! We\'ll get back to you soon.');
        } catch (\Exception $e) {
            return redirect()->route('contact')
                ->withInput()
                ->withErrors(['error' => 'Something went wrong. Please try again.']);
        }
    }
}
```

### 7.3 Routes
Add to `routes/web.php`:
```php
Route::get('/contact', [ContactController::class, 'show'])->name('contact');
Route::post('/contact', [ContactController::class, 'submit'])->name('contact.submit');
```

## 8. Task P2.3.5: Create AdminDashboardController

### 8.1 Overview
Create a controller for the admin dashboard, displaying overview statistics and quick actions.

### 8.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Admin/AdminDashboardController.php`**
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Page;
use App\Models\BlogPost;
use App\Models\FormSubmission;
use App\Models\Testimonial;
use Illuminate\Support\Facades\DB;

class AdminDashboardController extends Controller
{
    /**
     * Display admin dashboard
     *
     * @return \Illuminate\View\View
     */
    public function index()
    {
        $stats = [
            'pages' => [
                'total' => Page::count(),
                'published' => Page::where('is_published', true)->count(),
                'draft' => Page::where('is_published', false)->count(),
            ],
            'blog_posts' => [
                'total' => BlogPost::count(),
                'published' => BlogPost::where('is_published', true)->count(),
                'draft' => BlogPost::where('is_published', false)->count(),
            ],
            'form_submissions' => [
                'total' => FormSubmission::count(),
                'today' => FormSubmission::whereDate('created_at', today())->count(),
                'this_week' => FormSubmission::whereBetween('created_at', [now()->startOfWeek(), now()->endOfWeek()])->count(),
            ],
            'testimonials' => [
                'total' => Testimonial::count(),
                'featured' => Testimonial::where('is_featured', true)->count(),
            ],
        ];

        // Recent activity
        $recentSubmissions = FormSubmission::with('form')
            ->orderBy('created_at', 'desc')
            ->limit(5)
            ->get();

        $recentPosts = BlogPost::with('author')
            ->orderBy('created_at', 'desc')
            ->limit(5)
            ->get();

        return view('admin.dashboard', compact('stats', 'recentSubmissions', 'recentPosts'));
    }
}
```

### 8.3 Routes
Add to `routes/admin.php`:
```php
Route::get('/', [AdminDashboardController::class, 'index'])->name('dashboard');
```

## 9. Task P2.3.6: Create AdminPageController

### 9.1 Overview
Create a controller for managing pages in the admin panel, including CRUD operations.

### 9.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Admin/AdminPageController.php`**
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Services\PageService;
use App\Services\SEOService;
use Illuminate\Http\Request;

class AdminPageController extends Controller
{
    protected PageService $pageService;
    protected SEOService $seoService;

    public function __construct(PageService $pageService, SEOService $seoService)
    {
        $this->pageService = $pageService;
        $this->seoService = $seoService;
    }

    /**
     * Display a listing of pages
     *
     * @param Request $request
     * @return \Illuminate\View\View
     */
    public function index(Request $request)
    {
        $filters = [
            'search' => $request->get('search'),
            'is_published' => $request->get('is_published'),
        ];

        $pages = $this->pageService->getPaginated(15, $filters);

        return view('admin.pages.index', compact('pages'));
    }

    /**
     * Show the form for creating a new page
     *
     * @return \Illuminate\View\View
     */
    public function create()
    {
        return view('admin.pages.create');
    }

    /**
     * Store a newly created page
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:pages,slug',
            'content' => 'required|string',
            'meta_title' => 'nullable|string|max:255',
            'meta_description' => 'nullable|string|max:500',
            'is_published' => 'boolean',
        ]);

        try {
            $page = $this->pageService->create($validated);

            return redirect()->route('admin.pages.index')
                ->with('success', 'Page created successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withInput()
                ->withErrors(['error' => 'Failed to create page: ' . $e->getMessage()]);
        }
    }

    /**
     * Display the specified page
     *
     * @param int $id
     * @return \Illuminate\View\View
     */
    public function show(int $id)
    {
        $page = $this->pageService->getById($id);

        if (!$page) {
            abort(404);
        }

        return view('admin.pages.show', compact('page'));
    }

    /**
     * Show the form for editing the specified page
     *
     * @param int $id
     * @return \Illuminate\View\View
     */
    public function edit(int $id)
    {
        $page = $this->pageService->getById($id);

        if (!$page) {
            abort(404);
        }

        return view('admin.pages.edit', compact('page'));
    }

    /**
     * Update the specified page
     *
     * @param Request $request
     * @param int $id
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, int $id)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:pages,slug,' . $id,
            'content' => 'required|string',
            'meta_title' => 'nullable|string|max:255',
            'meta_description' => 'nullable|string|max:500',
            'is_published' => 'boolean',
        ]);

        try {
            $page = $this->pageService->update($id, $validated);

            return redirect()->route('admin.pages.index')
                ->with('success', 'Page updated successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withInput()
                ->withErrors(['error' => 'Failed to update page: ' . $e->getMessage()]);
        }
    }

    /**
     * Remove the specified page
     *
     * @param int $id
     * @return \Illuminate\Http\RedirectResponse
     */
    public function destroy(int $id)
    {
        try {
            $this->pageService->delete($id);

            return redirect()->route('admin.pages.index')
                ->with('success', 'Page deleted successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withErrors(['error' => 'Failed to delete page: ' . $e->getMessage()]);
        }
    }
}
```

### 9.3 Routes
Add to `routes/admin.php`:
```php
Route::resource('pages', AdminPageController::class);
```

## 10. Task P2.3.7: Create AdminBlogController

### 10.1 Overview
Create a controller for managing blog posts in the admin panel, including CRUD operations and category/tag management.

### 10.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Admin/AdminBlogController.php`**
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Services\BlogPostService;
use App\Models\Category;
use App\Models\Tag;
use Illuminate\Http\Request;

class AdminBlogController extends Controller
{
    protected BlogPostService $blogPostService;

    public function __construct(BlogPostService $blogPostService)
    {
        $this->blogPostService = $blogPostService;
    }

    /**
     * Display a listing of blog posts
     *
     * @param Request $request
     * @return \Illuminate\View\View
     */
    public function index(Request $request)
    {
        $filters = [
            'search' => $request->get('search'),
            'is_published' => $request->get('is_published'),
            'author_id' => $request->get('author_id'),
            'category_id' => $request->get('category_id'),
        ];

        $posts = $this->blogPostService->getPaginated(15, $filters);
        $categories = Category::all();

        return view('admin.blog.index', compact('posts', 'categories'));
    }

    /**
     * Show the form for creating a new blog post
     *
     * @return \Illuminate\View\View
     */
    public function create()
    {
        $categories = Category::all();
        $tags = Tag::all();

        return view('admin.blog.create', compact('categories', 'tags'));
    }

    /**
     * Store a newly created blog post
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:blog_posts,slug',
            'excerpt' => 'nullable|string|max:500',
            'content' => 'required|string',
            'author_id' => 'required|exists:users,id',
            'published_at' => 'nullable|date',
            'is_published' => 'boolean',
            'category_ids' => 'nullable|array',
            'category_ids.*' => 'exists:categories,id',
            'tag_ids' => 'nullable|array',
            'tag_ids.*' => 'exists:tags,id',
            'featured_image' => 'nullable|image|max:2048',
        ]);

        try {
            $post = $this->blogPostService->create($validated);

            return redirect()->route('admin.blog.index')
                ->with('success', 'Blog post created successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withInput()
                ->withErrors(['error' => 'Failed to create blog post: ' . $e->getMessage()]);
        }
    }

    /**
     * Display the specified blog post
     *
     * @param int $id
     * @return \Illuminate\View\View
     */
    public function show(int $id)
    {
        $post = $this->blogPostService->getById($id);

        if (!$post) {
            abort(404);
        }

        return view('admin.blog.show', compact('post'));
    }

    /**
     * Show the form for editing the specified blog post
     *
     * @param int $id
     * @return \Illuminate\View\View
     */
    public function edit(int $id)
    {
        $post = $this->blogPostService->getById($id);

        if (!$post) {
            abort(404);
        }

        $categories = Category::all();
        $tags = Tag::all();

        return view('admin.blog.edit', compact('post', 'categories', 'tags'));
    }

    /**
     * Update the specified blog post
     *
     * @param Request $request
     * @param int $id
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, int $id)
    {
        $validated = $request->validate([
            'title' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:blog_posts,slug,' . $id,
            'excerpt' => 'nullable|string|max:500',
            'content' => 'required|string',
            'author_id' => 'required|exists:users,id',
            'published_at' => 'nullable|date',
            'is_published' => 'boolean',
            'category_ids' => 'nullable|array',
            'category_ids.*' => 'exists:categories,id',
            'tag_ids' => 'nullable|array',
            'tag_ids.*' => 'exists:tags,id',
            'featured_image' => 'nullable|image|max:2048',
        ]);

        try {
            $post = $this->blogPostService->update($id, $validated);

            return redirect()->route('admin.blog.index')
                ->with('success', 'Blog post updated successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withInput()
                ->withErrors(['error' => 'Failed to update blog post: ' . $e->getMessage()]);
        }
    }

    /**
     * Remove the specified blog post
     *
     * @param int $id
     * @return \Illuminate\Http\RedirectResponse
     */
    public function destroy(int $id)
    {
        try {
            $this->blogPostService->delete($id);

            return redirect()->route('admin.blog.index')
                ->with('success', 'Blog post deleted successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withErrors(['error' => 'Failed to delete blog post: ' . $e->getMessage()]);
        }
    }
}
```

### 10.3 Routes
Add to `routes/admin.php`:
```php
Route::resource('blog', AdminBlogController::class);
```

## 11. Task P2.3.8: Create AdminFormController

### 11.1 Overview
Create a controller for managing forms and form submissions in the admin panel.

### 11.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Admin/AdminFormController.php`**
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Services\FormService;
use Illuminate\Http\Request;

class AdminFormController extends Controller
{
    protected FormService $formService;

    public function __construct(FormService $formService)
    {
        $this->formService = $formService;
    }

    /**
     * Display a listing of forms
     *
     * @return \Illuminate\View\View
     */
    public function index()
    {
        $forms = $this->formService->getAllActive();

        return view('admin.forms.index', compact('forms'));
    }

    /**
     * Display form submissions
     *
     * @param int $formId
     * @return \Illuminate\View\View
     */
    public function submissions(int $formId)
    {
        $form = $this->formService->getById($formId);

        if (!$form) {
            abort(404);
        }

        $submissions = $this->formService->getSubmissions($formId, 20);

        return view('admin.forms.submissions', compact('form', 'submissions'));
    }

    /**
     * Show a specific submission
     *
     * @param int $formId
     * @param int $submissionId
     * @return \Illuminate\View\View
     */
    public function showSubmission(int $formId, int $submissionId)
    {
        $form = $this->formService->getById($formId);
        $submission = \App\Models\FormSubmission::findOrFail($submissionId);

        return view('admin.forms.submission', compact('form', 'submission'));
    }
}
```

### 11.3 Routes
Add to `routes/admin.php`:
```php
Route::get('/forms', [AdminFormController::class, 'index'])->name('forms.index');
Route::get('/forms/{formId}/submissions', [AdminFormController::class, 'submissions'])->name('forms.submissions');
Route::get('/forms/{formId}/submissions/{submissionId}', [AdminFormController::class, 'showSubmission'])->name('forms.submission.show');
```

## 12. Task P2.3.9: Create ChatbotController (API)

### 12.1 Overview
Create an API controller for handling chatbot requests, processing messages, and managing conversations.

### 12.2 Step-by-Step Implementation

**File: `app/Http/Controllers/Api/ChatbotController.php`**
```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Services\ChatbotService;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;

class ChatbotController extends Controller
{
    protected ChatbotService $chatbotService;

    public function __construct(ChatbotService $chatbotService)
    {
        $this->chatbotService = $chatbotService;
    }

    /**
     * Send a message to the chatbot
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function sendMessage(Request $request): JsonResponse
    {
        $validated = $request->validate([
            'message' => 'required|string|max:1000',
            'conversation_id' => 'nullable|exists:chatbot_conversations,id',
            'session_id' => 'nullable|string|max:255',
        ]);

        try {
            $conversationId = $validated['conversation_id'] ?? null;
            $sessionId = $validated['session_id'] ?? session()->getId();

            // Get or create conversation
            if (!$conversationId) {
                $conversation = $this->chatbotService->createConversation($sessionId);
                $conversationId = $conversation->id;
            }

            // Send message and get response
            $response = $this->chatbotService->sendMessage(
                $conversationId,
                $validated['message']
            );

            return response()->json([
                'success' => true,
                'conversation_id' => $conversationId,
                'response' => $response,
            ]);
        } catch (\Exception $e) {
            Log::error('Chatbot error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'An error occurred. Please try again.',
            ], 500);
        }
    }

    /**
     * Get conversation history
     *
     * @param Request $request
     * @param int $conversationId
     * @return JsonResponse
     */
    public function getConversation(int $conversationId): JsonResponse
    {
        try {
            $conversation = $this->chatbotService->getConversation($conversationId);

            if (!$conversation) {
                return response()->json([
                    'success' => false,
                    'message' => 'Conversation not found',
                ], 404);
            }

            return response()->json([
                'success' => true,
                'conversation' => $conversation,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'An error occurred.',
            ], 500);
        }
    }
}
```

### 12.3 Routes
Add to `routes/api.php`:
```php
Route::prefix('chatbot')->group(function () {
    Route::post('/message', [ChatbotController::class, 'sendMessage'])
        ->middleware('throttle:10,1')
        ->name('api.chatbot.message');
    
    Route::get('/conversation/{conversationId}', [ChatbotController::class, 'getConversation'])
        ->name('api.chatbot.conversation');
});
```

## 13. Request Validation

### 13.1 Form Requests (Optional but Recommended)
For complex validation, create Form Request classes:

**File: `app/Http/Requests/StorePageRequest.php`**
```php
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StorePageRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'title' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:pages,slug',
            'content' => 'required|string',
            'meta_title' => 'nullable|string|max:255',
            'meta_description' => 'nullable|string|max:500',
            'is_published' => 'boolean',
        ];
    }

    public function messages(): array
    {
        return [
            'title.required' => 'The title field is required.',
            'content.required' => 'The content field is required.',
        ];
    }
}
```

## 14. Testing and Validation

### 14.1 Test Web Controllers
```bash
# Test routes
php artisan route:list

# Test in browser
# Visit: http://localhost:8000
# Visit: http://localhost:8000/blog
# Visit: http://localhost:8000/contact
```

### 14.2 Test Admin Controllers
```bash
# Login to admin panel
# Visit: http://localhost:8000/admin
# Test CRUD operations
```

### 14.3 Test API Controller
```bash
# Test with curl or Postman
curl -X POST http://localhost:8000/api/chatbot/message \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello"}'
```

### 14.4 Common Issues and Solutions

#### Issue: Route not found
**Solution**: 
- Clear route cache: `php artisan route:clear`
- Check route file is loaded in `RouteServiceProvider`
- Verify route name and path

#### Issue: 403 Forbidden on admin routes
**Solution**: 
- Check authentication middleware is applied
- Verify user is logged in
- Check user has admin role

#### Issue: Validation errors not showing
**Solution**: 
- Check `@error` directives in Blade templates
- Verify `$errors` variable is available
- Check form has `@csrf` token

#### Issue: API returns 401 Unauthorized
**Solution**: 
- Check API authentication middleware
- Verify Sanctum is configured
- Check token is sent in request headers

## 15. Best Practices

### 15.1 Controller Design
- Keep controllers thin (delegate to services)
- Use dependency injection
- Return appropriate HTTP status codes
- Handle errors gracefully
- Use resource controllers for CRUD operations

### 15.2 Request Validation
- Validate all input
- Use Form Requests for complex validation
- Provide clear error messages
- Sanitize user input

### 15.3 Response Handling
- Return appropriate views for web requests
- Return JSON for API requests
- Use redirects with flash messages
- Handle 404 errors properly

## 16. References

### 16.1 Architecture Documents
- Laravel MVC Architecture: `documentation/01-architecture/02-laravel-mvc-architecture.md`
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`
- System Architecture Overview: `documentation/01-architecture/01-system-architecture-overview.md`

### 16.2 External Resources
- [Laravel Controllers](https://laravel.com/docs/10.x/controllers)
- [Laravel Routing](https://laravel.com/docs/10.x/routing)
- [Laravel Validation](https://laravel.com/docs/10.x/validation)
- [Laravel API Resources](https://laravel.com/docs/10.x/eloquent-resources)

### 16.3 Related Tasks
- **Previous Task**: P2.1 - Service Layer, P2.2 - Repository Layer
- **Next Task**: P2.4 - Middleware, P2.5 - Frontend Foundation
- **Dependent Tasks**: P3.1-P3.6 - CMS features (will use these controllers)

---

**Document Version**: 1.0  
**Last Updated**: 2025  
**Status**: Ready for Implementation
