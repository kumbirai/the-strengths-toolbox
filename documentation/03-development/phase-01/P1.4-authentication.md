# P1.4 Authentication Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing authentication for The Strengths Toolbox website, including admin authentication, login/logout functionality, and password reset features.

### 1.2 Scope
This implementation plan covers tasks P1.4.1 through P1.4.5:
- **P1.4.1**: Install Laravel Breeze/Sanctum
- **P1.4.2**: Configure authentication guards
- **P1.4.3**: Create admin authentication
- **P1.4.4**: Build login/logout functionality
- **P1.4.5**: Implement password reset

### 1.3 Success Criteria
- Laravel Sanctum installed and configured
- Admin authentication guard configured
- Admin login/logout functionality working
- Password reset functionality implemented
- Admin routes protected by authentication middleware

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel authentication system
- Middleware concepts
- Session management
- Email configuration

### 2.2 Dependencies
- Task P1.1.1 completed (Laravel installed)
- Task P1.2.3 completed (User model created)
- Task P1.3.4 completed (Base controllers created)
- Task P1.3.6 completed (Routing configured)

### 2.3 Reference Documents
- Laravel MVC Architecture: `documentation/01-architecture/02-laravel-mvc-architecture.md`
- System Architecture Overview: `documentation/01-architecture/01-system-architecture-overview.md`

## 3. Task P1.4.1: Install Laravel Breeze/Sanctum

### 3.1 Overview
Install Laravel Sanctum for API authentication. For this project, we'll use Laravel's built-in authentication with Sanctum for API token authentication, and create a custom admin authentication system.

### 3.2 Step-by-Step Implementation

#### Step 1: Install Laravel Sanctum
```bash
composer require laravel/sanctum
```

#### Step 2: Publish Sanctum Configuration
```bash
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
```

#### Step 3: Run Sanctum Migrations
```bash
php artisan migrate
```

This will create the `personal_access_tokens` table for API token authentication.

#### Step 4: Configure Sanctum

**File: `config/sanctum.php`** (verify configuration)
```php
<?php

return [
    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        env('APP_URL') ? ','.parse_url(env('APP_URL'), PHP_URL_HOST) : ''
    ))),

    'guard' => ['web'],

    'expiration' => null,

    'token_prefix' => env('SANCTUM_TOKEN_PREFIX', ''),

    'middleware' => [
        'verify_csrf_token' => App\Http\Middleware\VerifyCsrfToken::class,
        'encrypt_cookies' => App\Http\Middleware\EncryptCookies::class,
    ],
];
```

#### Step 5: Update User Model for Sanctum

**File: `app/Models/User.php`** (add HasApiTokens trait)
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    use HasApiTokens, HasFactory, Notifiable;

    // ... rest of the model
}
```

#### Step 6: Update AppServiceProvider

**File: `app/Providers/AppServiceProvider.php`**
```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Laravel\Sanctum\Sanctum;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        //
    }

    public function boot(): void
    {
        Sanctum::usePersonalAccessTokenModel(\Laravel\Sanctum\PersonalAccessToken::class);
    }
}
```

### 3.3 Validation
```bash
# Verify Sanctum installation
php artisan about

# Check personal_access_tokens table exists
php artisan tinker
\DB::table('personal_access_tokens')->count(); // Should not error
```

## 4. Task P1.4.2: Configure Authentication Guards

### 4.1 Overview
Configure authentication guards for web (default) and admin authentication. We'll use a separate guard for admin users.

### 4.2 Step-by-Step Implementation

#### Step 1: Update Auth Configuration

**File: `config/auth.php`**
```php
<?php

return [
    'defaults' => [
        'guard' => 'web',
        'passwords' => 'users',
    ],

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],

        'admin' => [
            'driver' => 'session',
            'provider' => 'admins',
        ],

        'sanctum' => [
            'driver' => 'sanctum',
            'provider' => 'users',
        ],
    ],

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],

        'admins' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
    ],

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => 'password_reset_tokens',
            'expire' => 60,
            'throttle' => 60,
        ],

        'admins' => [
            'provider' => 'admins',
            'table' => 'password_reset_tokens',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    'password_timeout' => 10800,
];
```

#### Step 2: Create Admin Middleware

**File: `app/Http/Middleware/AdminAuth.php`**
```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Symfony\Component\HttpFoundation\Response;

class AdminAuth
{
    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, Closure $next): Response
    {
        if (!Auth::guard('admin')->check()) {
            return redirect()->route('admin.login');
        }

        $user = Auth::guard('admin')->user();

        // Ensure user has admin or editor role
        if (!in_array($user->role, ['admin', 'editor'])) {
            Auth::guard('admin')->logout();
            return redirect()->route('admin.login')
                ->with('error', 'You do not have permission to access the admin panel.');
        }

        return $next($request);
    }
}
```

#### Step 3: Register Admin Middleware

**File: `app/Http/Kernel.php`**
```php
<?php

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as HttpKernel;

class Kernel extends HttpKernel
{
    /**
     * The application's route middleware groups.
     */
    protected $middlewareGroups = [
        'web' => [
            \App\Http\Middleware\EncryptCookies::class,
            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
            \Illuminate\Session\Middleware\StartSession::class,
            \Illuminate\View\Middleware\ShareErrorsFromSession::class,
            \App\Http\Middleware\VerifyCsrfToken::class,
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],

        'api' => [
            \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
            'throttle:api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],
    ];

    /**
     * The application's route middleware.
     */
    protected $middlewareAliases = [
        'auth' => \App\Http\Middleware\Authenticate::class,
        'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'auth.session' => \Illuminate\Session\Middleware\AuthenticateSession::class,
        'cache.headers' => \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' => \Illuminate\Auth\Middleware\Authorize::class,
        'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' => \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' => \App\Http\Middleware\ValidateSignature::class,
        'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' => \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
        'admin.auth' => \App\Http\Middleware\AdminAuth::class,
    ];
}
```

### 4.3 Validation
```bash
# Test middleware registration
php artisan route:list --middleware=admin.auth

# Should show admin routes with middleware
```

## 5. Task P1.4.3: Create Admin Authentication

### 5.1 Overview
Create admin authentication system with login, logout, and session management using the admin guard.

### 5.2 Step-by-Step Implementation

#### Step 1: Create Admin Login Controller

**File: `app/Http/Controllers/Admin/Auth/LoginController.php`**
```php
<?php

namespace App\Http\Controllers\Admin\Auth;

use App\Http\Controllers\Admin\BaseController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\ValidationException;

class LoginController extends BaseController
{
    /**
     * Show the admin login form
     */
    public function showLoginForm()
    {
        if (Auth::guard('admin')->check()) {
            return redirect()->route('admin.dashboard');
        }

        return view('admin.auth.login');
    }

    /**
     * Handle admin login
     */
    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email' => ['required', 'email'],
            'password' => ['required'],
        ]);

        $remember = $request->boolean('remember');

        if (Auth::guard('admin')->attempt($credentials, $remember)) {
            $request->session()->regenerate();

            $user = Auth::guard('admin')->user();

            // Check if user has admin or editor role
            if (!in_array($user->role, ['admin', 'editor'])) {
                Auth::guard('admin')->logout();
                throw ValidationException::withMessages([
                    'email' => ['You do not have permission to access the admin panel.'],
                ]);
            }

            return redirect()->intended(route('admin.dashboard'));
        }

        throw ValidationException::withMessages([
            'email' => ['The provided credentials do not match our records.'],
        ]);
    }

    /**
     * Handle admin logout
     */
    public function logout(Request $request)
    {
        Auth::guard('admin')->logout();

        $request->session()->invalidate();
        $request->session()->regenerateToken();

        return redirect()->route('admin.login');
    }
}
```

#### Step 2: Create Admin Login View

**File: `resources/views/admin/auth/login.blade.php`**
```blade
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>Admin Login - {{ config('app.name') }}</title>
    
    @vite(['resources/css/app.css', 'resources/js/app.js'])
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Admin Login
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Sign in to access the admin panel
                </p>
            </div>
            
            <form class="mt-8 space-y-6" action="{{ route('admin.login') }}" method="POST">
                @csrf
                
                @if($errors->any())
                    <div class="rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    There were errors with your submission
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        @foreach($errors->all() as $error)
                                            <li>{{ $error }}</li>
                                        @endforeach
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                @endif
                
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email" class="sr-only">Email address</label>
                        <input 
                            id="email" 
                            name="email" 
                            type="email" 
                            autocomplete="email" 
                            required 
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm" 
                            placeholder="Email address"
                            value="{{ old('email') }}"
                        >
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input 
                            id="password" 
                            name="password" 
                            type="password" 
                            autocomplete="current-password" 
                            required 
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm" 
                            placeholder="Password"
                        >
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input 
                            id="remember" 
                            name="remember" 
                            type="checkbox" 
                            class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                        >
                        <label for="remember" class="ml-2 block text-sm text-gray-900">
                            Remember me
                        </label>
                    </div>
                    
                    <div class="text-sm">
                        <a href="{{ route('admin.password.request') }}" class="font-medium text-primary-600 hover:text-primary-500">
                            Forgot your password?
                        </a>
                    </div>
                </div>
                
                <div>
                    <button 
                        type="submit" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    >
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
```

#### Step 3: Update Admin Routes

**File: `routes/admin.php`**
```php
<?php

use App\Http\Controllers\Admin\AdminDashboardController;
use App\Http\Controllers\Admin\Auth\LoginController;
use Illuminate\Support\Facades\Route;

// Admin authentication routes (outside admin.auth middleware)
Route::middleware('guest:admin')->group(function () {
    Route::get('/login', [LoginController::class, 'showLoginForm'])->name('login');
    Route::post('/login', [LoginController::class, 'login']);
});

// Admin routes (protected by admin.auth middleware)
Route::middleware('admin.auth')->group(function () {
    Route::get('/', [AdminDashboardController::class, 'index'])->name('dashboard');
    
    Route::post('/logout', [LoginController::class, 'logout'])->name('logout');
});
```

#### Step 4: Create RedirectIfAuthenticated Middleware for Admin

**File: `app/Http/Middleware/RedirectIfAdminAuthenticated.php`**
```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Symfony\Component\HttpFoundation\Response;

class RedirectIfAdminAuthenticated
{
    /**
     * Handle an incoming request.
     */
    public function handle(Request $request, Closure $next, string $guard = 'admin'): Response
    {
        if (Auth::guard($guard)->check()) {
            return redirect()->route('admin.dashboard');
        }

        return $next($request);
    }
}
```

#### Step 5: Update Kernel for Guest Middleware

**File: `app/Http/Kernel.php`** (update middleware aliases)
```php
'middlewareAliases' => [
    // ... existing middleware
    'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
    'guest.admin' => \App\Http\Middleware\RedirectIfAdminAuthenticated::class,
],
```

### 5.3 Validation
```bash
# Test admin login
php artisan serve

# Visit http://localhost:8000/admin/login
# Should show login form

# Try logging in with admin user from seeder
# Email: admin@thestrengthstoolbox.com
# Password: password
```

## 6. Task P1.4.4: Build Login/Logout Functionality

### 6.1 Overview
The login/logout functionality has been created in the previous task. This section adds additional features and validation.

### 6.2 Step-by-Step Implementation

#### Step 1: Add Login Throttling

**File: `app/Http/Controllers/Admin/Auth/LoginController.php`** (update login method)
```php
public function login(Request $request)
{
    // Throttle login attempts
    $request->validate([
        'email' => ['required', 'email'],
        'password' => ['required'],
    ]);

    // Check if too many login attempts
    $key = 'login.attempts.' . $request->ip();
    $attempts = cache()->get($key, 0);

    if ($attempts >= 5) {
        $seconds = cache()->get('login.lockout.' . $request->ip(), 0);
        if ($seconds > 0) {
            throw ValidationException::withMessages([
                'email' => ['Too many login attempts. Please try again in ' . $seconds . ' seconds.'],
            ]);
        }
    }

    $credentials = $request->only('email', 'password');
    $remember = $request->boolean('remember');

    if (Auth::guard('admin')->attempt($credentials, $remember)) {
        // Clear login attempts on success
        cache()->forget($key);
        cache()->forget('login.lockout.' . $request->ip());

        $request->session()->regenerate();

        $user = Auth::guard('admin')->user();

        if (!in_array($user->role, ['admin', 'editor'])) {
            Auth::guard('admin')->logout();
            throw ValidationException::withMessages([
                'email' => ['You do not have permission to access the admin panel.'],
            ]);
        }

        return redirect()->intended(route('admin.dashboard'));
    }

    // Increment login attempts
    $attempts++;
    cache()->put($key, $attempts, now()->addMinutes(15));

    if ($attempts >= 5) {
        cache()->put('login.lockout.' . $request->ip(), 300, now()->addMinutes(5)); // 5 minute lockout
    }

    throw ValidationException::withMessages([
        'email' => ['The provided credentials do not match our records.'],
    ]);
}
```

#### Step 2: Add Logout Button to Admin Layout

**File: `resources/views/admin/partials/header.blade.php`** (create file)
```blade
<header class="bg-white shadow-sm">
    <div class="px-6 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-semibold">Admin Panel</h1>
            
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    {{ Auth::guard('admin')->user()->name }}
                </span>
                
                <form action="{{ route('admin.logout') }}" method="POST">
                    @csrf
                    <button 
                        type="submit" 
                        class="text-sm text-gray-600 hover:text-gray-900"
                    >
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </div>
</header>
```

#### Step 3: Update Admin Layout to Include Header

**File: `resources/views/layouts/admin.blade.php`** (update)
```blade
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>@yield('title', 'Admin - ' . config('app.name'))</title>
    
    @vite(['resources/css/app.css', 'resources/js/app.js'])
    
    @stack('styles')
</head>
<body class="font-sans antialiased bg-gray-100">
    <div class="min-h-screen">
        @include('admin.partials.sidebar')
        
        <div class="ml-64">
            @include('admin.partials.header')
            
            <main class="p-6">
                @if(session('success'))
                    <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                        {{ session('success') }}
                    </div>
                @endif
                
                @if(session('error'))
                    <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                        {{ session('error') }}
                    </div>
                @endif
                
                @yield('content')
            </main>
        </div>
    </div>
    
    @stack('scripts')
</body>
</html>
```

#### Step 4: Create Admin Sidebar

**File: `resources/views/admin/partials/sidebar.blade.php`** (create file)
```blade
<aside class="fixed left-0 top-0 h-full w-64 bg-gray-800 text-white">
    <div class="p-6">
        <h2 class="text-xl font-bold">{{ config('app.name') }}</h2>
        <p class="text-sm text-gray-400 mt-1">Admin Panel</p>
    </div>
    
    <nav class="mt-6">
        <a 
            href="{{ route('admin.dashboard') }}" 
            class="block px-6 py-3 hover:bg-gray-700 {{ request()->routeIs('admin.dashboard') ? 'bg-gray-700' : '' }}"
        >
            Dashboard
        </a>
        
        <!-- Additional navigation items will be added in Phase 2 -->
    </nav>
</aside>
```

### 6.3 Validation
```bash
# Test login/logout flow
php artisan serve

# 1. Visit /admin/login
# 2. Login with admin credentials
# 3. Should redirect to /admin/dashboard
# 4. Click logout
# 5. Should redirect to /admin/login
```

## 7. Task P1.4.5: Implement Password Reset

### 7.1 Overview
Implement password reset functionality for admin users using Laravel's built-in password reset features.

### 7.2 Step-by-Step Implementation

#### Step 1: Create Password Reset Migration (if not exists)
```bash
php artisan make:migration create_password_reset_tokens_table
```

**File: `database/migrations/YYYY_MM_DD_HHMMSS_create_password_reset_tokens_table.php`**
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('password_reset_tokens');
    }
};
```

#### Step 2: Run Migration
```bash
php artisan migrate
```

#### Step 3: Create Password Reset Controller

**File: `app/Http/Controllers/Admin/Auth/ForgotPasswordController.php`**
```php
<?php

namespace App\Http\Controllers\Admin\Auth;

use App\Http\Controllers\Admin\BaseController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Password;
use Illuminate\Validation\ValidationException;

class ForgotPasswordController extends BaseController
{
    /**
     * Show the password reset request form
     */
    public function showLinkRequestForm()
    {
        return view('admin.auth.passwords.email');
    }

    /**
     * Send password reset link
     */
    public function sendResetLinkEmail(Request $request)
    {
        $request->validate(['email' => 'required|email']);

        $status = Password::broker('admins')->sendResetLink(
            $request->only('email')
        );

        if ($status === Password::RESET_LINK_SENT) {
            return back()->with('status', __($status));
        }

        throw ValidationException::withMessages([
            'email' => [__($status)],
        ]);
    }
}
```

#### Step 4: Create Reset Password Controller

**File: `app/Http/Controllers/Admin/Auth/ResetPasswordController.php`**
```php
<?php

namespace App\Http\Controllers\Admin\Auth;

use App\Http\Controllers\Admin\BaseController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Str;
use Illuminate\Validation\Rules;
use Illuminate\Validation\ValidationException;

class ResetPasswordController extends BaseController
{
    /**
     * Show the password reset form
     */
    public function showResetForm(Request $request, string $token = null)
    {
        return view('admin.auth.passwords.reset')->with([
            'token' => $token,
            'email' => $request->email,
        ]);
    }

    /**
     * Reset the user's password
     */
    public function reset(Request $request)
    {
        $request->validate([
            'token' => 'required',
            'email' => 'required|email',
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
        ]);

        $status = Password::broker('admins')->reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function ($user, $password) {
                $user->forceFill([
                    'password' => Hash::make($password),
                ])->setRememberToken(Str::random(60));

                $user->save();
            }
        );

        if ($status === Password::PASSWORD_RESET) {
            return redirect()->route('admin.login')->with('status', __($status));
        }

        throw ValidationException::withMessages([
            'email' => [__($status)],
        ]);
    }
}
```

#### Step 5: Create Password Reset Email View

**File: `resources/views/admin/auth/passwords/email.blade.php`**
```blade
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>Reset Password - {{ config('app.name') }}</title>
    
    @vite(['resources/css/app.css', 'resources/js/app.js'])
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Reset Password
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Enter your email to receive a password reset link
                </p>
            </div>
            
            <form class="mt-8 space-y-6" action="{{ route('admin.password.email') }}" method="POST">
                @csrf
                
                @if(session('status'))
                    <div class="rounded-md bg-green-50 p-4">
                        <p class="text-sm text-green-800">{{ session('status') }}</p>
                    </div>
                @endif
                
                @if($errors->any())
                    <div class="rounded-md bg-red-50 p-4">
                        <ul class="list-disc pl-5 space-y-1 text-sm text-red-700">
                            @foreach($errors->all() as $error)
                                <li>{{ $error }}</li>
                            @endforeach
                        </ul>
                    </div>
                @endif
                
                <div>
                    <label for="email" class="sr-only">Email address</label>
                    <input 
                        id="email" 
                        name="email" 
                        type="email" 
                        autocomplete="email" 
                        required 
                        class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm" 
                        placeholder="Email address"
                        value="{{ old('email') }}"
                    >
                </div>
                
                <div>
                    <button 
                        type="submit" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    >
                        Send Password Reset Link
                    </button>
                </div>
                
                <div class="text-center">
                    <a href="{{ route('admin.login') }}" class="text-sm text-primary-600 hover:text-primary-500">
                        Back to login
                    </a>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
```

#### Step 6: Create Password Reset Form View

**File: `resources/views/admin/auth/passwords/reset.blade.php`**
```blade
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>Reset Password - {{ config('app.name') }}</title>
    
    @vite(['resources/css/app.css', 'resources/js/app.js'])
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Reset Password
                </h2>
            </div>
            
            <form class="mt-8 space-y-6" action="{{ route('admin.password.update') }}" method="POST">
                @csrf
                <input type="hidden" name="token" value="{{ $token }}">
                
                @if($errors->any())
                    <div class="rounded-md bg-red-50 p-4">
                        <ul class="list-disc pl-5 space-y-1 text-sm text-red-700">
                            @foreach($errors->all() as $error)
                                <li>{{ $error }}</li>
                            @endforeach
                        </ul>
                    </div>
                @endif
                
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input 
                            id="email" 
                            name="email" 
                            type="email" 
                            required 
                            readonly
                            class="mt-1 appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 bg-gray-100 text-gray-500 sm:text-sm" 
                            value="{{ $email }}"
                        >
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">New Password</label>
                        <input 
                            id="password" 
                            name="password" 
                            type="password" 
                            required 
                            class="mt-1 appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm" 
                            placeholder="New password"
                        >
                    </div>
                    
                    <div>
                        <label for="password_confirmation" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <input 
                            id="password_confirmation" 
                            name="password_confirmation" 
                            type="password" 
                            required 
                            class="mt-1 appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm" 
                            placeholder="Confirm new password"
                        >
                    </div>
                </div>
                
                <div>
                    <button 
                        type="submit" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    >
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
```

#### Step 7: Update Admin Routes for Password Reset

**File: `routes/admin.php`** (update)
```php
<?php

use App\Http\Controllers\Admin\AdminDashboardController;
use App\Http\Controllers\Admin\Auth\LoginController;
use App\Http\Controllers\Admin\Auth\ForgotPasswordController;
use App\Http\Controllers\Admin\Auth\ResetPasswordController;
use Illuminate\Support\Facades\Route;

// Admin authentication routes (outside admin.auth middleware)
Route::middleware('guest:admin')->group(function () {
    Route::get('/login', [LoginController::class, 'showLoginForm'])->name('login');
    Route::post('/login', [LoginController::class, 'login']);
    
    // Password reset routes
    Route::get('/password/reset', [ForgotPasswordController::class, 'showLinkRequestForm'])->name('password.request');
    Route::post('/password/email', [ForgotPasswordController::class, 'sendResetLinkEmail'])->name('password.email');
    Route::get('/password/reset/{token}', [ResetPasswordController::class, 'showResetForm'])->name('password.reset');
    Route::post('/password/reset', [ResetPasswordController::class, 'reset'])->name('password.update');
});

// Admin routes (protected by admin.auth middleware)
Route::middleware('admin.auth')->group(function () {
    Route::get('/', [AdminDashboardController::class, 'index'])->name('dashboard');
    
    Route::post('/logout', [LoginController::class, 'logout'])->name('logout');
});
```

#### Step 8: Configure Mail Settings

**File: `.env`** (update mail configuration)
```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="noreply@thestrengthstoolbox.com"
MAIL_FROM_NAME="${APP_NAME}"
```

### 7.3 Validation
```bash
# Test password reset flow
php artisan serve

# 1. Visit /admin/password/reset
# 2. Enter admin email
# 3. Check email for reset link
# 4. Click reset link
# 5. Enter new password
# 6. Should redirect to login
# 7. Login with new password
```

## 8. Testing and Validation

### 8.1 Complete Authentication Test
```bash
# 1. Test admin login
php artisan serve
# Visit /admin/login and login

# 2. Test admin logout
# Click logout button

# 3. Test password reset
# Visit /admin/password/reset

# 4. Test protected routes
# Try accessing /admin without login (should redirect to login)
```

### 8.2 Common Issues and Solutions

#### Issue: "Target class [admin] does not exist"
**Solution**: Ensure `admins` provider is configured in `config/auth.php` and uses the User model.

#### Issue: Password reset email not sending
**Solution**: 
- Check mail configuration in `.env`
- Verify mail driver is configured
- Test with Mailtrap or similar service

#### Issue: Session not persisting
**Solution**: 
- Check `SESSION_DRIVER` in `.env`
- Verify session middleware is applied
- Clear config cache: `php artisan config:clear`

#### Issue: CSRF token mismatch
**Solution**: 
- Ensure `@csrf` is in forms
- Check `VerifyCsrfToken` middleware is not excluding routes
- Clear application cache

## 9. References

### 9.1 Architecture Documents
- Laravel MVC Architecture: `documentation/01-architecture/02-laravel-mvc-architecture.md`
- System Architecture Overview: `documentation/01-architecture/01-system-architecture-overview.md`

### 9.2 External Resources
- [Laravel Authentication](https://laravel.com/docs/10.x/authentication)
- [Laravel Sanctum](https://laravel.com/docs/10.x/sanctum)
- [Laravel Password Reset](https://laravel.com/docs/10.x/passwords)

### 9.3 Related Tasks
- **Previous Task**: P1.3 - Project Structure
- **Next Phase**: P2 - Core Development
- **Dependencies**: P1.1.1, P1.2.3, P1.3.4, P1.3.6
- **Dependent Tasks**: P2.3.5, P2.3.6, P2.3.7, P2.3.8, P2.3.9

---

**Document Version**: 1.0  
**Last Updated**: 2025  
**Status**: Ready for Implementation
