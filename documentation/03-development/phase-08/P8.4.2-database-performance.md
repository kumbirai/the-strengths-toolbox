# P8.4.2 Database Query Performance Test Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for performance testing database queries. These tests verify that database queries are optimized and perform within acceptable timeframes.

### 1.2 Scope
This implementation plan covers task P8.4.2:
- **P8.4.2**: Test database query performance
  - Test query execution times
  - Identify N+1 query problems
  - Test query optimization
  - Test database indexes
  - Measure query performance
  - Verify optimization targets met

### 1.3 Success Criteria
- No N+1 query problems
- Queries execute efficiently
- Indexes used properly
- Query optimization verified
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- Database optimization
- Query optimization
- N+1 query problems
- Database indexes
- Query profiling

### 2.2 Dependencies
- Task P6.2.4 completed (Database optimization implemented)
- Database indexes created
- Query optimization completed

### 2.3 Reference Documents
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`

## 3. Existing Implementation Review

### 3.1 Current State
Database optimizations implemented:
- Indexes on frequently queried columns
- Eager loading for relationships
- Query optimization
- Database query caching

### 3.2 What Needs to Be Done
- Create database performance test plan
- Test query execution times
- Identify N+1 problems
- Test query optimization
- Document results

## 4. Task P8.4.2: Test Database Query Performance

### 4.1 Overview
Create comprehensive database performance tests by:
1. Testing query execution times
2. Identifying N+1 query problems
3. Testing query optimization
4. Verifying indexes
5. Documenting results

### 4.2 Test Structure

Database performance tests should follow this structure:
```php
<?php

namespace Tests\Performance;

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\DB;

class DatabasePerformanceTest extends TestCase
{
    use RefreshDatabase;

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create Query Performance Tests

**File: `tests/Performance/DatabaseQueryPerformanceTest.php`** (new)

**Test Coverage Required:**
- Query execution times
- N+1 query detection
- Query optimization verification
- Index usage verification

**Key Test Cases:**
```php
public function test_page_listing_uses_eager_loading(): void
{
    DB::enableQueryLog();
    
    Page::factory()->count(10)->create();
    $this->get('/pages');
    
    $queries = DB::getQueryLog();
    
    // Should use eager loading, not N+1 queries
    $this->assertLessThan(5, count($queries), "Too many queries executed: " . count($queries));
}

public function test_blog_post_with_relationships_uses_eager_loading(): void
{
    DB::enableQueryLog();
    
    $post = BlogPost::factory()->create();
    $post->categories()->attach(Category::factory()->create());
    $post->tags()->attach(Tag::factory()->create());
    
    $this->get("/blog/{$post->slug}");
    
    $queries = DB::getQueryLog();
    
    // Should use eager loading
    $this->assertLessThan(10, count($queries), "Too many queries executed: " . count($queries));
}

public function test_query_execution_time_acceptable(): void
{
    Page::factory()->count(100)->create();
    
    $startTime = microtime(true);
    $pages = Page::with('seo')->get();
    $endTime = microtime(true);
    
    $executionTime = ($endTime - $startTime) * 1000; // Convert to milliseconds
    
    $this->assertLessThan(500, $executionTime, "Query took {$executionTime}ms, expected < 500ms");
}
```

## 5. Test Implementation Guidelines

### 5.1 Query Logging

**Enable Query Logging:**
```php
DB::enableQueryLog();
// Execute queries
$queries = DB::getQueryLog();
DB::disableQueryLog();
```

### 5.2 N+1 Query Detection

**Detect N+1 Problems:**
```php
// Bad: N+1 queries
$pages = Page::all();
foreach ($pages as $page) {
    $page->seo; // Executes query for each page
}

// Good: Eager loading
$pages = Page::with('seo')->get();
```

### 5.3 Query Profiling

**Profile Queries:**
```php
DB::enableQueryLog();
// Execute queries
$queries = DB::getQueryLog();
// Analyze query count and execution time
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Performance -name "*Database*Test.php"
   ```

### 6.2 Test Execution

1. **Run database performance tests:**
   ```bash
   php artisan test tests/Performance --filter Database
   ```

### 6.3 Functional Validation

1. **Manual Testing:**
   - Use Laravel Telescope
   - Use database query profiler
   - Analyze query logs
   - Check for N+1 problems

2. **Performance Verification:**
   - Verify query optimization
   - Check index usage
   - Document performance metrics

## 7. Success Criteria Checklist

- [ ] Query execution time tests created
- [ ] N+1 query detection tests created
- [ ] Query optimization verified
- [ ] Index usage verified
- [ ] Performance targets met
- [ ] Results documented
- [ ] All tests pass consistently

## 8. Next Steps

After completing P8.4.2:
- Proceed to P8.4.3: Test API response times
- Review performance metrics
- Address optimization opportunities

## 9. Notes

- Enable query logging for testing
- Test with realistic data volumes
- Verify eager loading is used
- Check for N+1 query problems
- Verify indexes are used
- Document query performance metrics

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
