# P8.2.2 Email Functionality Integration Test Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive integration tests for email functionality. These tests verify that emails are sent correctly, with proper content, and handle errors appropriately.

### 1.2 Scope
This implementation plan covers task P8.2.2:
- **P8.2.2**: Test email functionality
  - Test form submission email notifications
  - Test contact form emails
  - Test auto-response emails
  - Test email content and formatting
  - Test email error handling
  - Test email queuing (if implemented)

### 1.3 Success Criteria
- All email types have integration tests
- Email sending is verified
- Email content is validated
- Email recipients are correct
- Error handling is tested
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel Mail functionality
- Mail faking in tests
- Email templates
- Mail assertions

### 2.2 Dependencies
- Task P2.1.5 completed (EmailService implemented)
- Mail configuration set up
- Email templates created
- Mail classes implemented

### 2.3 Reference Documents
- Email Service: `app/Services/EmailService.php`
- Mail Classes: `app/Mail/`
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`

## 3. Existing Implementation Review

### 3.1 Current State
The following email functionality exists:
- `EmailService` - Email sending service
- `FormSubmissionNotification` - Form submission email
- `ContactFormMail` - Contact form email
- Email sending integrated with forms

### 3.2 What Needs to Be Done
- Create comprehensive email integration tests
- Test all email types
- Verify email content
- Test email recipients
- Test error handling
- Test email queuing (if applicable)

## 4. Task P8.2.2: Test Email Functionality

### 4.1 Overview
Create comprehensive integration tests for email functionality by:
1. Testing form submission notifications
2. Testing contact form emails
3. Testing auto-response emails
4. Verifying email content
5. Testing error scenarios

### 4.2 Test Structure

Email integration tests should follow this structure:
```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\Form;
use App\Models\FormSubmission;
use App\Mail\FormSubmissionNotification;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Mail;

class EmailFunctionalityTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();
        Mail::fake();
    }

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create Form Submission Email Tests

**File: `tests/Feature/FormSubmissionEmailTest.php`** (new)

**Test Coverage Required:**
- Form submission notification sent
- Email sent to correct recipient
- Email contains form data
- Email contains submission data
- Email formatting correct

**Key Test Cases:**
```php
public function test_form_submission_sends_notification_email(): void
{
    Mail::fake();
    
    $form = Form::factory()->create([
        'email_to' => 'admin@example.com',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ]),
    ]);

    $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    Mail::assertSent(FormSubmissionNotification::class, function ($mail) use ($form) {
        return $mail->hasTo('admin@example.com') &&
               $mail->form->id === $form->id;
    });
}

public function test_form_submission_email_contains_form_data(): void
{
    Mail::fake();
    
    $form = Form::factory()->create([
        'email_to' => 'admin@example.com',
        'name' => 'Test Form',
    ]);

    $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
        $mail->build();
        return str_contains($mail->render(), 'Test User') &&
               str_contains($mail->render(), 'test@example.com');
    });
}

public function test_form_submission_email_handles_missing_recipient(): void
{
    Mail::fake();
    
    $form = Form::factory()->create([
        'email_to' => null, // No recipient configured
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    // Form should still submit successfully
    $response->assertStatus(200);
    
    // But no email should be sent
    Mail::assertNothingSent();
}
```

#### Step 2: Create Contact Form Email Tests

**File: `tests/Feature/ContactFormEmailTest.php`** (new)

**Test Coverage Required:**
- Contact form email sent
- Email sent to correct recipient
- Email contains contact form data
- Email subject correct

**Key Test Cases:**
```php
public function test_contact_form_sends_email(): void
{
    Mail::fake();
    
    $this->postJson('/contact', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'subject' => 'Test Subject',
        'message' => 'Test message with enough characters.',
    ]);

    Mail::assertSent(ContactFormMail::class, function ($mail) {
        return $mail->hasTo(config('mail.contact_to'));
    });
}

public function test_contact_form_email_contains_all_data(): void
{
    Mail::fake();
    
    $data = [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'phone' => '+1234567890',
        'subject' => 'Test Subject',
        'message' => 'Test message with enough characters.',
    ];

    $this->postJson('/contact', $data);

    Mail::assertSent(ContactFormMail::class, function ($mail) use ($data) {
        $mail->build();
        $content = $mail->render();
        
        return str_contains($content, $data['name']) &&
               str_contains($content, $data['email']) &&
               str_contains($content, $data['subject']) &&
               str_contains($content, $data['message']);
    });
}

public function test_contact_form_email_has_correct_subject(): void
{
    Mail::fake();
    
    $subject = 'Test Subject';
    
    $this->postJson('/contact', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'subject' => $subject,
        'message' => 'Test message with enough characters.',
    ]);

    Mail::assertSent(ContactFormMail::class, function ($mail) use ($subject) {
        return $mail->subject === $subject || 
               str_contains($mail->subject, $subject);
    });
}
```

#### Step 3: Create Auto-Response Email Tests

**File: `tests/Feature/AutoResponseEmailTest.php`** (new)

**Test Coverage Required:**
- Auto-response email sent to submitter
- Auto-response email content correct
- Auto-response email sent for appropriate forms

**Key Test Cases:**
```php
public function test_ebook_form_sends_auto_response(): void
{
    Mail::fake();
    
    $this->postJson('/ebook-signup', [
        'name' => 'Jane Doe',
        'email' => 'jane@example.com',
    ]);

    Mail::assertSent(EbookAutoResponse::class, function ($mail) {
        return $mail->hasTo('jane@example.com');
    });
}

public function test_auto_response_email_contains_correct_content(): void
{
    Mail::fake();
    
    $email = 'jane@example.com';
    
    $this->postJson('/ebook-signup', [
        'name' => 'Jane Doe',
        'email' => $email,
    ]);

    Mail::assertSent(EbookAutoResponse::class, function ($mail) use ($email) {
        $mail->build();
        $content = $mail->render();
        
        return $mail->hasTo($email) &&
               str_contains($content, 'Thank you') &&
               str_contains($content, 'ebook');
    });
}
```

#### Step 4: Create Email Error Handling Tests

**File: `tests/Feature/EmailErrorHandlingTest.php`** (new)

**Test Coverage Required:**
- Email sending failure handled gracefully
- Form submission succeeds even if email fails
- Error logged when email fails
- Invalid email addresses handled

**Key Test Cases:**
```php
public function test_form_submission_succeeds_when_email_fails(): void
{
    Mail::fake();
    Mail::shouldReceive('send')->andThrow(new \Exception('Email sending failed'));
    
    $form = Form::factory()->create([
        'email_to' => 'admin@example.com',
    ]);

    // Form submission should still succeed
    $response = $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    $response->assertStatus(200);
    
    // Submission should be stored
    $this->assertDatabaseHas('form_submissions', [
        'form_id' => $form->id,
    ]);
}

public function test_email_error_is_logged(): void
{
    Log::spy();
    Mail::fake();
    Mail::shouldReceive('send')->andThrow(new \Exception('Email sending failed'));
    
    $form = Form::factory()->create([
        'email_to' => 'admin@example.com',
    ]);

    $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    Log::shouldHaveReceived('error')->with(
        'Failed to send form submission email',
        \Mockery::on(function ($context) {
            return isset($context['form_id']) && isset($context['error']);
        })
    );
}
```

#### Step 5: Create Email Content Validation Tests

**File: `tests/Feature/EmailContentValidationTest.php`** (new)

**Test Coverage Required:**
- Email content is properly escaped
- HTML emails render correctly
- Plain text emails formatted correctly
- Email attachments (if applicable)

**Key Test Cases:**
```php
public function test_email_content_escapes_html(): void
{
    Mail::fake();
    
    $this->postJson('/contact', [
        'name' => '<script>alert("xss")</script>John',
        'email' => 'john@example.com',
        'subject' => 'Test',
        'message' => 'Test message with enough characters.',
    ]);

    Mail::assertSent(ContactFormMail::class, function ($mail) {
        $mail->build();
        $content = $mail->render();
        
        // Script tags should be escaped or removed
        return !str_contains($content, '<script>');
    });
}

public function test_email_content_includes_all_required_fields(): void
{
    Mail::fake();
    
    $form = Form::factory()->create([
        'email_to' => 'admin@example.com',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
            ['name' => 'phone', 'type' => 'tel', 'required' => false, 'label' => 'Phone'],
        ]),
    ]);

    $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
        'phone' => '+1234567890',
    ]);

    Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
        $mail->build();
        $content = $mail->render();
        
        return str_contains($content, 'Name') &&
               str_contains($content, 'Email') &&
               str_contains($content, 'Phone') &&
               str_contains($content, 'Test User') &&
               str_contains($content, 'test@example.com');
    });
}
```

## 5. Test Implementation Guidelines

### 5.1 Mail Faking

**Fake Mail in Tests:**
```php
use Illuminate\Support\Facades\Mail;

protected function setUp(): void
{
    parent::setUp();
    Mail::fake();
}

// Assert mail was sent
Mail::assertSent(FormSubmissionNotification::class);

// Assert mail was sent to specific address
Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
    return $mail->hasTo('admin@example.com');
});

// Assert mail was not sent
Mail::assertNothingSent();

// Assert specific number of mails sent
Mail::assertSentCount(2);
```

### 5.2 Email Content Testing

**Test Email Content:**
```php
Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
    $mail->build(); // Build the email
    $content = $mail->render(); // Get rendered content
    
    return str_contains($content, 'expected text');
});
```

### 5.3 Email Error Testing

**Test Email Errors:**
```php
Mail::shouldReceive('send')->andThrow(new \Exception('Email failed'));

// Form submission should still succeed
$response = $this->postJson('/contact', $data);
$response->assertStatus(200);
```

### 5.4 Multiple Recipients

**Test Multiple Recipients:**
```php
Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
    return $mail->hasTo('admin@example.com') &&
           $mail->hasCc('cc@example.com') &&
           $mail->hasBcc('bcc@example.com');
});
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Feature -name "*Email*Test.php"
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - Mail is faked in setUp()

### 6.2 Test Execution

1. **Run all email tests:**
   ```bash
   php artisan test tests/Feature --filter Email
   ```

2. **Run specific email test:**
   ```bash
   php artisan test tests/Feature/FormSubmissionEmailTest.php
   ```

### 6.3 Functional Validation

1. **Manual Testing:**
   - Submit form manually
   - Check email received
   - Verify email content
   - Test with invalid email addresses

2. **Integration Verification:**
   - Verify email service integration
   - Verify email templates render correctly
   - Verify error handling works

## 7. Success Criteria Checklist

- [ ] Form submission email tests created
- [ ] Contact form email tests created
- [ ] Auto-response email tests created
- [ ] Email error handling tests created
- [ ] Email content validation tests created
- [ ] All email types tested
- [ ] Email recipients verified
- [ ] Email content verified
- [ ] Error handling tested
- [ ] All tests pass consistently

## 8. Next Steps

After completing P8.2.2:
- Proceed to P8.2.3: Test chatbot API
- Review test coverage
- Address any gaps
- Refactor tests if needed

## 9. Notes

- Always fake Mail in setUp() to avoid sending real emails
- Use Mail assertions to verify emails are sent
- Test email content by rendering the mail
- Test error scenarios to ensure graceful handling
- Verify email recipients are correct
- Test both HTML and plain text email formats
- Consider testing email queuing if implemented

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
