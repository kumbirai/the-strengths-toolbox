# P8.2.1 Form Submissions Integration Test Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive integration tests for form submission workflows. These tests verify that forms work end-to-end from user submission through database storage and email notifications.

### 1.2 Scope
This implementation plan covers task P8.2.1:
- **P8.2.1**: Test form submissions
  - Test contact form submission workflow
  - Test eBook signup form workflow
  - Test dynamic form submissions
  - Test form validation integration
  - Test email notification integration
  - Test database storage integration
  - Test rate limiting integration

### 1.3 Success Criteria
- All form types have integration tests
- Form submission workflow is tested end-to-end
- Validation errors are properly handled
- Email notifications are sent correctly
- Submissions are stored in database
- Rate limiting works correctly
- CSRF protection is verified
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel feature testing
- HTTP testing methods
- Mail faking
- Database testing
- Form validation
- CSRF protection

### 2.2 Dependencies
- Task P4.6.4 completed (Form functionality implemented)
- Task P2.1.5 completed (EmailService implemented)
- Existing feature tests as reference
- Form routes configured
- Email configuration set up

### 2.3 Reference Documents
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`
- Existing tests: `tests/Feature/ContactFormTest.php`, `tests/Feature/EbookFormTest.php`
- Form Service: `app/Services/FormService.php`
- Email Service: `app/Services/EmailService.php`

## 3. Existing Implementation Review

### 3.1 Current State
The following form tests exist:
- `ContactFormTest.php` - Basic contact form tests
- `EbookFormTest.php` - Basic eBook form tests

**Existing Test Coverage:**
- Contact form submission
- eBook form submission
- Basic validation
- Rate limiting
- Input sanitization

### 3.2 What Needs to Be Done
- Enhance existing form tests
- Add tests for dynamic forms
- Test form submission with file uploads
- Test form submission error handling
- Test email notification delivery
- Test database persistence
- Test form rendering
- Test form field validation
- Test inactive form handling

## 4. Task P8.2.1: Test Form Submissions

### 4.1 Overview
Create comprehensive integration tests for form submissions by:
1. Enhancing existing form tests
2. Adding tests for dynamic forms
3. Testing complete submission workflows
4. Verifying email notifications
5. Verifying database storage
6. Testing error scenarios

### 4.2 Test Structure

Each form integration test should follow this structure:
```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use App\Models\Form;
use App\Models\FormSubmission;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\RateLimiter;

class FormSubmissionTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();
        Mail::fake();
        RateLimiter::clear('form-submission:127.0.0.1');
    }

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Enhance Contact Form Tests

**File: `tests/Feature/ContactFormTest.php`** (enhance existing)

**Additional Test Coverage:**
- Verify email notification sent
- Verify submission stored in database
- Test with authenticated user
- Test form submission with attachments
- Test form submission error recovery
- Test inactive form handling

**Key Test Cases to Add:**
```php
public function test_contact_form_sends_email_notification(): void
{
    Mail::fake();
    
    $this->postJson('/contact', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'subject' => 'Test',
        'message' => 'Test message with enough characters.',
    ]);

    Mail::assertSent(ContactFormNotification::class, function ($mail) {
        return $mail->hasTo(config('mail.contact_to'));
    });
}

public function test_contact_form_stores_submission_in_database(): void
{
    $this->postJson('/contact', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'subject' => 'Test',
        'message' => 'Test message with enough characters.',
    ]);

    $this->assertDatabaseHas('form_submissions', [
        'form_id' => function ($formId) {
            $form = Form::find($formId);
            return $form && $form->slug === 'contact';
        },
    ]);
}

public function test_contact_form_includes_user_id_when_authenticated(): void
{
    $user = User::factory()->create();
    $this->actingAs($user);

    $this->postJson('/contact', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'subject' => 'Test',
        'message' => 'Test message with enough characters.',
    ]);

    $this->assertDatabaseHas('form_submissions', [
        'user_id' => $user->id,
    ]);
}
```

#### Step 2: Enhance eBook Form Tests

**File: `tests/Feature/EbookFormTest.php`** (enhance existing)

**Additional Test Coverage:**
- Verify email notification sent
- Verify submission stored in database
- Test auto-response email
- Test duplicate email handling

**Key Test Cases to Add:**
```php
public function test_ebook_form_sends_notification_and_auto_response(): void
{
    Mail::fake();
    
    $this->postJson('/ebook-signup', [
        'name' => 'Jane Doe',
        'email' => 'jane@example.com',
    ]);

    Mail::assertSent(EbookSignupNotification::class);
    Mail::assertSent(EbookAutoResponse::class, function ($mail) {
        return $mail->hasTo('jane@example.com');
    });
}

public function test_ebook_form_stores_submission(): void
{
    $this->postJson('/ebook-signup', [
        'name' => 'Jane Doe',
        'email' => 'jane@example.com',
    ]);

    $this->assertDatabaseHas('form_submissions', [
        'form_id' => function ($formId) {
            $form = Form::find($formId);
            return $form && $form->slug === 'ebook-signup';
        },
    ]);
}
```

#### Step 3: Create Dynamic Form Submission Tests

**File: `tests/Feature/DynamicFormSubmissionTest.php`** (new)

**Test Coverage Required:**
- Submit dynamic form with various field types
- Test form field validation
- Test required field validation
- Test email field validation
- Test file upload field
- Test select/radio/checkbox fields
- Test form submission with all field types

**Key Test Cases:**
```php
public function test_dynamic_form_submission_with_text_fields(): void
{
    $form = Form::factory()->create([
        'slug' => 'test-form',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ]),
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'email' => 'test@example.com',
    ]);

    $response->assertStatus(200);
    $this->assertDatabaseHas('form_submissions', ['form_id' => $form->id]);
}

public function test_dynamic_form_validates_required_fields(): void
{
    $form = Form::factory()->create([
        'slug' => 'test-form',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ]),
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'email' => 'test@example.com',
    ]);

    $response->assertStatus(422);
    $response->assertJsonValidationErrors(['name']);
}

public function test_dynamic_form_validates_email_format(): void
{
    $form = Form::factory()->create([
        'slug' => 'test-form',
        'fields' => json_encode([
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ]),
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'email' => 'invalid-email',
    ]);

    $response->assertStatus(422);
    $response->assertJsonValidationErrors(['email']);
}

public function test_dynamic_form_handles_file_upload(): void
{
    Storage::fake('public');
    
    $form = Form::factory()->create([
        'slug' => 'test-form',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'file', 'type' => 'file', 'required' => false, 'label' => 'File'],
        ]),
    ]);

    $file = UploadedFile::fake()->create('document.pdf', 100);

    $response = $this->post(route('forms.submit', $form->slug), [
        'name' => 'Test User',
        'file' => $file,
    ]);

    $response->assertStatus(200);
    Storage::disk('public')->assertExists('form-submissions/' . $file->hashName());
}

public function test_dynamic_form_handles_select_field(): void
{
    $form = Form::factory()->create([
        'slug' => 'test-form',
        'fields' => json_encode([
            ['name' => 'option', 'type' => 'select', 'required' => true, 'label' => 'Option', 
             'options' => ['option1', 'option2', 'option3']],
        ]),
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'option' => 'option1',
    ]);

    $response->assertStatus(200);
    $submission = FormSubmission::where('form_id', $form->id)->first();
    $data = json_decode($submission->data, true);
    $this->assertEquals('option1', $data['option']);
}
```

#### Step 4: Create Form Error Handling Tests

**File: `tests/Feature/FormErrorHandlingTest.php`** (new)

**Test Coverage Required:**
- Test inactive form handling
- Test form not found error
- Test database error handling
- Test email sending failure handling
- Test validation error display
- Test CSRF token validation

**Key Test Cases:**
```php
public function test_inactive_form_cannot_be_submitted(): void
{
    $form = Form::factory()->create([
        'slug' => 'inactive-form',
        'is_active' => false,
    ]);

    $response = $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Test',
    ]);

    $response->assertStatus(403);
}

public function test_form_not_found_returns_404(): void
{
    $response = $this->postJson(route('forms.submit', 'non-existent-form'), [
        'name' => 'Test',
    ]);

    $response->assertStatus(404);
}

public function test_csrf_token_required_for_form_submission(): void
{
    $form = Form::factory()->create(['slug' => 'test-form']);

    $response = $this->post(route('forms.submit', $form->slug), [
        'name' => 'Test',
    ]);

    $response->assertStatus(419); // CSRF token mismatch
}
```

#### Step 5: Create Form Submission Workflow Tests

**File: `tests/Feature/FormSubmissionWorkflowTest.php`** (new)

**Test Coverage Required:**
- Complete submission workflow
- Verify all steps in workflow
- Test workflow with errors
- Test workflow recovery

**Key Test Cases:**
```php
public function test_complete_form_submission_workflow(): void
{
    Mail::fake();
    
    $form = Form::factory()->create([
        'slug' => 'workflow-test',
        'email_to' => 'admin@example.com',
        'fields' => json_encode([
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ]),
    ]);

    // Step 1: Submit form
    $response = $this->postJson(route('forms.submit', $form->slug), [
        'name' => 'Workflow Test',
        'email' => 'workflow@example.com',
    ]);

    // Step 2: Verify response
    $response->assertStatus(200);
    $response->assertJson(['success' => true]);

    // Step 3: Verify database storage
    $this->assertDatabaseHas('form_submissions', [
        'form_id' => $form->id,
    ]);

    // Step 4: Verify email sent
    Mail::assertSent(FormSubmissionNotification::class, function ($mail) {
        return $mail->hasTo('admin@example.com');
    });

    // Step 5: Verify submission data
    $submission = FormSubmission::where('form_id', $form->id)->first();
    $data = json_decode($submission->data, true);
    $this->assertEquals('Workflow Test', $data['name']);
    $this->assertEquals('workflow@example.com', $data['email']);
}
```

## 5. Test Implementation Guidelines

### 5.1 Mail Faking

**Fake Mail in Tests:**
```php
use Illuminate\Support\Facades\Mail;

protected function setUp(): void
{
    parent::setUp();
    Mail::fake();
}

// Assert mail was sent
Mail::assertSent(ContactFormNotification::class);

// Assert mail was sent to specific address
Mail::assertSent(ContactFormNotification::class, function ($mail) {
    return $mail->hasTo('admin@example.com');
});
```

### 5.2 Database Assertions

**Verify Database Storage:**
```php
// Assert submission exists
$this->assertDatabaseHas('form_submissions', [
    'form_id' => $form->id,
]);

// Assert submission data
$submission = FormSubmission::where('form_id', $form->id)->first();
$data = json_decode($submission->data, true);
$this->assertEquals('expected_value', $data['field_name']);
```

### 5.3 File Upload Testing

**Test File Uploads:**
```php
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;

Storage::fake('public');

$file = UploadedFile::fake()->create('document.pdf', 100);

$response = $this->post(route('forms.submit', $form->slug), [
    'file' => $file,
]);

Storage::disk('public')->assertExists('form-submissions/' . $file->hashName());
```

### 5.4 Rate Limiting Testing

**Test Rate Limiting:**
```php
use Illuminate\Support\Facades\RateLimiter;

protected function setUp(): void
{
    parent::setUp();
    RateLimiter::clear('form-submission:127.0.0.1');
}

// Submit form multiple times
for ($i = 0; $i < 5; $i++) {
    $this->postJson('/contact', $data);
}

// 6th submission should be rate limited
$response = $this->postJson('/contact', $data);
$response->assertStatus(429);
```

### 5.5 CSRF Testing

**Test CSRF Protection:**
```php
// Without CSRF token (should fail)
$response = $this->post('/contact', $data);
$response->assertStatus(419);

// With CSRF token (should succeed)
$response = $this->post('/contact', array_merge($data, [
    '_token' => csrf_token(),
]));
$response->assertStatus(200);
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Feature -name "*Form*Test.php"
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - Mail is faked in setUp()
   - Rate limiter is cleared in setUp()

### 6.2 Test Execution

1. **Run all form tests:**
   ```bash
   php artisan test tests/Feature --filter Form
   ```

2. **Run specific form test:**
   ```bash
   php artisan test tests/Feature/ContactFormTest.php
   ```

3. **Run with coverage:**
   ```bash
   php artisan test --coverage tests/Feature --filter Form
   ```

### 6.3 Functional Validation

1. **Manual Testing:**
   - Submit contact form manually
   - Verify email received
   - Verify submission in database
   - Test validation errors
   - Test rate limiting

2. **Integration Verification:**
   - Verify form service integration
   - Verify email service integration
   - Verify database persistence
   - Verify error handling

## 7. Success Criteria Checklist

- [ ] Contact form tests enhanced
- [ ] eBook form tests enhanced
- [ ] Dynamic form tests created
- [ ] Error handling tests created
- [ ] Workflow tests created
- [ ] Email notifications tested
- [ ] Database storage tested
- [ ] Rate limiting tested
- [ ] CSRF protection tested
- [ ] File uploads tested
- [ ] All field types tested
- [ ] All tests pass consistently

## 8. Next Steps

After completing P8.2.1:
- Proceed to P8.2.2: Test email functionality
- Review test coverage
- Address any gaps
- Refactor tests if needed

## 9. Notes

- Always fake Mail in setUp() to avoid sending real emails
- Clear rate limiter in setUp() for consistent testing
- Use RefreshDatabase to ensure test isolation
- Test both success and error scenarios
- Verify database state after operations
- Test with both authenticated and unauthenticated users
- Test all form field types individually and in combination

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
