# P8.2.3 Chatbot API Integration Test Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive integration tests for the chatbot API. These tests verify that the API endpoints work correctly, handle requests properly, and integrate with OpenAI and database storage.

### 1.2 Scope
This implementation plan covers task P8.2.3:
- **P8.2.3**: Test chatbot API
  - Test sendMessage endpoint
  - Test conversation retrieval endpoints
  - Test rate limiting
  - Test error handling
  - Test OpenAI integration
  - Test database storage
  - Test authentication (if applicable)

### 1.3 Success Criteria
- All API endpoints have integration tests
- Request validation tested
- Response formatting verified
- Rate limiting tested
- Error handling tested
- OpenAI integration mocked and tested
- Database storage verified
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel API testing
- HTTP testing methods
- Mocking external services
- JSON API responses
- Rate limiting testing

### 2.2 Dependencies
- Task P7.3.4 completed (Chatbot API implemented)
- Task P7.1.2 completed (OpenAI integration)
- Task P7.1.4 completed (Rate limiting)
- API routes configured
- OpenAI API key configured (for testing)

### 2.3 Reference Documents
- Chatbot API Architecture: `documentation/01-architecture/06-ai-chatbot-architecture.md`
- ChatbotController: `app/Http/Controllers/Api/ChatbotController.php`
- API Routes: `routes/api.php`
- ChatbotService: `app/Services/ChatbotService.php`

## 3. Existing Implementation Review

### 3.1 Current State
The following chatbot API endpoints exist:
- `POST /api/chatbot/message` - Send message
- `GET /api/chatbot/conversation/{id}` - Get conversation
- `GET /api/chatbot/conversation/{id}/messages` - Get paginated messages
- `GET /api/chatbot/conversation/{id}/stats` - Get conversation stats
- `GET /api/chatbot/conversation/{id}/summary` - Get conversation summary
- `GET /api/chatbot/conversations/search` - Search conversations

### 3.2 What Needs to Be Done
- Create comprehensive API integration tests
- Test all endpoints
- Mock OpenAI API calls
- Test rate limiting
- Test error scenarios
- Verify database storage
- Test request validation

## 4. Task P8.2.3: Test Chatbot API

### 4.1 Overview
Create comprehensive integration tests for the chatbot API by:
1. Testing sendMessage endpoint
2. Testing conversation retrieval endpoints
3. Mocking OpenAI API
4. Testing rate limiting
5. Testing error handling
6. Verifying database operations

### 4.2 Test Structure

Chatbot API integration tests should follow this structure:
```php
<?php

namespace Tests\Feature\Api;

use Tests\TestCase;
use App\Models\ChatbotConversation;
use App\Models\ChatbotMessage;
use App\Services\OpenAIClient;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Http;
use Mockery;

class ChatbotApiTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();
        // Mock OpenAI API
    }

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create SendMessage Endpoint Tests

**File: `tests/Feature/Api/ChatbotSendMessageTest.php`** (new)

**Test Coverage Required:**
- Send message with valid data
- Create new conversation
- Continue existing conversation
- Request validation
- OpenAI API integration
- Response formatting
- Database storage
- Rate limiting

**Key Test Cases:**
```php
public function test_send_message_creates_new_conversation(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Hello',
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(200);
    $response->assertJsonStructure([
        'success',
        'message',
        'conversation_id',
    ]);

    $this->assertDatabaseHas('chatbot_conversations', [
        'session_id' => 'test-session-123',
    ]);
}

public function test_send_message_continues_existing_conversation(): void
{
    $conversation = ChatbotConversation::factory()->create([
        'session_id' => 'test-session-123',
    ]);

    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Hello again',
        'conversation_id' => $conversation->id,
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(200);
    $response->assertJson([
        'conversation_id' => $conversation->id,
    ]);
}

public function test_send_message_validates_required_fields(): void
{
    $response = $this->postJson('/api/chatbot/message', []);

    $response->assertStatus(422);
    $response->assertJsonValidationErrors(['message']);
}

public function test_send_message_validates_message_length(): void
{
    $response = $this->postJson('/api/chatbot/message', [
        'message' => str_repeat('a', 1001), // Exceeds max length
    ]);

    $response->assertStatus(422);
    $response->assertJsonValidationErrors(['message']);
}

public function test_send_message_stores_messages_in_database(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    $this->postJson('/api/chatbot/message', [
        'message' => 'Test message',
        'session_id' => 'test-session-123',
    ]);

    $this->assertDatabaseHas('chatbot_messages', [
        'role' => 'user',
        'message' => 'Test message',
    ]);

    $this->assertDatabaseHas('chatbot_messages', [
        'role' => 'assistant',
        'message' => 'Test response',
    ]);
}

public function test_send_message_handles_openai_api_error(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'error' => [
                'message' => 'API error',
                'type' => 'invalid_request_error'
            ]
        ], 400)
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test message',
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(500);
    $response->assertJson([
        'success' => false,
    ]);
}

public function test_send_message_respects_rate_limiting(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    // Send multiple requests
    for ($i = 0; $i < 10; $i++) {
        $this->postJson('/api/chatbot/message', [
            'message' => 'Test message ' . $i,
            'session_id' => 'test-session-123',
        ]);
    }

    // 11th request should be rate limited
    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test message 11',
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(429);
}
```

#### Step 2: Create Conversation Retrieval Tests

**File: `tests/Feature/Api/ChatbotConversationTest.php`** (new)

**Test Coverage Required:**
- Get conversation by ID
- Get conversation with messages
- Get paginated messages
- Get conversation stats
- Get conversation summary
- Search conversations
- Handle non-existent conversation

**Key Test Cases:**
```php
public function test_get_conversation_returns_conversation(): void
{
    $conversation = ChatbotConversation::factory()->create();
    $messages = ChatbotMessage::factory()->count(5)->create([
        'conversation_id' => $conversation->id,
    ]);

    $response = $this->getJson("/api/chatbot/conversation/{$conversation->id}");

    $response->assertStatus(200);
    $response->assertJsonStructure([
        'success',
        'conversation' => [
            'id',
            'session_id',
            'messages',
        ],
    ]);
    $response->assertJsonCount(5, 'conversation.messages');
}

public function test_get_conversation_returns_404_for_non_existent(): void
{
    $response = $this->getJson('/api/chatbot/conversation/99999');

    $response->assertStatus(404);
}

public function test_get_conversation_messages_returns_paginated_messages(): void
{
    $conversation = ChatbotConversation::factory()->create();
    ChatbotMessage::factory()->count(25)->create([
        'conversation_id' => $conversation->id,
    ]);

    $response = $this->getJson("/api/chatbot/conversation/{$conversation->id}/messages?page=1&per_page=10");

    $response->assertStatus(200);
    $response->assertJsonStructure([
        'success',
        'messages' => [
            'data',
            'current_page',
            'per_page',
            'total',
        ],
    ]);
    $response->assertJsonCount(10, 'messages.data');
}

public function test_get_conversation_stats_returns_statistics(): void
{
    $conversation = ChatbotConversation::factory()->create();
    ChatbotMessage::factory()->count(10)->create([
        'conversation_id' => $conversation->id,
        'role' => 'user',
    ]);
    ChatbotMessage::factory()->count(10)->create([
        'conversation_id' => $conversation->id,
        'role' => 'assistant',
        'tokens_used' => 100,
    ]);

    $response = $this->getJson("/api/chatbot/conversation/{$conversation->id}/stats");

    $response->assertStatus(200);
    $response->assertJsonStructure([
        'success',
        'stats' => [
            'total_messages',
            'user_messages',
            'assistant_messages',
            'total_tokens',
        ],
    ]);
    $response->assertJson([
        'stats' => [
            'total_messages' => 20,
            'user_messages' => 10,
            'assistant_messages' => 10,
        ],
    ]);
}

public function test_search_conversations_returns_matching_conversations(): void
{
    $conversation1 = ChatbotConversation::factory()->create();
    ChatbotMessage::factory()->create([
        'conversation_id' => $conversation1->id,
        'message' => 'Hello world',
    ]);

    $conversation2 = ChatbotConversation::factory()->create();
    ChatbotMessage::factory()->create([
        'conversation_id' => $conversation2->id,
        'message' => 'Goodbye',
    ]);

    $response = $this->getJson('/api/chatbot/conversations/search?query=Hello');

    $response->assertStatus(200);
    $response->assertJsonStructure([
        'success',
        'conversations',
    ]);
    $response->assertJsonCount(1, 'conversations');
}
```

#### Step 3: Create Rate Limiting Tests

**File: `tests/Feature/Api/ChatbotRateLimitTest.php`** (new)

**Test Coverage Required:**
- Per-session rate limiting
- Per-conversation rate limiting
- Per-user rate limiting (if authenticated)
- Per-IP rate limiting
- Rate limit headers in response

**Key Test Cases:**
```php
public function test_rate_limit_headers_included_in_response(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test',
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(200);
    $response->assertHeader('X-RateLimit-Limit');
    $response->assertHeader('X-RateLimit-Remaining');
}

public function test_rate_limiting_blocks_excessive_requests(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([
            'choices' => [[
                'message' => [
                    'role' => 'assistant',
                    'content' => 'Test response'
                ]
            ]]
        ], 200)
    ]);

    $sessionId = 'test-session-' . uniqid();

    // Send requests up to limit
    for ($i = 0; $i < 10; $i++) {
        $this->postJson('/api/chatbot/message', [
            'message' => "Test $i",
            'session_id' => $sessionId,
        ]);
    }

    // Next request should be rate limited
    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test 11',
        'session_id' => $sessionId,
    ]);

    $response->assertStatus(429);
    $response->assertJson([
        'success' => false,
        'message' => 'Rate limit exceeded',
    ]);
}
```

#### Step 4: Create Error Handling Tests

**File: `tests/Feature/Api/ChatbotErrorHandlingTest.php`** (new)

**Test Coverage Required:**
- Invalid request data
- OpenAI API errors
- Database errors
- Network errors
- Timeout errors
- Error response formatting

**Key Test Cases:**
```php
public function test_send_message_handles_network_error(): void
{
    Http::fake([
        'api.openai.com/*' => Http::response([], 500)
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test message',
        'session_id' => 'test-session-123',
    ]);

    $response->assertStatus(500);
    $response->assertJson([
        'success' => false,
    ]);
}

public function test_send_message_handles_timeout(): void
{
    Http::fake([
        'api.openai.com/*' => function () {
            sleep(2); // Simulate timeout
            return Http::response([], 200);
        }
    ]);

    $response = $this->postJson('/api/chatbot/message', [
        'message' => 'Test message',
        'session_id' => 'test-session-123',
    ]);

    // Should handle timeout gracefully
    $response->assertStatus(500);
}
```

## 5. Test Implementation Guidelines

### 5.1 Mocking OpenAI API

**Mock HTTP Requests:**
```php
use Illuminate\Support\Facades\Http;

Http::fake([
    'api.openai.com/*' => Http::response([
        'choices' => [[
            'message' => [
                'role' => 'assistant',
                'content' => 'Test response'
            ]
        ]]
    ], 200)
]);
```

### 5.2 Testing JSON APIs

**Test JSON Responses:**
```php
$response = $this->postJson('/api/chatbot/message', $data);

$response->assertStatus(200);
$response->assertJson([
    'success' => true,
]);
$response->assertJsonStructure([
    'success',
    'message',
    'conversation_id',
]);
```

### 5.3 Testing Rate Limiting

**Test Rate Limits:**
```php
// Clear rate limiter
RateLimiter::clear('chatbot:session:test-session');

// Send requests
for ($i = 0; $i < 10; $i++) {
    $this->postJson('/api/chatbot/message', $data);
}

// Next should be rate limited
$response = $this->postJson('/api/chatbot/message', $data);
$response->assertStatus(429);
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Feature/Api -name "*Chatbot*Test.php"
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - OpenAI API is mocked

### 6.2 Test Execution

1. **Run all chatbot API tests:**
   ```bash
   php artisan test tests/Feature/Api --filter Chatbot
   ```

2. **Run specific test:**
   ```bash
   php artisan test tests/Feature/Api/ChatbotSendMessageTest.php
   ```

### 6.3 Functional Validation

1. **Manual Testing:**
   - Test API endpoints with Postman/curl
   - Verify responses
   - Test rate limiting
   - Test error scenarios

2. **Integration Verification:**
   - Verify OpenAI integration
   - Verify database storage
   - Verify rate limiting works

## 7. Success Criteria Checklist

- [ ] SendMessage endpoint tests created
- [ ] Conversation retrieval tests created
- [ ] Rate limiting tests created
- [ ] Error handling tests created
- [ ] All API endpoints tested
- [ ] OpenAI API mocked correctly
- [ ] Database storage verified
- [ ] Request validation tested
- [ ] Response formatting verified
- [ ] All tests pass consistently

## 8. Next Steps

After completing P8.2.3:
- Proceed to P8.2.4: Test admin panel workflows
- Review test coverage
- Address any gaps
- Refactor tests if needed

## 9. Notes

- Always mock OpenAI API to avoid real API calls and costs
- Use Http::fake() for consistent API responses
- Test both success and error scenarios
- Verify database state after API calls
- Test rate limiting with different session IDs
- Use RefreshDatabase for test isolation
- Test authentication if API requires it

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
