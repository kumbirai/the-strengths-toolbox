# P8.1.2 Repository Tests Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive unit tests for all repository classes. Repository tests ensure that data access layer logic is correctly implemented and database operations work as expected.

### 1.2 Scope
This implementation plan covers task P8.1.2:
- **P8.1.2**: Write tests for repositories
  - Test all repository methods
  - Test database queries
  - Test scopes and filters
  - Test relationships
  - Achieve 70%+ code coverage for repositories

### 1.3 Success Criteria
- All repository classes have comprehensive test coverage
- Database operations are tested
- Query scopes are tested
- Relationships are tested
- Test coverage meets 70% target
- All tests pass consistently
- Tests use database transactions for isolation

## 2. Prerequisites

### 2.1 Required Knowledge
- PHPUnit testing framework
- Laravel database testing (RefreshDatabase)
- Eloquent ORM
- Repository pattern
- Database queries and scopes

### 2.2 Dependencies
- Task P2.2.3 completed (Repository layer implemented)
- Task P8.1.1 completed (Service tests - for reference)
- Database migrations completed
- Model factories available

### 2.3 Reference Documents
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`
- BaseRepository: `app/Repositories/BaseRepository.php`
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`

## 3. Existing Implementation Review

### 3.1 Current State
The following repositories exist:
- `BaseRepository` - Base repository with common methods
- `PageRepository` - Page data access
- `BlogPostRepository` - Blog post data access
- `FormRepository` - Form data access

### 3.2 Repositories Requiring Tests

**Core Repositories:**
- `PageRepository` - Page CRUD, scopes, filters
- `BlogPostRepository` - Blog post CRUD, category/tag relationships
- `FormRepository` - Form CRUD, active forms

**Base Repository:**
- `BaseRepository` - Common methods (findById, create, update, delete)

### 3.3 What Needs to Be Done
- Create test files for all repositories
- Test CRUD operations
- Test query scopes
- Test filters
- Test relationships
- Test pagination
- Test soft deletes
- Ensure proper database isolation

## 4. Task P8.1.2: Write Tests for Repositories

### 4.1 Overview
Create comprehensive unit tests for all repository classes by:
1. Creating test files for each repository
2. Testing all CRUD operations
3. Testing query scopes
4. Testing filters and search
5. Testing relationships
6. Ensuring database isolation

### 4.2 Test Structure

Each repository test should follow this structure:
```php
<?php

namespace Tests\Unit\Repositories;

use Tests\TestCase;
use App\Repositories\{RepositoryName};
use App\Models\{ModelName};
use Illuminate\Foundation\Testing\RefreshDatabase;

class {RepositoryName}Test extends TestCase
{
    use RefreshDatabase;

    protected {RepositoryName} $repository;

    protected function setUp(): void
    {
        parent::setUp();
        $this->repository = new {RepositoryName}();
    }

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create BaseRepository Tests

**File: `tests/Unit/Repositories/BaseRepositoryTest.php`**

**Test Coverage Required:**
- `findById()` - Finds model by ID, returns null when not found
- `create()` - Creates new model
- `update()` - Updates existing model
- `delete()` - Deletes model (hard delete)
- `all()` - Returns all models
- `count()` - Returns count

**Key Test Cases:**
```php
public function test_find_by_id_returns_model_when_exists(): void
public function test_find_by_id_returns_null_when_not_exists(): void
public function test_create_creates_new_model(): void
public function test_update_updates_existing_model(): void
public function test_delete_removes_model(): void
public function test_all_returns_all_models(): void
public function test_count_returns_correct_count(): void
```

**Note:** BaseRepository is abstract, so test through concrete implementations.

#### Step 2: Create PageRepository Tests

**File: `tests/Unit/Repositories/PageRepositoryTest.php`**

**Test Coverage Required:**
- `findById()` - Finds page by ID
- `findBySlug()` - Finds page by slug
- `findPublishedBySlug()` - Finds only published pages
- `getAllPublished()` - Returns all published pages
- `getPaginated()` - Returns paginated pages with filters
- `create()` - Creates new page
- `update()` - Updates page
- `delete()` - Soft deletes page
- Scopes: `scopePublished()`, `scopeUnpublished()`

**Key Test Cases:**
```php
public function test_find_by_slug_returns_page(): void
public function test_find_published_by_slug_returns_only_published(): void
public function test_find_published_by_slug_returns_null_for_unpublished(): void
public function test_get_all_published_returns_only_published(): void
public function test_get_paginated_returns_paginated_results(): void
public function test_get_paginated_filters_by_status(): void
public function test_create_creates_new_page(): void
public function test_update_updates_page(): void
public function test_delete_soft_deletes_page(): void
public function test_scope_published_filters_published_pages(): void
```

**Test Data Setup:**
```php
$publishedPage = Page::factory()->create(['is_published' => true]);
$unpublishedPage = Page::factory()->create(['is_published' => false]);
```

#### Step 3: Create BlogPostRepository Tests

**File: `tests/Unit/Repositories/BlogPostRepositoryTest.php`**

**Test Coverage Required:**
- `findById()` - Finds post by ID
- `findBySlug()` - Finds post by slug
- `findPublishedBySlug()` - Finds only published posts
- `getAllPublished()` - Returns all published posts
- `getPaginated()` - Returns paginated posts with filters
- `getByCategory()` - Returns posts by category
- `getByTag()` - Returns posts by tag
- `getRecent()` - Returns recent posts
- `create()` - Creates new post
- `update()` - Updates post
- `delete()` - Soft deletes post
- Relationships: categories, tags

**Key Test Cases:**
```php
public function test_find_by_slug_returns_post(): void
public function test_find_published_by_slug_returns_only_published(): void
public function test_get_all_published_returns_only_published(): void
public function test_get_paginated_filters_by_category(): void
public function test_get_paginated_filters_by_tag(): void
public function test_get_by_category_returns_posts_in_category(): void
public function test_get_by_tag_returns_posts_with_tag(): void
public function test_get_recent_returns_recent_posts(): void
public function test_create_creates_new_post(): void
public function test_update_updates_post(): void
public function test_delete_soft_deletes_post(): void
```

**Test Data Setup:**
```php
$category = Category::factory()->create();
$tag = Tag::factory()->create();
$post = BlogPost::factory()->create();
$post->categories()->attach($category);
$post->tags()->attach($tag);
```

#### Step 4: Create FormRepository Tests

**File: `tests/Unit/Repositories/FormRepositoryTest.php`**

**Test Coverage Required:**
- `findById()` - Finds form by ID
- `findBySlug()` - Finds form by slug
- `getAllActive()` - Returns only active forms
- `getPaginated()` - Returns paginated forms
- `create()` - Creates new form
- `update()` - Updates form
- `delete()` - Deletes form
- Scopes: `scopeActive()`

**Key Test Cases:**
```php
public function test_find_by_slug_returns_form(): void
public function test_get_all_active_returns_only_active_forms(): void
public function test_get_all_active_excludes_inactive_forms(): void
public function test_get_paginated_returns_paginated_results(): void
public function test_create_creates_new_form(): void
public function test_update_updates_form(): void
public function test_delete_removes_form(): void
public function test_scope_active_filters_active_forms(): void
```

**Test Data Setup:**
```php
$activeForm = Form::factory()->create(['is_active' => true]);
$inactiveForm = Form::factory()->create(['is_active' => false]);
```

## 5. Test Implementation Guidelines

### 5.1 Database Testing

**Use RefreshDatabase Trait:**
```php
use Illuminate\Foundation\Testing\RefreshDatabase;

class PageRepositoryTest extends TestCase
{
    use RefreshDatabase;
    // Tests automatically use database transactions
}
```

**Database Assertions:**
```php
// Assert record exists
$this->assertDatabaseHas('pages', [
    'slug' => 'test-page',
    'is_published' => true,
]);

// Assert record missing
$this->assertDatabaseMissing('pages', [
    'slug' => 'deleted-page',
]);

// Assert record count
$this->assertDatabaseCount('pages', 5);
```

### 5.2 Factory Usage

**Creating Test Data:**
```php
// Single model
$page = Page::factory()->create();

// Multiple models
$pages = Page::factory()->count(10)->create();

// With specific attributes
$page = Page::factory()->create([
    'slug' => 'test-page',
    'is_published' => true,
]);

// With relationships
$post = BlogPost::factory()->create();
$category = Category::factory()->create();
$post->categories()->attach($category);
```

### 5.3 Testing Scopes

**Testing Query Scopes:**
```php
public function test_scope_published_filters_published_pages(): void
{
    $published = Page::factory()->create(['is_published' => true]);
    $unpublished = Page::factory()->create(['is_published' => false]);

    $results = Page::published()->get();

    $this->assertCount(1, $results);
    $this->assertTrue($results->contains($published));
    $this->assertFalse($results->contains($unpublished));
}
```

### 5.4 Testing Relationships

**Testing Relationships:**
```php
public function test_post_has_categories(): void
{
    $post = BlogPost::factory()->create();
    $category = Category::factory()->create();
    $post->categories()->attach($category);

    $this->assertTrue($post->categories->contains($category));
    $this->assertEquals(1, $post->categories->count());
}
```

### 5.5 Testing Pagination

**Testing Pagination:**
```php
public function test_get_paginated_returns_paginated_results(): void
{
    Page::factory()->count(25)->create();

    $result = $this->repository->getPaginated(10);

    $this->assertInstanceOf(LengthAwarePaginator::class, $result);
    $this->assertEquals(25, $result->total());
    $this->assertEquals(10, $result->perPage());
    $this->assertEquals(3, $result->lastPage());
}
```

### 5.6 Testing Filters

**Testing Filter Methods:**
```php
public function test_get_paginated_filters_by_status(): void
{
    Page::factory()->count(5)->create(['is_published' => true]);
    Page::factory()->count(3)->create(['is_published' => false]);

    $result = $this->repository->getPaginated(10, ['is_published' => true]);

    $this->assertEquals(5, $result->total());
    $result->each(function ($page) {
        $this->assertTrue($page->is_published);
    });
}
```

### 5.7 Testing Soft Deletes

**Testing Soft Deletes:**
```php
public function test_delete_soft_deletes_page(): void
{
    $page = Page::factory()->create();

    $this->repository->delete($page->id);

    $this->assertSoftDeleted('pages', ['id' => $page->id]);
    $this->assertNull(Page::find($page->id));
    $this->assertNotNull(Page::withTrashed()->find($page->id));
}
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Unit/Repositories -name "*Test.php" | wc -l
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - All tests have `setUp()` method
   - Repository is instantiated in `setUp()`

### 6.2 Test Execution

1. **Run all repository tests:**
   ```bash
   php artisan test tests/Unit/Repositories
   ```

2. **Run specific repository test:**
   ```bash
   php artisan test tests/Unit/Repositories/PageRepositoryTest.php
   ```

3. **Run with coverage:**
   ```bash
   php artisan test --coverage --min=70 tests/Unit/Repositories
   ```

### 6.3 Coverage Validation

1. **Check coverage report:**
   - Repositories should have 70%+ coverage
   - All CRUD methods should be tested
   - All scopes should be tested
   - All filter methods should be tested

2. **Review coverage gaps:**
   - Identify untested methods
   - Add tests for missing coverage
   - Focus on complex query methods

## 7. Success Criteria Checklist

- [ ] All repository classes have test files
- [ ] All CRUD methods are tested
- [ ] All query scopes are tested
- [ ] All filter methods are tested
- [ ] Relationships are tested
- [ ] Pagination is tested
- [ ] Soft deletes are tested
- [ ] Test coverage meets 70% target
- [ ] All tests pass consistently
- [ ] Tests use RefreshDatabase for isolation
- [ ] Tests use factories for test data
- [ ] Database assertions are used appropriately

## 8. Next Steps

After completing P8.1.2:
- Proceed to P8.1.3: Write tests for models
- Review test coverage reports
- Address any coverage gaps
- Refactor tests if needed

## 9. Notes

- Always use `RefreshDatabase` trait for database tests
- Use factories to create test data consistently
- Test both positive and negative scenarios
- Use database assertions to verify data state
- Test scopes independently and in combination
- Test relationships with proper data setup
- Keep tests focused on repository layer only
- Don't test Eloquent ORM functionality (test your repository methods)

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
