# P8.2.4 Admin Panel Workflows Integration Test Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive integration tests for admin panel workflows. These tests verify that CRUD operations, authentication, and admin functionality work correctly end-to-end.

### 1.2 Scope
This implementation plan covers task P8.2.4:
- **P8.2.4**: Test admin panel workflows
  - Test authentication workflows
  - Test page management CRUD
  - Test blog post management CRUD
  - Test form management workflows
  - Test media management workflows
  - Test category and tag management
  - Test testimonial management
  - Test SEO management
  - Test chatbot configuration

### 1.3 Success Criteria
- All admin workflows have integration tests
- CRUD operations tested end-to-end
- Authentication tested
- Authorization tested
- File uploads tested
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel feature testing
- Authentication testing
- File upload testing
- Admin panel structure
- CRUD operations

### 2.2 Dependencies
- Task P3.6.4 completed (Admin panel implemented)
- Task P1.4.5 completed (Authentication implemented)
- Admin routes configured
- Admin middleware configured

### 2.3 Reference Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`
- Admin Routes: `routes/admin.php`
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`

## 3. Existing Implementation Review

### 3.1 Current State
The following admin controllers exist:
- `AdminDashboardController` - Dashboard
- `AdminPageController` - Page management
- `AdminBlogController` - Blog post management
- `AdminCategoryController` - Category management
- `AdminTagController` - Tag management
- `AdminFormController` - Form management
- `AdminMediaController` - Media management
- `AdminTestimonialController` - Testimonial management
- `AdminSEOController` - SEO management
- `AdminChatbotController` - Chatbot configuration

### 3.2 What Needs to Be Done
- Create comprehensive admin workflow tests
- Test authentication and authorization
- Test all CRUD operations
- Test file uploads
- Test form submissions viewing
- Test search and filtering

## 4. Task P8.2.4: Test Admin Panel Workflows

### 4.1 Overview
Create comprehensive integration tests for admin panel workflows by:
1. Testing authentication
2. Testing page management CRUD
3. Testing blog management CRUD
4. Testing form management
5. Testing media management
6. Testing other admin features

### 4.2 Test Structure

Admin workflow tests should follow this structure:
```php
<?php

namespace Tests\Feature\Admin;

use Tests\TestCase;
use App\Models\User;
use App\Models\Page;
use Illuminate\Foundation\Testing\RefreshDatabase;

class AdminWorkflowTest extends TestCase
{
    use RefreshDatabase;

    protected User $admin;

    protected function setUp(): void
    {
        parent::setUp();
        $this->admin = User::factory()->admin()->create();
    }

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create Authentication Workflow Tests

**File: `tests/Feature/Admin/AdminAuthenticationTest.php`** (new)

**Test Coverage Required:**
- Admin login
- Admin logout
- Unauthorized access blocked
- Password reset
- Session management

**Key Test Cases:**
```php
public function test_admin_can_login_with_valid_credentials(): void
{
    $admin = User::factory()->create([
        'email' => 'admin@example.com',
        'password' => bcrypt('password'),
    ]);

    $response = $this->post('/admin/login', [
        'email' => 'admin@example.com',
        'password' => 'password',
    ]);

    $response->assertRedirect('/admin');
    $this->assertAuthenticatedAs($admin);
}

public function test_admin_cannot_login_with_invalid_credentials(): void
{
    $response = $this->post('/admin/login', [
        'email' => 'admin@example.com',
        'password' => 'wrong-password',
    ]);

    $response->assertSessionHasErrors();
    $this->assertGuest();
}

public function test_unauthorized_user_cannot_access_admin_panel(): void
{
    $response = $this->get('/admin');

    $response->assertRedirect('/admin/login');
}

public function test_admin_can_logout(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $response = $this->post('/admin/logout');

    $response->assertRedirect('/admin/login');
    $this->assertGuest();
}
```

#### Step 2: Create Page Management Workflow Tests

**File: `tests/Feature/Admin/PageManagementTest.php`** (new)

**Test Coverage Required:**
- List pages
- Create page
- Edit page
- Update page
- Delete page
- Publish/unpublish page
- Preview page

**Key Test Cases:**
```php
public function test_admin_can_view_pages_list(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    Page::factory()->count(5)->create();

    $response = $this->get('/admin/pages');

    $response->assertStatus(200);
    $response->assertViewIs('admin.pages.index');
}

public function test_admin_can_create_page(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $response = $this->post('/admin/pages', [
        'title' => 'Test Page',
        'slug' => 'test-page',
        'content' => 'Test content',
        'is_published' => true,
    ]);

    $response->assertRedirect('/admin/pages');
    $this->assertDatabaseHas('pages', [
        'title' => 'Test Page',
        'slug' => 'test-page',
    ]);
}

public function test_admin_can_update_page(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $page = Page::factory()->create();

    $response = $this->put("/admin/pages/{$page->id}", [
        'title' => 'Updated Title',
        'slug' => $page->slug,
        'content' => $page->content,
    ]);

    $response->assertRedirect('/admin/pages');
    $this->assertDatabaseHas('pages', [
        'id' => $page->id,
        'title' => 'Updated Title',
    ]);
}

public function test_admin_can_delete_page(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $page = Page::factory()->create();

    $response = $this->delete("/admin/pages/{$page->id}");

    $response->assertRedirect('/admin/pages');
    $this->assertSoftDeleted('pages', ['id' => $page->id]);
}

public function test_admin_can_publish_page(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $page = Page::factory()->create(['is_published' => false]);

    $response = $this->put("/admin/pages/{$page->id}", [
        'title' => $page->title,
        'slug' => $page->slug,
        'content' => $page->content,
        'is_published' => true,
    ]);

    $this->assertDatabaseHas('pages', [
        'id' => $page->id,
        'is_published' => true,
    ]);
}
```

#### Step 3: Create Blog Management Workflow Tests

**File: `tests/Feature/Admin/BlogManagementTest.php`** (new)

**Test Coverage Required:**
- List blog posts
- Create blog post
- Edit blog post
- Update blog post
- Delete blog post
- Attach categories and tags
- Publish/unpublish post

**Key Test Cases:**
```php
public function test_admin_can_create_blog_post(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $category = Category::factory()->create();
    $tag = Tag::factory()->create();

    $response = $this->post('/admin/blog', [
        'title' => 'Test Post',
        'slug' => 'test-post',
        'content' => 'Test content',
        'excerpt' => 'Test excerpt',
        'category_ids' => [$category->id],
        'tag_ids' => [$tag->id],
        'is_published' => true,
    ]);

    $response->assertRedirect('/admin/blog');
    $post = BlogPost::where('slug', 'test-post')->first();
    $this->assertTrue($post->categories->contains($category));
    $this->assertTrue($post->tags->contains($tag));
}

public function test_admin_can_update_blog_post(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $post = BlogPost::factory()->create();

    $response = $this->put("/admin/blog/{$post->id}", [
        'title' => 'Updated Post',
        'slug' => $post->slug,
        'content' => $post->content,
    ]);

    $response->assertRedirect('/admin/blog');
    $this->assertDatabaseHas('blog_posts', [
        'id' => $post->id,
        'title' => 'Updated Post',
    ]);
}
```

#### Step 4: Create Form Management Workflow Tests

**File: `tests/Feature/Admin/FormManagementTest.php`** (new)

**Test Coverage Required:**
- List forms
- Create form
- View form submissions
- Export form submissions
- View individual submission

**Key Test Cases:**
```php
public function test_admin_can_create_form(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $response = $this->post('/admin/forms', [
        'name' => 'Test Form',
        'slug' => 'test-form',
        'fields' => [
            ['name' => 'name', 'type' => 'text', 'required' => true, 'label' => 'Name'],
            ['name' => 'email', 'type' => 'email', 'required' => true, 'label' => 'Email'],
        ],
        'email_to' => 'admin@example.com',
        'is_active' => true,
    ]);

    $response->assertRedirect('/admin/forms');
    $this->assertDatabaseHas('forms', [
        'slug' => 'test-form',
    ]);
}

public function test_admin_can_view_form_submissions(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $form = Form::factory()->create();
    FormSubmission::factory()->count(5)->create(['form_id' => $form->id]);

    $response = $this->get("/admin/forms/{$form->id}/submissions");

    $response->assertStatus(200);
    $response->assertViewIs('admin.forms.submissions');
}
```

#### Step 5: Create Media Management Workflow Tests

**File: `tests/Feature/Admin/MediaManagementTest.php`** (new)

**Test Coverage Required:**
- Upload media file
- View media list
- Update media metadata
- Delete media file
- File validation

**Key Test Cases:**
```php
public function test_admin_can_upload_media_file(): void
{
    Storage::fake('public');
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $file = UploadedFile::fake()->image('test.jpg', 800, 600);

    $response = $this->post('/admin/media/upload', [
        'file' => $file,
        'alt_text' => 'Test image',
    ]);

    $response->assertStatus(200);
    Storage::disk('public')->assertExists('media/' . $file->hashName());
    $this->assertDatabaseHas('media', [
        'filename' => $file->hashName(),
    ]);
}

public function test_admin_can_delete_media_file(): void
{
    Storage::fake('public');
    $admin = User::factory()->create();
    $this->actingAs($admin);
    $media = Media::factory()->create();

    $response = $this->delete("/admin/media/{$media->id}");

    $response->assertRedirect('/admin/media');
    $this->assertDatabaseMissing('media', ['id' => $media->id]);
}
```

#### Step 6: Create Category and Tag Management Tests

**File: `tests/Feature/Admin/CategoryTagManagementTest.php`** (new)

**Test Coverage Required:**
- Create category
- Update category
- Delete category
- Create tag
- Update tag
- Delete tag

**Key Test Cases:**
```php
public function test_admin_can_create_category(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $response = $this->post('/admin/blog/categories', [
        'name' => 'Test Category',
        'slug' => 'test-category',
        'description' => 'Test description',
    ]);

    $response->assertRedirect('/admin/blog/categories');
    $this->assertDatabaseHas('categories', [
        'name' => 'Test Category',
    ]);
}

public function test_admin_can_create_tag(): void
{
    $admin = User::factory()->create();
    $this->actingAs($admin);

    $response = $this->post('/admin/blog/tags', [
        'name' => 'Test Tag',
        'slug' => 'test-tag',
    ]);

    $response->assertRedirect('/admin/blog/tags');
    $this->assertDatabaseHas('tags', [
        'name' => 'Test Tag',
    ]);
}
```

## 5. Test Implementation Guidelines

### 5.1 Authentication Testing

**Act as Admin:**
```php
$admin = User::factory()->create();
$this->actingAs($admin);

// Now requests are authenticated
$response = $this->get('/admin/pages');
```

### 5.2 File Upload Testing

**Test File Uploads:**
```php
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;

Storage::fake('public');

$file = UploadedFile::fake()->image('test.jpg', 800, 600);

$response = $this->post('/admin/media/upload', [
    'file' => $file,
]);
```

### 5.3 CRUD Testing Pattern

**Test CRUD Operations:**
```php
// Create
$response = $this->post('/admin/resource', $data);
$response->assertRedirect();
$this->assertDatabaseHas('table', $data);

// Read
$response = $this->get('/admin/resource');
$response->assertStatus(200);

// Update
$response = $this->put("/admin/resource/{$id}", $updatedData);
$response->assertRedirect();
$this->assertDatabaseHas('table', $updatedData);

// Delete
$response = $this->delete("/admin/resource/{$id}");
$response->assertRedirect();
$this->assertSoftDeleted('table', ['id' => $id]);
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Feature/Admin -name "*Test.php"
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - Admin user created in setUp()

### 6.2 Test Execution

1. **Run all admin tests:**
   ```bash
   php artisan test tests/Feature/Admin
   ```

2. **Run specific test:**
   ```bash
   php artisan test tests/Feature/Admin/PageManagementTest.php
   ```

### 6.3 Functional Validation

1. **Manual Testing:**
   - Test admin workflows manually
   - Verify CRUD operations
   - Test file uploads
   - Test authentication

2. **Integration Verification:**
   - Verify service layer integration
   - Verify database operations
   - Verify file storage

## 7. Success Criteria Checklist

- [ ] Authentication tests created
- [ ] Page management tests created
- [ ] Blog management tests created
- [ ] Form management tests created
- [ ] Media management tests created
- [ ] Category/tag management tests created
- [ ] All CRUD operations tested
- [ ] File uploads tested
- [ ] Authorization tested
- [ ] All tests pass consistently

## 8. Next Steps

After completing P8.2.4:
- Review all integration test coverage
- Address any gaps
- Proceed to P8.3: System Testing
- Refactor tests if needed

## 9. Notes

- Always authenticate as admin user in setUp()
- Use RefreshDatabase for test isolation
- Test both success and error scenarios
- Verify database state after operations
- Test file uploads with Storage::fake()
- Test authorization by attempting unauthorized access
- Test validation errors appropriately

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
