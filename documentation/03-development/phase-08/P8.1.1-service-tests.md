# P8.1.1 Service Tests Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive unit tests for all service classes in the application. Service tests ensure that business logic is correctly implemented and isolated from external dependencies.

### 1.2 Scope
This implementation plan covers task P8.1.1:
- **P8.1.1**: Write tests for services
  - Test all service methods
  - Mock external dependencies
  - Test error handling
  - Test validation logic
  - Achieve 70%+ code coverage for services

### 1.3 Success Criteria
- All service classes have comprehensive test coverage
- Tests are isolated and independent
- External dependencies are properly mocked
- Error scenarios are tested
- Test coverage meets 70% target for critical services
- All tests pass consistently
- Tests follow Laravel testing best practices

## 2. Prerequisites

### 2.1 Required Knowledge
- PHPUnit testing framework
- Laravel testing features (RefreshDatabase, factories, assertions)
- Mocking with Mockery
- Service layer architecture
- Dependency injection patterns

### 2.2 Dependencies
- Task P2.1.6 completed (BaseService created)
- All services implemented (Phases 1-7)
- PHPUnit configured (`phpunit.xml`)
- Test factories created for models
- Database migrations completed

### 2.3 Reference Documents
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`
- Testing Guide: `documentation/03-development/phase-04/TESTING_GUIDE.md`
- Existing test example: `tests/Unit/Services/FormServiceTest.php`
- BaseService: `app/Services/BaseService.php`

## 3. Existing Implementation Review

### 3.1 Current State
The following test infrastructure exists:
- `tests/TestCase.php` - Base test case
- `tests/Unit/Services/FormServiceTest.php` - Example service test
- PHPUnit configuration in `phpunit.xml`
- Model factories available for test data
- `RefreshDatabase` trait for database isolation

### 3.2 Services Requiring Tests

**Core Services:**
- `PageService` - Page management
- `BlogPostService` - Blog post management
- `FormService` - Form management (partially tested)
- `MediaService` - Media file handling
- `SEOService` - SEO management
- `EmailService` - Email sending
- `SearchService` - Search functionality
- `SchemaService` - Schema markup
- `CacheService` - Caching operations

**Chatbot Services:**
- `ChatbotService` - Main chatbot service
- `OpenAIClient` - OpenAI API integration
- `ChatbotContextService` - Context management
- `ChatbotRateLimitService` - Rate limiting
- `ChatbotErrorHandler` - Error handling

**Support Services:**
- `FormRenderService` - Form rendering
- `BaseService` - Base service class

### 3.3 What Needs to Be Done
- Create test files for all services
- Write test methods for each service method
- Mock external dependencies (repositories, external APIs, email)
- Test success scenarios
- Test error scenarios
- Test validation logic
- Test edge cases
- Ensure proper test isolation

## 4. Task P8.1.1: Write Tests for Services

### 4.1 Overview
Create comprehensive unit tests for all service classes by:
1. Creating test files for each service
2. Setting up proper mocking for dependencies
3. Writing tests for all public methods
4. Testing both success and failure scenarios
5. Ensuring test isolation

### 4.2 Test Structure

Each service test should follow this structure:
```php
<?php

namespace Tests\Unit\Services;

use Tests\TestCase;
use App\Services\{ServiceName};
use Illuminate\Foundation\Testing\RefreshDatabase;
use Mockery;

class {ServiceName}Test extends TestCase
{
    use RefreshDatabase;

    protected {ServiceName} $service;
    // Mocked dependencies

    protected function setUp(): void
    {
        parent::setUp();
        // Set up service with mocked dependencies
    }

    // Test methods

    protected function tearDown(): void
    {
        Mockery::close();
        parent::tearDown();
    }
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create PageService Tests

**File: `tests/Unit/Services/PageServiceTest.php`**

**Test Coverage Required:**
- `getBySlug()` - Returns page when exists, null when not, only published pages, caching
- `getById()` - Returns page by ID, caching
- `getAllPublished()` - Returns all published pages, caching
- `getPaginated()` - Pagination works, filters work
- `create()` - Creates page, generates slug, validates data
- `update()` - Updates page, validates data
- `delete()` - Soft deletes page
- `publish()` - Publishes page
- `unpublish()` - Unpublishes page

**Key Test Cases:**
```php
public function test_get_by_slug_returns_published_page(): void
public function test_get_by_slug_returns_null_for_unpublished(): void
public function test_get_by_slug_caches_result(): void
public function test_create_generates_slug_automatically(): void
public function test_create_validates_required_fields(): void
public function test_update_updates_page(): void
public function test_delete_soft_deletes_page(): void
```

**Dependencies to Mock:**
- `PageRepository` - Mock all repository methods

#### Step 2: Create BlogPostService Tests

**File: `tests/Unit/Services/BlogPostServiceTest.php`**

**Test Coverage Required:**
- `getBySlug()` - Returns published post, null for unpublished
- `getById()` - Returns post by ID
- `getAllPublished()` - Returns all published posts
- `getPaginated()` - Pagination, filtering by category/tag
- `create()` - Creates post, generates slug, sets published_at
- `update()` - Updates post
- `delete()` - Soft deletes post
- `publish()` - Publishes post
- `attachCategories()` - Attaches categories
- `attachTags()` - Attaches tags

**Key Test Cases:**
```php
public function test_create_generates_slug_from_title(): void
public function test_create_sets_published_at_when_published(): void
public function test_create_does_not_set_published_at_when_unpublished(): void
public function test_attach_categories_attaches_categories(): void
public function test_get_paginated_filters_by_category(): void
```

**Dependencies to Mock:**
- `BlogPostRepository` - Mock repository methods

#### Step 3: Create FormService Tests (Enhance Existing)

**File: `tests/Unit/Services/FormServiceTest.php`** (already exists, enhance)

**Additional Test Coverage Needed:**
- `getAllActive()` - Returns only active forms
- `update()` - Updates form
- `delete()` - Deletes form
- `validateSubmission()` - Validates form data
- `generateUniqueSlug()` - Generates unique slugs

**Key Test Cases to Add:**
```php
public function test_get_all_active_returns_only_active_forms(): void
public function test_update_updates_form(): void
public function test_validate_submission_validates_required_fields(): void
public function test_validate_submission_validates_email_format(): void
public function test_generate_unique_slug_creates_unique_slug(): void
```

**Dependencies to Mock:**
- `FormRepository` - Already mocked
- `EmailService` - Already mocked

#### Step 4: Create MediaService Tests

**File: `tests/Unit/Services/MediaServiceTest.php`**

**Test Coverage Required:**
- `upload()` - Uploads file, creates media record, processes images
- `delete()` - Deletes file and record
- `getById()` - Returns media by ID
- `getByPath()` - Returns media by path
- `processImage()` - Optimizes images, creates thumbnails
- `generateFilename()` - Generates unique filenames

**Key Test Cases:**
```php
public function test_upload_creates_media_record(): void
public function test_upload_processes_image(): void
public function test_upload_generates_unique_filename(): void
public function test_delete_removes_file_and_record(): void
public function test_process_image_creates_thumbnails(): void
```

**Dependencies to Mock:**
- `Storage` facade - Mock file operations
- `ImageManager` - Mock image processing

#### Step 5: Create SEOService Tests

**File: `tests/Unit/Services/SEOServiceTest.php`**

**Test Coverage Required:**
- `getMetaTags()` - Generates meta tags
- `getOpenGraphTags()` - Generates Open Graph tags
- `getTwitterCardTags()` - Generates Twitter Card tags
- `getCanonicalUrl()` - Generates canonical URL
- `updatePageSEO()` - Updates page SEO data

**Key Test Cases:**
```php
public function test_get_meta_tags_returns_correct_structure(): void
public function test_get_meta_tags_uses_page_seo_when_available(): void
public function test_get_open_graph_tags_includes_all_required_fields(): void
public function test_get_canonical_url_uses_page_slug(): void
public function test_update_page_seo_creates_or_updates_seo(): void
```

**Dependencies to Mock:**
- `Page` model - Mock page data
- `PageSEO` model - Mock SEO data

#### Step 6: Create EmailService Tests

**File: `tests/Unit/Services/EmailServiceTest.php`**

**Test Coverage Required:**
- `sendFormSubmissionNotification()` - Sends notification email
- `sendContactFormNotification()` - Sends contact form email
- `sendAutoResponse()` - Sends auto-response email
- `sendTestEmail()` - Sends test email

**Key Test Cases:**
```php
public function test_send_form_submission_notification_sends_email(): void
public function test_send_form_submission_notification_includes_form_data(): void
public function test_send_auto_response_sends_to_submitter(): void
public function test_send_test_email_uses_test_address(): void
```

**Dependencies to Mock:**
- `Mail` facade - Mock email sending

#### Step 7: Create SearchService Tests

**File: `tests/Unit/Services/SearchServiceTest.php`**

**Test Coverage Required:**
- `search()` - Searches across content types
- `searchPages()` - Searches pages
- `searchBlogPosts()` - Searches blog posts
- `highlightResults()` - Highlights search terms

**Key Test Cases:**
```php
public function test_search_returns_results_from_all_content_types(): void
public function test_search_pages_returns_matching_pages(): void
public function test_search_blog_posts_returns_matching_posts(): void
public function test_highlight_results_highlights_search_terms(): void
```

**Dependencies to Mock:**
- `PageRepository` - Mock page search
- `BlogPostRepository` - Mock blog post search

#### Step 8: Create SchemaService Tests

**File: `tests/Unit/Services/SchemaServiceTest.php`**

**Test Coverage Required:**
- `generateOrganizationSchema()` - Generates organization schema
- `generateArticleSchema()` - Generates article schema
- `generateBreadcrumbSchema()` - Generates breadcrumb schema
- `generateWebSiteSchema()` - Generates website schema

**Key Test Cases:**
```php
public function test_generate_organization_schema_returns_valid_json_ld(): void
public function test_generate_article_schema_includes_required_fields(): void
public function test_generate_breadcrumb_schema_creates_correct_structure(): void
```

**Dependencies to Mock:**
- None (pure service)

#### Step 9: Create CacheService Tests

**File: `tests/Unit/Services/CacheServiceTest.php`**

**Test Coverage Required:**
- `remember()` - Caches and retrieves data
- `forget()` - Removes cache
- `flush()` - Clears all cache
- `get()` - Retrieves from cache
- `put()` - Stores in cache

**Key Test Cases:**
```php
public function test_remember_caches_data(): void
public function test_remember_returns_cached_data_on_subsequent_calls(): void
public function test_forget_removes_cache(): void
public function test_flush_clears_all_cache(): void
```

**Dependencies to Mock:**
- `Cache` facade - Mock cache operations

#### Step 10: Create ChatbotService Tests

**File: `tests/Unit/Services/ChatbotServiceTest.php`**

**Test Coverage Required:**
- `createConversation()` - Creates conversation
- `getOrCreateConversation()` - Gets or creates conversation
- `sendMessage()` - Sends message, gets response
- `getConversation()` - Retrieves conversation
- `getConversationHistory()` - Gets message history
- `getConversationStats()` - Gets statistics
- `archiveOldConversations()` - Archives old conversations

**Key Test Cases:**
```php
public function test_create_conversation_creates_new_conversation(): void
public function test_get_or_create_conversation_returns_existing(): void
public function test_get_or_create_conversation_creates_new_when_not_exists(): void
public function test_send_message_saves_user_message(): void
public function test_send_message_calls_openai_client(): void
public function test_get_conversation_returns_with_messages(): void
```

**Dependencies to Mock:**
- `OpenAIClient` - Mock OpenAI API calls
- `ChatbotContextService` - Mock context building
- `ChatbotRateLimitService` - Mock rate limiting
- `ChatbotErrorHandler` - Mock error handling

#### Step 11: Create OpenAIClient Tests

**File: `tests/Unit/Services/OpenAIClientTest.php`**

**Test Coverage Required:**
- `chatCompletion()` - Makes API call, returns response
- `buildMessagesArray()` - Builds messages array
- `isConfigured()` - Checks configuration
- Error handling for API failures

**Key Test Cases:**
```php
public function test_chat_completion_returns_response(): void
public function test_chat_completion_handles_api_errors(): void
public function test_build_messages_array_formats_correctly(): void
public function test_is_configured_returns_true_when_configured(): void
public function test_is_configured_returns_false_when_not_configured(): void
```

**Dependencies to Mock:**
- `GuzzleHttp\Client` - Mock HTTP client
- `Config` facade - Mock configuration

#### Step 12: Create ChatbotContextService Tests

**File: `tests/Unit/Services/ChatbotContextServiceTest.php`**

**Test Coverage Required:**
- `buildContext()` - Builds conversation context
- `optimizeForTokens()` - Optimizes context for token limits
- `truncateMessages()` - Truncates old messages
- `getSystemPrompt()` - Gets system prompt
- `replacePlaceholders()` - Replaces placeholders

**Key Test Cases:**
```php
public function test_build_context_includes_recent_messages(): void
public function test_optimize_for_tokens_truncates_when_needed(): void
public function test_truncate_messages_removes_old_messages(): void
public function test_get_system_prompt_returns_default_when_no_custom(): void
public function test_replace_placeholders_replaces_all_placeholders(): void
```

**Dependencies to Mock:**
- `ChatbotPrompt` model - Mock prompt data
- `ChatbotConversation` model - Mock conversation data

#### Step 13: Create ChatbotRateLimitService Tests

**File: `tests/Unit/Services/ChatbotRateLimitServiceTest.php`**

**Test Coverage Required:**
- `checkRateLimit()` - Checks rate limits
- `getRateLimitStatus()` - Gets rate limit status
- `resetRateLimit()` - Resets rate limit
- Per-session, per-conversation, per-user, per-IP limits

**Key Test Cases:**
```php
public function test_check_rate_limit_allows_within_limit(): void
public function test_check_rate_limit_blocks_over_limit(): void
public function test_get_rate_limit_status_returns_correct_info(): void
public function test_reset_rate_limit_clears_limit(): void
```

**Dependencies to Mock:**
- `Cache` facade - Mock rate limit storage

#### Step 14: Create ChatbotErrorHandler Tests

**File: `tests/Unit/Services/ChatbotErrorHandlerTest.php`**

**Test Coverage Required:**
- `handleException()` - Handles different exception types
- `getUserFriendlyMessage()` - Gets user-friendly messages
- `logError()` - Logs errors appropriately

**Key Test Cases:**
```php
public function test_handle_exception_handles_chatbot_exception(): void
public function test_handle_exception_handles_api_exception(): void
public function test_handle_exception_handles_rate_limit_exception(): void
public function test_get_user_friendly_message_returns_appropriate_message(): void
```

**Dependencies to Mock:**
- `Log` facade - Mock logging

#### Step 15: Create FormRenderService Tests

**File: `tests/Unit/Services/FormRenderServiceTest.php`**

**Test Coverage Required:**
- `render()` - Renders form HTML
- `renderField()` - Renders individual field
- `getFieldAttributes()` - Gets field attributes

**Key Test Cases:**
```php
public function test_render_generates_form_html(): void
public function test_render_field_generates_correct_input_type(): void
public function test_get_field_attributes_includes_required_when_needed(): void
```

**Dependencies to Mock:**
- `Form` model - Mock form data

## 5. Test Implementation Guidelines

### 5.1 Mocking Strategy

**Repository Mocking:**
```php
$repository = Mockery::mock(PageRepository::class);
$repository->shouldReceive('findPublishedBySlug')
    ->with('test-slug')
    ->once()
    ->andReturn($page);
```

**Facade Mocking:**
```php
Cache::shouldReceive('remember')
    ->once()
    ->andReturn($cachedData);
```

**External Service Mocking:**
```php
$openAIClient = Mockery::mock(OpenAIClient::class);
$openAIClient->shouldReceive('chatCompletion')
    ->once()
    ->andReturn($response);
```

### 5.2 Test Data Setup

**Using Factories:**
```php
$page = Page::factory()->create([
    'slug' => 'test-page',
    'is_published' => true,
]);
```

**Using Factories with States:**
```php
$post = BlogPost::factory()->unpublished()->create();
```

### 5.3 Assertions

**Common Assertions:**
```php
$this->assertNotNull($result);
$this->assertEquals($expected, $actual);
$this->assertInstanceOf(Page::class, $result);
$this->assertDatabaseHas('pages', ['slug' => 'test-page']);
$this->assertTrue($condition);
```

### 5.4 Error Testing

**Testing Exceptions:**
```php
$this->expectException(\InvalidArgumentException::class);
$this->expectExceptionMessage('Missing required fields');
$service->create([]);
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Unit/Services -name "*Test.php" | wc -l
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - All tests have `setUp()` and `tearDown()` methods
   - Mockery is properly closed in `tearDown()`

### 6.2 Test Execution

1. **Run all service tests:**
   ```bash
   php artisan test tests/Unit/Services
   ```

2. **Run specific service test:**
   ```bash
   php artisan test tests/Unit/Services/PageServiceTest.php
   ```

3. **Run with coverage:**
   ```bash
   php artisan test --coverage --min=70 tests/Unit/Services
   ```

### 6.3 Coverage Validation

1. **Check coverage report:**
   - Services should have 70%+ coverage
   - Critical methods should have 100% coverage
   - All public methods should be tested

2. **Review coverage gaps:**
   - Identify untested methods
   - Add tests for missing coverage
   - Focus on critical business logic

## 7. Success Criteria Checklist

- [ ] All service classes have test files
- [ ] All public methods have test coverage
- [ ] External dependencies are properly mocked
- [ ] Success scenarios are tested
- [ ] Error scenarios are tested
- [ ] Validation logic is tested
- [ ] Test coverage meets 70% target
- [ ] All tests pass consistently
- [ ] Tests are isolated and independent
- [ ] Tests follow naming conventions
- [ ] Tests use appropriate assertions
- [ ] Mockery is properly closed

## 8. Next Steps

After completing P8.1.1:
- Proceed to P8.1.2: Write tests for repositories
- Review test coverage reports
- Address any coverage gaps
- Refactor tests if needed

## 9. Notes

- Use `RefreshDatabase` trait for all tests that interact with database
- Mock external services (APIs, email) to keep tests fast and isolated
- Test both happy path and error scenarios
- Use descriptive test method names: `test_method_name_expected_behavior`
- Group related tests using docblocks
- Keep tests focused on single responsibility
- Avoid testing Laravel framework functionality (test your code)

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
