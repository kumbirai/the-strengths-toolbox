# P8.1.3 Model Tests Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for writing comprehensive unit tests for all model classes. Model tests ensure that model relationships, scopes, accessors, mutators, and business logic are correctly implemented.

### 1.2 Scope
This implementation plan covers task P8.1.3:
- **P8.1.3**: Write tests for models
  - Test model relationships
  - Test query scopes
  - Test accessors and mutators
  - Test model methods
  - Test model events
  - Achieve 70%+ code coverage for models

### 1.3 Success Criteria
- All model classes have comprehensive test coverage
- Relationships are tested
- Scopes are tested
- Accessors and mutators are tested
- Model methods are tested
- Test coverage meets 70% target
- All tests pass consistently

## 2. Prerequisites

### 2.1 Required Knowledge
- PHPUnit testing framework
- Laravel Eloquent ORM
- Model relationships (hasMany, belongsTo, etc.)
- Query scopes
- Accessors and mutators
- Model events

### 2.2 Dependencies
- Task P1.2.3 completed (Database migrations)
- Task P8.1.2 completed (Repository tests - for reference)
- All models implemented
- Model factories available

### 2.3 Reference Documents
- Testing Strategy: `documentation/02-project-management/06-testing-strategy.md`
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`

## 3. Existing Implementation Review

### 3.1 Current State
The following models exist:
- `User` - User authentication
- `Page` - Page content
- `PageSEO` - Page SEO data
- `BlogPost` - Blog posts
- `Category` - Blog categories
- `Tag` - Blog tags
- `Form` - Forms
- `FormSubmission` - Form submissions
- `Media` - Media files
- `Testimonial` - Testimonials
- `ChatbotConversation` - Chatbot conversations
- `ChatbotMessage` - Chatbot messages
- `ChatbotConfig` - Chatbot configuration
- `ChatbotPrompt` - Chatbot prompts

### 3.2 Models Requiring Tests

**Core Models:**
- `Page` - Relationships, scopes, accessors
- `PageSEO` - Relationships
- `BlogPost` - Relationships, scopes, accessors
- `Category` - Relationships
- `Tag` - Relationships
- `Form` - Relationships, scopes
- `FormSubmission` - Relationships
- `Media` - Relationships, accessors
- `Testimonial` - Relationships, scopes

**Chatbot Models:**
- `ChatbotConversation` - Relationships, scopes, accessors
- `ChatbotMessage` - Relationships, scopes, accessors
- `ChatbotConfig` - Relationships
- `ChatbotPrompt` - Relationships, methods

**User Model:**
- `User` - Relationships, authentication

### 3.3 What Needs to Be Done
- Create test files for all models
- Test relationships (hasMany, belongsTo, belongsToMany)
- Test query scopes
- Test accessors (get*Attribute)
- Test mutators (set*Attribute)
- Test model methods
- Test model events (if any)
- Ensure proper database isolation

## 4. Task P8.1.3: Write Tests for Models

### 4.1 Overview
Create comprehensive unit tests for all model classes by:
1. Creating test files for each model
2. Testing all relationships
3. Testing query scopes
4. Testing accessors and mutators
5. Testing model methods
6. Ensuring database isolation

### 4.2 Test Structure

Each model test should follow this structure:
```php
<?php

namespace Tests\Unit\Models;

use Tests\TestCase;
use App\Models\{ModelName};
use Illuminate\Foundation\Testing\RefreshDatabase;

class {ModelName}Test extends TestCase
{
    use RefreshDatabase;

    // Test methods
}
```

### 4.3 Step-by-Step Implementation

#### Step 1: Create Page Model Tests

**File: `tests/Unit/Models/PageTest.php`**

**Test Coverage Required:**
- Relationships: `seo()` (hasOne)
- Scopes: `scopePublished()`, `scopeUnpublished()`
- Accessors: `getUrlAttribute()`, `getIsPublishedAttribute()`
- Methods: `publish()`, `unpublish()`

**Key Test Cases:**
```php
public function test_page_has_seo_relationship(): void
public function test_scope_published_returns_only_published_pages(): void
public function test_scope_unpublished_returns_only_unpublished_pages(): void
public function test_get_url_attribute_returns_correct_url(): void
public function test_publish_method_sets_published_status(): void
public function test_unpublish_method_sets_unpublished_status(): void
```

**Test Data Setup:**
```php
$page = Page::factory()->create(['slug' => 'test-page']);
$seo = PageSEO::factory()->create(['page_id' => $page->id]);
```

#### Step 2: Create PageSEO Model Tests

**File: `tests/Unit/Models/PageSEOTest.php`**

**Test Coverage Required:**
- Relationships: `page()` (belongsTo)

**Key Test Cases:**
```php
public function test_page_seo_belongs_to_page(): void
public function test_page_seo_returns_page_relationship(): void
```

#### Step 3: Create BlogPost Model Tests

**File: `tests/Unit/Models/BlogPostTest.php`**

**Test Coverage Required:**
- Relationships: `categories()` (belongsToMany), `tags()` (belongsToMany)
- Scopes: `scopePublished()`, `scopeUnpublished()`, `scopeRecent()`
- Accessors: `getUrlAttribute()`, `getExcerptAttribute()`
- Methods: `attachCategories()`, `attachTags()`

**Key Test Cases:**
```php
public function test_blog_post_has_categories_relationship(): void
public function test_blog_post_has_tags_relationship(): void
public function test_scope_published_returns_only_published_posts(): void
public function test_scope_recent_returns_recent_posts(): void
public function test_get_url_attribute_returns_correct_url(): void
public function test_get_excerpt_attribute_returns_excerpt(): void
public function test_attach_categories_attaches_categories(): void
public function test_attach_tags_attaches_tags(): void
```

**Test Data Setup:**
```php
$post = BlogPost::factory()->create();
$category = Category::factory()->create();
$tag = Tag::factory()->create();
$post->categories()->attach($category);
$post->tags()->attach($tag);
```

#### Step 4: Create Category Model Tests

**File: `tests/Unit/Models/CategoryTest.php`**

**Test Coverage Required:**
- Relationships: `blogPosts()` (belongsToMany)
- Scopes: `scopeActive()`

**Key Test Cases:**
```php
public function test_category_has_blog_posts_relationship(): void
public function test_scope_active_returns_only_active_categories(): void
```

#### Step 5: Create Tag Model Tests

**File: `tests/Unit/Models/TagTest.php`**

**Test Coverage Required:**
- Relationships: `blogPosts()` (belongsToMany)
- Scopes: `scopeActive()`

**Key Test Cases:**
```php
public function test_tag_has_blog_posts_relationship(): void
public function test_scope_active_returns_only_active_tags(): void
```

#### Step 6: Create Form Model Tests

**File: `tests/Unit/Models/FormTest.php`**

**Test Coverage Required:**
- Relationships: `submissions()` (hasMany)
- Scopes: `scopeActive()`
- Accessors: `getFieldsArrayAttribute()`
- Methods: `getFieldConfig()`

**Key Test Cases:**
```php
public function test_form_has_submissions_relationship(): void
public function test_scope_active_returns_only_active_forms(): void
public function test_get_fields_array_attribute_returns_array(): void
public function test_get_field_config_returns_field_config(): void
```

#### Step 7: Create FormSubmission Model Tests

**File: `tests/Unit/Models/FormSubmissionTest.php`**

**Test Coverage Required:**
- Relationships: `form()` (belongsTo)
- Accessors: `getDataArrayAttribute()`
- Methods: `getFieldValue()`

**Key Test Cases:**
```php
public function test_form_submission_belongs_to_form(): void
public function test_get_data_array_attribute_returns_array(): void
public function test_get_field_value_returns_field_value(): void
```

#### Step 8: Create Media Model Tests

**File: `tests/Unit/Models/MediaTest.php`**

**Test Coverage Required:**
- Relationships: `uploader()` (belongsTo - User)
- Accessors: `getUrlAttribute()`, `getThumbnailUrlAttribute()`
- Methods: `isImage()`, `getFileSizeHuman()`

**Key Test Cases:**
```php
public function test_media_belongs_to_uploader(): void
public function test_get_url_attribute_returns_correct_url(): void
public function test_get_thumbnail_url_attribute_returns_thumbnail(): void
public function test_is_image_returns_true_for_images(): void
public function test_is_image_returns_false_for_non_images(): void
public function test_get_file_size_human_returns_formatted_size(): void
```

#### Step 9: Create Testimonial Model Tests

**File: `tests/Unit/Models/TestimonialTest.php`**

**Test Coverage Required:**
- Scopes: `scopePublished()`, `scopeFeatured()`
- Accessors: `getDisplayNameAttribute()`

**Key Test Cases:**
```php
public function test_scope_published_returns_only_published_testimonials(): void
public function test_scope_featured_returns_only_featured_testimonials(): void
public function test_get_display_name_attribute_returns_formatted_name(): void
```

#### Step 10: Create ChatbotConversation Model Tests

**File: `tests/Unit/Models/ChatbotConversationTest.php`**

**Test Coverage Required:**
- Relationships: `messages()` (hasMany), `user()` (belongsTo)
- Scopes: `scopeByUser()`, `scopeBySession()`, `scopeActive()`, `scopeOld()`
- Accessors: `getTotalMessagesAttribute()`, `getTotalTokensAttribute()`, `getLastMessageAttribute()`
- Methods: `isActive()`

**Key Test Cases:**
```php
public function test_conversation_has_messages_relationship(): void
public function test_conversation_belongs_to_user(): void
public function test_scope_by_user_returns_user_conversations(): void
public function test_scope_by_session_returns_session_conversations(): void
public function test_scope_active_returns_active_conversations(): void
public function test_get_total_messages_attribute_returns_count(): void
public function test_get_total_tokens_attribute_returns_sum(): void
public function test_is_active_returns_true_for_active(): void
```

#### Step 11: Create ChatbotMessage Model Tests

**File: `tests/Unit/Models/ChatbotMessageTest.php`**

**Test Coverage Required:**
- Relationships: `conversation()` (belongsTo)
- Scopes: `scopeByRole()`, `scopeRecent()`, `scopeInDateRange()`
- Accessors: `getLengthAttribute()`
- Methods: `isUserMessage()`, `isAssistantMessage()`

**Key Test Cases:**
```php
public function test_message_belongs_to_conversation(): void
public function test_scope_by_role_filters_by_role(): void
public function test_scope_recent_returns_recent_messages(): void
public function test_get_length_attribute_returns_message_length(): void
public function test_is_user_message_returns_true_for_user(): void
public function test_is_assistant_message_returns_true_for_assistant(): void
```

#### Step 12: Create ChatbotConfig Model Tests

**File: `tests/Unit/Models/ChatbotConfigTest.php`**

**Test Coverage Required:**
- Methods: `getValue()`, `setValue()`, `getDefault()`

**Key Test Cases:**
```php
public function test_get_value_returns_config_value(): void
public function test_set_value_updates_config_value(): void
public function test_get_default_returns_default_value(): void
```

#### Step 13: Create ChatbotPrompt Model Tests

**File: `tests/Unit/Models/ChatbotPromptTest.php`**

**Test Coverage Required:**
- Scopes: `scopeActive()`, `scopeDefault()`
- Methods: `render()`, `getDefault()`

**Key Test Cases:**
```php
public function test_scope_active_returns_only_active_prompts(): void
public function test_scope_default_returns_default_prompt(): void
public function test_render_replaces_placeholders(): void
public function test_get_default_returns_default_prompt(): void
```

#### Step 14: Create User Model Tests

**File: `tests/Unit/Models/UserTest.php`**

**Test Coverage Required:**
- Relationships: `media()` (hasMany - uploaded media)
- Methods: Standard Laravel authentication methods

**Key Test Cases:**
```php
public function test_user_has_media_relationship(): void
public function test_user_can_authenticate(): void
```

## 5. Test Implementation Guidelines

### 5.1 Testing Relationships

**Testing HasOne Relationship:**
```php
public function test_page_has_seo_relationship(): void
{
    $page = Page::factory()->create();
    $seo = PageSEO::factory()->create(['page_id' => $page->id]);

    $this->assertInstanceOf(PageSEO::class, $page->seo);
    $this->assertEquals($seo->id, $page->seo->id);
}
```

**Testing BelongsTo Relationship:**
```php
public function test_page_seo_belongs_to_page(): void
{
    $page = Page::factory()->create();
    $seo = PageSEO::factory()->create(['page_id' => $page->id]);

    $this->assertInstanceOf(Page::class, $seo->page);
    $this->assertEquals($page->id, $seo->page->id);
}
```

**Testing HasMany Relationship:**
```php
public function test_form_has_submissions_relationship(): void
{
    $form = Form::factory()->create();
    $submission = FormSubmission::factory()->create(['form_id' => $form->id]);

    $this->assertTrue($form->submissions->contains($submission));
    $this->assertEquals(1, $form->submissions->count());
}
```

**Testing BelongsToMany Relationship:**
```php
public function test_blog_post_has_categories_relationship(): void
{
    $post = BlogPost::factory()->create();
    $category = Category::factory()->create();
    $post->categories()->attach($category);

    $this->assertTrue($post->categories->contains($category));
    $this->assertEquals(1, $post->categories->count());
}
```

### 5.2 Testing Scopes

**Testing Query Scopes:**
```php
public function test_scope_published_returns_only_published_pages(): void
{
    $published = Page::factory()->create(['is_published' => true]);
    $unpublished = Page::factory()->create(['is_published' => false]);

    $results = Page::published()->get();

    $this->assertCount(1, $results);
    $this->assertTrue($results->contains($published));
    $this->assertFalse($results->contains($unpublished));
}
```

### 5.3 Testing Accessors

**Testing Accessors:**
```php
public function test_get_url_attribute_returns_correct_url(): void
{
    $page = Page::factory()->create(['slug' => 'test-page']);

    $this->assertEquals('/test-page', $page->url);
}
```

### 5.4 Testing Mutators

**Testing Mutators:**
```php
public function test_set_slug_attribute_sluggifies_value(): void
{
    $page = new Page();
    $page->slug = 'Test Page Title';

    $this->assertEquals('test-page-title', $page->slug);
}
```

### 5.5 Testing Model Methods

**Testing Custom Methods:**
```php
public function test_publish_method_sets_published_status(): void
{
    $page = Page::factory()->create(['is_published' => false]);

    $page->publish();

    $this->assertTrue($page->is_published);
    $this->assertNotNull($page->published_at);
}
```

### 5.6 Testing Model Events

**Testing Model Events (if implemented):**
```php
public function test_creating_event_sets_timestamps(): void
{
    Event::fake();

    $page = Page::factory()->create();

    Event::assertDispatched('eloquent.creating: App\Models\Page');
}
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check all test files exist:**
   ```bash
   find tests/Unit/Models -name "*Test.php" | wc -l
   ```

2. **Verify test structure:**
   - All tests extend `TestCase`
   - All tests use `RefreshDatabase` trait
   - Relationships are tested
   - Scopes are tested
   - Accessors are tested

### 6.2 Test Execution

1. **Run all model tests:**
   ```bash
   php artisan test tests/Unit/Models
   ```

2. **Run specific model test:**
   ```bash
   php artisan test tests/Unit/Models/PageTest.php
   ```

3. **Run with coverage:**
   ```bash
   php artisan test --coverage --min=70 tests/Unit/Models
   ```

### 6.3 Coverage Validation

1. **Check coverage report:**
   - Models should have 70%+ coverage
   - All relationships should be tested
   - All scopes should be tested
   - All accessors should be tested
   - All custom methods should be tested

2. **Review coverage gaps:**
   - Identify untested methods
   - Add tests for missing coverage
   - Focus on complex model logic

## 7. Success Criteria Checklist

- [ ] All model classes have test files
- [ ] All relationships are tested
- [ ] All query scopes are tested
- [ ] All accessors are tested
- [ ] All mutators are tested
- [ ] All custom methods are tested
- [ ] Test coverage meets 70% target
- [ ] All tests pass consistently
- [ ] Tests use RefreshDatabase for isolation
- [ ] Tests use factories for test data
- [ ] Relationship tests verify both directions

## 8. Next Steps

After completing P8.1.3:
- Review all unit test coverage
- Address any coverage gaps
- Proceed to P8.2: Integration Testing
- Refactor tests if needed

## 9. Notes

- Always use `RefreshDatabase` trait for database tests
- Use factories to create test data consistently
- Test relationships in both directions when applicable
- Test scopes independently and verify results
- Test accessors by accessing the attribute
- Test mutators by setting the attribute
- Keep tests focused on model layer only
- Don't test Eloquent ORM core functionality (test your custom code)

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
