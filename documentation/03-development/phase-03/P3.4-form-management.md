# P3.4 Form Management Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing the form management system in the admin panel for The Strengths Toolbox website. This includes building a form builder interface, implementing various field types, viewing submissions, exporting data, and email notifications.

### 1.2 Scope
This implementation plan covers tasks P3.4.1 through P3.4.5:
- **P3.4.1**: Build form builder interface
- **P3.4.2**: Implement form field types
- **P3.4.3**: Build form submission viewer
- **P3.4.4**: Implement form submission export
- **P3.4.5**: Add email notifications

### 1.3 Success Criteria
- Form builder allows creating dynamic forms
- Multiple field types supported (text, email, textarea, select, checkbox, radio, file)
- Form submissions can be viewed and managed
- Submissions can be exported to CSV
- Email notifications sent on form submission
- All operations properly integrated with existing services

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel form handling
- JavaScript for dynamic form building
- JSON data structures
- CSV export functionality
- Email integration

### 2.2 Dependencies
- Task P2.3.8 completed (AdminFormController created)
- Task P2.1.3 completed (FormService created)
- Task P2.1.5 completed (EmailService created)
- Task P1.2.3 completed (Form and FormSubmission models created)

### 2.3 Reference Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`

## 3. Existing Implementation Review

### 3.1 Current State
The following components are already implemented:
- `AdminFormController` with basic methods
- `FormService` with business logic
- `Form` and `FormSubmission` models
- Form fields stored as JSON in database

### 3.2 What Needs to Be Built
- Form builder interface (drag-and-drop or structured)
- Field type implementations
- Form submission viewer
- CSV export functionality
- Email notification integration

## 4. Task P3.4.1: Build Form Builder Interface

### 4.1 Overview
Create a user-friendly interface for building forms with various field types.

### 4.2 Step-by-Step Implementation

#### Step 1: Update AdminFormController

**File: `app/Http/Controllers/Admin/AdminFormController.php`** (add methods)

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Services\FormService;
use App\Services\EmailService;
use App\Models\Form;
use App\Models\FormSubmission;
use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Mail;

class AdminFormController extends Controller
{
    protected FormService $formService;
    protected EmailService $emailService;

    public function __construct(FormService $formService, EmailService $emailService)
    {
        $this->formService = $formService;
        $this->emailService = $emailService;
    }

    /**
     * Display a listing of forms
     *
     * @return \Illuminate\View\View
     */
    public function index()
    {
        $forms = Form::withCount('submissions')->latest()->paginate(20);
        return view('admin.forms.index', compact('forms'));
    }

    /**
     * Show the form for creating a new form
     *
     * @return \Illuminate\View\View
     */
    public function create()
    {
        return view('admin.forms.create');
    }

    /**
     * Store a newly created form
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:forms,slug',
            'fields' => 'required|array|min:1',
            'fields.*.type' => 'required|string|in:text,email,textarea,select,checkbox,radio,file,number,tel,url,date',
            'fields.*.label' => 'required|string|max:255',
            'fields.*.name' => 'required|string|max:255',
            'fields.*.required' => 'boolean',
            'fields.*.placeholder' => 'nullable|string|max:255',
            'fields.*.options' => 'nullable|array', // For select, radio, checkbox
            'email_to' => 'required|email',
            'success_message' => 'nullable|string|max:500',
            'is_active' => 'boolean',
        ]);

        if (empty($validated['slug'])) {
            $validated['slug'] = Str::slug($validated['name']);
        }

        // Generate field names if not provided
        foreach ($validated['fields'] as &$field) {
            if (empty($field['name'])) {
                $field['name'] = Str::slug($field['label'], '_');
            }
        }

        $form = Form::create($validated);

        return redirect()->route('admin.forms.show', $form)
            ->with('success', 'Form created successfully.');
    }

    /**
     * Display the specified form
     *
     * @param Form $form
     * @return \Illuminate\View\View
     */
    public function show(Form $form)
    {
        $form->load('submissions');
        return view('admin.forms.show', compact('form'));
    }

    /**
     * Show the form for editing the specified form
     *
     * @param Form $form
     * @return \Illuminate\View\View
     */
    public function edit(Form $form)
    {
        return view('admin.forms.edit', compact('form'));
    }

    /**
     * Update the specified form
     *
     * @param Request $request
     * @param Form $form
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, Form $form)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'slug' => 'nullable|string|max:255|unique:forms,slug,' . $form->id,
            'fields' => 'required|array|min:1',
            'fields.*.type' => 'required|string|in:text,email,textarea,select,checkbox,radio,file,number,tel,url,date',
            'fields.*.label' => 'required|string|max:255',
            'fields.*.name' => 'required|string|max:255',
            'fields.*.required' => 'boolean',
            'fields.*.placeholder' => 'nullable|string|max:255',
            'fields.*.options' => 'nullable|array',
            'email_to' => 'required|email',
            'success_message' => 'nullable|string|max:500',
            'is_active' => 'boolean',
        ]);

        if (empty($validated['slug'])) {
            $validated['slug'] = Str::slug($validated['name']);
        }

        $form->update($validated);

        return redirect()->route('admin.forms.show', $form)
            ->with('success', 'Form updated successfully.');
    }

    /**
     * Remove the specified form
     *
     * @param Form $form
     * @return \Illuminate\Http\RedirectResponse
     */
    public function destroy(Form $form)
    {
        $form->delete();

        return redirect()->route('admin.forms.index')
            ->with('success', 'Form deleted successfully.');
    }

    // ... existing submission methods ...
}
```

#### Step 2: Create Form Builder View

**File: `resources/views/admin/forms/create.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Create Form')

@section('content')
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Create New Form</h1>
        <p class="mt-1 text-sm text-gray-600">Build a custom form with dynamic fields</p>
    </div>

    <form method="POST" action="{{ route('admin.forms.store') }}" id="formBuilder">
        @csrf

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {{-- Form Builder --}}
            <div class="lg:col-span-2 space-y-6">
                {{-- Form Settings --}}
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Form Settings</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="name" class="form-label">Form Name <span class="text-red-500">*</span></label>
                            <input 
                                type="text" 
                                id="name" 
                                name="name" 
                                value="{{ old('name') }}"
                                required
                                class="form-input @error('name') border-red-500 @enderror"
                                placeholder="Contact Form"
                            >
                            @error('name')
                                <p class="form-error">{{ $message }}</p>
                            @enderror
                        </div>

                        <div>
                            <label for="slug" class="form-label">Form Slug</label>
                            <input 
                                type="text" 
                                id="slug" 
                                name="slug" 
                                value="{{ old('slug') }}"
                                class="form-input @error('slug') border-red-500 @enderror"
                                placeholder="contact-form"
                            >
                            <p class="mt-1 text-sm text-gray-500">Leave empty to auto-generate</p>
                            @error('slug')
                                <p class="form-error">{{ $message }}</p>
                            @enderror
                        </div>

                        <div>
                            <label for="email_to" class="form-label">Email To <span class="text-red-500">*</span></label>
                            <input 
                                type="email" 
                                id="email_to" 
                                name="email_to" 
                                value="{{ old('email_to') }}"
                                required
                                class="form-input @error('email_to') border-red-500 @enderror"
                                placeholder="admin@example.com"
                            >
                            <p class="mt-1 text-sm text-gray-500">Email address to receive form submissions</p>
                            @error('email_to')
                                <p class="form-error">{{ $message }}</p>
                            @enderror
                        </div>

                        <div>
                            <label for="success_message" class="form-label">Success Message</label>
                            <textarea 
                                id="success_message" 
                                name="success_message" 
                                rows="2"
                                class="form-input @error('success_message') border-red-500 @enderror"
                                placeholder="Thank you for your submission!"
                            >{{ old('success_message', 'Thank you for your submission!') }}</textarea>
                            @error('success_message')
                                <p class="form-error">{{ $message }}</p>
                            @enderror
                        </div>

                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                id="is_active" 
                                name="is_active" 
                                value="1"
                                {{ old('is_active', true) ? 'checked' : '' }}
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                            >
                            <label for="is_active" class="ml-2 block text-sm text-gray-900">
                                Form is active
                            </label>
                        </div>
                    </div>
                </div>

                {{-- Form Fields Builder --}}
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Form Fields</h2>
                        <button 
                            type="button"
                            onclick="addField()"
                            class="btn btn-primary btn-sm"
                        >
                            Add Field
                        </button>
                    </div>

                    <div id="fieldsContainer" class="space-y-4">
                        <!-- Fields will be added here dynamically -->
                    </div>
                </div>
            </div>

            {{-- Field Types Sidebar --}}
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Field Types</h2>
                    <div class="space-y-2">
                        <button type="button" onclick="addFieldType('text')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Text Input</button>
                        <button type="button" onclick="addFieldType('email')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Email</button>
                        <button type="button" onclick="addFieldType('textarea')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Textarea</button>
                        <button type="button" onclick="addFieldType('select')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Select Dropdown</button>
                        <button type="button" onclick="addFieldType('checkbox')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Checkbox</button>
                        <button type="button" onclick="addFieldType('radio')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Radio Button</button>
                        <button type="button" onclick="addFieldType('file')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">File Upload</button>
                        <button type="button" onclick="addFieldType('number')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Number</button>
                        <button type="button" onclick="addFieldType('date')" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">Date</button>
                    </div>
                </div>
            </div>
        </div>

        {{-- Form Actions --}}
        <div class="mt-6 flex items-center justify-end gap-3">
            <a href="{{ route('admin.forms.index') }}" class="btn btn-outline">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                Create Form
            </button>
        </div>
    </form>
</div>

@push('scripts')
<script>
let fieldCounter = 0;

function addFieldType(type) {
    const fieldTypes = {
        text: { label: 'Text Input', placeholder: 'Enter text' },
        email: { label: 'Email Address', placeholder: 'your@email.com' },
        textarea: { label: 'Textarea', placeholder: 'Enter message' },
        select: { label: 'Select Option', placeholder: '' },
        checkbox: { label: 'Checkbox', placeholder: '' },
        radio: { label: 'Radio Button', placeholder: '' },
        file: { label: 'File Upload', placeholder: '' },
        number: { label: 'Number', placeholder: '0' },
        date: { label: 'Date', placeholder: '' },
    };

    const field = {
        id: fieldCounter++,
        type: type,
        label: fieldTypes[type].label,
        name: '',
        required: false,
        placeholder: fieldTypes[type].placeholder,
        options: type === 'select' || type === 'radio' || type === 'checkbox' ? ['Option 1', 'Option 2'] : null,
    };

    addField(field);
}

function addField(fieldData = null) {
    const container = document.getElementById('fieldsContainer');
    const fieldId = fieldData?.id ?? fieldCounter++;
    
    const field = fieldData || {
        id: fieldId,
        type: 'text',
        label: 'New Field',
        name: '',
        required: false,
        placeholder: '',
        options: null,
    };

    const fieldHtml = `
        <div class="border border-gray-200 rounded-lg p-4" data-field-id="${field.id}">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-medium text-gray-900">${field.label || 'New Field'}</h3>
                <button type="button" onclick="removeField(${field.id})" class="text-red-600 hover:text-red-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-3">
                <input type="hidden" name="fields[${field.id}][id]" value="${field.id}">
                
                <div>
                    <label class="form-label">Field Type</label>
                    <select name="fields[${field.id}][type]" class="form-input" onchange="updateFieldType(${field.id}, this.value)">
                        <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="email" ${field.type === 'email' ? 'selected' : ''}>Email</option>
                        <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Textarea</option>
                        <option value="select" ${field.type === 'select' ? 'selected' : ''}>Select</option>
                        <option value="checkbox" ${field.type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                        <option value="radio" ${field.type === 'radio' ? 'selected' : ''}>Radio</option>
                        <option value="file" ${field.type === 'file' ? 'selected' : ''}>File</option>
                        <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                        <option value="date" ${field.type === 'date' ? 'selected' : ''}>Date</option>
                    </select>
                </div>

                <div>
                    <label class="form-label">Label <span class="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        name="fields[${field.id}][label]" 
                        value="${field.label || ''}"
                        required
                        class="form-input"
                        placeholder="Field Label"
                        onchange="updateFieldName(${field.id}, this.value)"
                    >
                </div>

                <div>
                    <label class="form-label">Field Name</label>
                    <input 
                        type="text" 
                        name="fields[${field.id}][name]" 
                        value="${field.name || ''}"
                        class="form-input"
                        placeholder="field_name"
                    >
                    <p class="mt-1 text-xs text-gray-500">Auto-generated from label if empty</p>
                </div>

                <div>
                    <label class="form-label">Placeholder</label>
                    <input 
                        type="text" 
                        name="fields[${field.id}][placeholder]" 
                        value="${field.placeholder || ''}"
                        class="form-input"
                        placeholder="Placeholder text"
                    >
                </div>

                ${(field.type === 'select' || field.type === 'radio' || field.type === 'checkbox') ? `
                <div>
                    <label class="form-label">Options</label>
                    <div id="options-${field.id}" class="space-y-2">
                        ${field.options ? field.options.map((opt, idx) => `
                            <div class="flex gap-2">
                                <input type="text" name="fields[${field.id}][options][]" value="${opt}" class="form-input" placeholder="Option ${idx + 1}">
                                <button type="button" onclick="removeOption(${field.id}, this)" class="text-red-600">×</button>
                            </div>
                        `).join('') : ''}
                    </div>
                    <button type="button" onclick="addOption(${field.id})" class="mt-2 text-sm text-primary-600">+ Add Option</button>
                </div>
                ` : ''}

                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        name="fields[${field.id}][required]" 
                        value="1"
                        ${field.required ? 'checked' : ''}
                        class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                    >
                    <label class="ml-2 block text-sm text-gray-900">Required field</label>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', fieldHtml);
}

function removeField(id) {
    document.querySelector(`[data-field-id="${id}"]`).remove();
}

function updateFieldType(id, type) {
    const fieldContainer = document.querySelector(`[data-field-id="${id}"]`);
    const optionsContainer = fieldContainer.querySelector(`#options-${id}`);
    
    if (type === 'select' || type === 'radio' || type === 'checkbox') {
        if (!optionsContainer) {
            const optionsHtml = `
                <div>
                    <label class="form-label">Options</label>
                    <div id="options-${id}" class="space-y-2">
                        <div class="flex gap-2">
                            <input type="text" name="fields[${id}][options][]" class="form-input" placeholder="Option 1">
                            <button type="button" onclick="removeOption(${id}, this)" class="text-red-600">×</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" name="fields[${id}][options][]" class="form-input" placeholder="Option 2">
                            <button type="button" onclick="removeOption(${id}, this)" class="text-red-600">×</button>
                        </div>
                    </div>
                    <button type="button" onclick="addOption(${id})" class="mt-2 text-sm text-primary-600">+ Add Option</button>
                </div>
            `;
            fieldContainer.querySelector('.space-y-3').insertAdjacentHTML('beforeend', optionsHtml);
        }
    } else {
        if (optionsContainer) {
            optionsContainer.closest('div').remove();
        }
    }
}

function addOption(fieldId) {
    const container = document.getElementById(`options-${fieldId}`);
    const optionHtml = `
        <div class="flex gap-2">
            <input type="text" name="fields[${fieldId}][options][]" class="form-input" placeholder="New Option">
            <button type="button" onclick="removeOption(${fieldId}, this)" class="text-red-600">×</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', optionHtml);
}

function removeOption(fieldId, button) {
    button.closest('div').remove();
}

function updateFieldName(id, label) {
    const nameInput = document.querySelector(`[data-field-id="${id}"] input[name="fields[${id}][name]"]`);
    if (!nameInput.value) {
        nameInput.value = label.toLowerCase().replace(/[^a-z0-9]+/g, '_');
    }
}

// Auto-generate slug from name
document.getElementById('name').addEventListener('input', function() {
    const slugInput = document.getElementById('slug');
    if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        slugInput.value = this.value.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.dataset.autoGenerated = 'true';
    }
});

document.getElementById('slug').addEventListener('input', function() {
    this.dataset.autoGenerated = 'false';
});

// Re-index fields before submit
document.getElementById('formBuilder').addEventListener('submit', function(e) {
    const fields = document.querySelectorAll('[data-field-id]');
    fields.forEach((field, index) => {
        const fieldId = field.dataset.fieldId;
        field.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(`fields[${fieldId}]`, `fields[${index}]`);
            }
        });
    });
});
</script>
@endpush
@endsection
```

### 4.3 Validation
- Test form builder interface
- Add different field types
- Verify field configuration saves
- Test form creation

## 5. Task P3.4.2: Implement Form Field Types

### 5.1 Overview
The field types are defined in the form builder. This section covers rendering forms on the frontend.

### 5.2 Step-by-Step Implementation

#### Step 1: Create Form Rendering Service

**File: `app/Services/FormRenderService.php`**

```php
<?php

namespace App\Services;

use App\Models\Form;

class FormRenderService
{
    /**
     * Render form HTML
     *
     * @param Form $form
     * @return string
     */
    public function render(Form $form): string
    {
        $html = '<form method="POST" action="' . route('forms.submit', $form->slug) . '"';
        
        // Check if form has file upload
        $hasFileUpload = collect($form->fields)->contains('type', 'file');
        if ($hasFileUpload) {
            $html .= ' enctype="multipart/form-data"';
        }
        
        $html .= ' class="space-y-4">';
        $html .= csrf_field();
        
        foreach ($form->fields as $field) {
            $html .= $this->renderField($field);
        }
        
        $html .= '<button type="submit" class="btn btn-primary">Submit</button>';
        $html .= '</form>';
        
        return $html;
    }

    /**
     * Render individual field
     *
     * @param array $field
     * @return string
     */
    protected function renderField(array $field): string
    {
        $html = '<div class="form-group">';
        $html .= '<label for="' . $field['name'] . '" class="form-label">';
        $html .= htmlspecialchars($field['label']);
        if ($field['required'] ?? false) {
            $html .= ' <span class="text-red-500">*</span>';
        }
        $html .= '</label>';
        
        switch ($field['type']) {
            case 'textarea':
                $html .= $this->renderTextarea($field);
                break;
            case 'select':
                $html .= $this->renderSelect($field);
                break;
            case 'checkbox':
                $html .= $this->renderCheckbox($field);
                break;
            case 'radio':
                $html .= $this->renderRadio($field);
                break;
            case 'file':
                $html .= $this->renderFile($field);
                break;
            default:
                $html .= $this->renderInput($field);
        }
        
        $html .= '</div>';
        return $html;
    }

    protected function renderInput(array $field): string
    {
        $required = ($field['required'] ?? false) ? 'required' : '';
        $placeholder = isset($field['placeholder']) ? 'placeholder="' . htmlspecialchars($field['placeholder']) . '"' : '';
        
        return sprintf(
            '<input type="%s" id="%s" name="%s" class="form-input" %s %s>',
            $field['type'],
            $field['name'],
            $field['name'],
            $required,
            $placeholder
        );
    }

    protected function renderTextarea(array $field): string
    {
        $required = ($field['required'] ?? false) ? 'required' : '';
        $placeholder = isset($field['placeholder']) ? 'placeholder="' . htmlspecialchars($field['placeholder']) . '"' : '';
        
        return sprintf(
            '<textarea id="%s" name="%s" rows="4" class="form-input" %s %s></textarea>',
            $field['name'],
            $field['name'],
            $required,
            $placeholder
        );
    }

    protected function renderSelect(array $field): string
    {
        $required = ($field['required'] ?? false) ? 'required' : '';
        $html = sprintf('<select id="%s" name="%s" class="form-input" %s>', $field['name'], $field['name'], $required);
        $html .= '<option value="">Select an option</option>';
        
        foreach ($field['options'] ?? [] as $option) {
            $html .= sprintf('<option value="%s">%s</option>', htmlspecialchars($option), htmlspecialchars($option));
        }
        
        $html .= '</select>';
        return $html;
    }

    protected function renderCheckbox(array $field): string
    {
        $html = '<div class="space-y-2">';
        foreach ($field['options'] ?? [] as $option) {
            $html .= sprintf(
                '<div class="flex items-center"><input type="checkbox" id="%s_%s" name="%s[]" value="%s" class="h-4 w-4 text-primary-600"><label for="%s_%s" class="ml-2">%s</label></div>',
                $field['name'],
                md5($option),
                $field['name'],
                htmlspecialchars($option),
                $field['name'],
                md5($option),
                htmlspecialchars($option)
            );
        }
        $html .= '</div>';
        return $html;
    }

    protected function renderRadio(array $field): string
    {
        $html = '<div class="space-y-2">';
        foreach ($field['options'] ?? [] as $option) {
            $html .= sprintf(
                '<div class="flex items-center"><input type="radio" id="%s_%s" name="%s" value="%s" class="h-4 w-4 text-primary-600"><label for="%s_%s" class="ml-2">%s</label></div>',
                $field['name'],
                md5($option),
                $field['name'],
                htmlspecialchars($option),
                $field['name'],
                md5($option),
                htmlspecialchars($option)
            );
        }
        $html .= '</div>';
        return $html;
    }

    protected function renderFile(array $field): string
    {
        $required = ($field['required'] ?? false) ? 'required' : '';
        return sprintf(
            '<input type="file" id="%s" name="%s" class="form-input" %s>',
            $field['name'],
            $field['name'],
            $required
        );
    }
}
```

## 6. Task P3.4.3: Build Form Submission Viewer

### 6.1 Overview
Create interfaces for viewing and managing form submissions.

### 6.2 Step-by-Step Implementation

#### Step 1: Create Submission Index View

**File: `resources/views/admin/forms/submissions.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Form Submissions')

@section('content')
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ $form->name }} - Submissions</h1>
            <p class="mt-1 text-sm text-gray-600">{{ $submissions->total() }} total submissions</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ route('admin.forms.submissions.export', $form) }}" class="btn btn-outline">
                Export CSV
            </a>
            <a href="{{ route('admin.forms.index') }}" class="btn btn-outline">
                Back to Forms
            </a>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        @if($submissions->count() > 0)
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Submitted</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach($submissions as $submission)
                    <tr class="hover:bg-gray-50 {{ !$submission->is_read ? 'bg-blue-50' : '' }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ $submission->created_at->format('M d, Y g:i A') }}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="max-w-md">
                                @foreach(array_slice($submission->data, 0, 3) as $key => $value)
                                    <div class="truncate">
                                        <strong>{{ $key }}:</strong> {{ is_array($value) ? implode(', ', $value) : $value }}
                                    </div>
                                @endforeach
                                @if(count($submission->data) > 3)
                                    <div class="text-gray-400">... and {{ count($submission->data) - 3 }} more</div>
                                @endif
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            @if($submission->is_read)
                                <span class="badge badge-success">Read</span>
                            @else
                                <span class="badge badge-primary">Unread</span>
                            @endif
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <a href="{{ route('admin.forms.submission.show', [$form, $submission]) }}" class="text-primary-600 hover:text-primary-900">
                                View
                            </a>
                        </td>
                    </tr>
                    @endforeach
                </tbody>
            </table>

            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                {{ $submissions->links() }}
            </div>
        @else
            <div class="p-12 text-center">
                <p class="text-gray-500">No submissions yet</p>
            </div>
        @endif
    </div>
</div>
@endsection
```

#### Step 2: Create Submission Detail View

**File: `resources/views/admin/forms/submission.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Submission Details')

@section('content')
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <a href="{{ route('admin.forms.submissions', $form) }}" class="text-primary-600 hover:text-primary-900">
            ← Back to Submissions
        </a>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Submission Details</h1>
            <p class="text-sm text-gray-500 mt-1">
                Submitted on {{ $submission->created_at->format('F d, Y \a\t g:i A') }}
            </p>
        </div>

        <div class="space-y-4">
            @foreach($submission->data as $key => $value)
            <div class="border-b border-gray-200 pb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    {{ ucwords(str_replace('_', ' ', $key)) }}
                </label>
                <div class="text-gray-900">
                    @if(is_array($value))
                        {{ implode(', ', $value) }}
                    @else
                        {{ $value }}
                    @endif
                </div>
            </div>
            @endforeach
        </div>

        <div class="mt-6 flex items-center justify-end gap-3">
            <form method="POST" action="{{ route('admin.forms.submission.delete', [$form, $submission]) }}" class="inline">
                @csrf
                @method('DELETE')
                <button type="submit" class="btn btn-outline text-red-600 border-red-600 hover:bg-red-50" onclick="return confirm('Are you sure?')">
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>
@endsection
```

## 7. Task P3.4.4: Implement Form Submission Export

### 7.1 Overview
Add CSV export functionality for form submissions.

### 7.2 Step-by-Step Implementation

#### Step 1: Add Export Method to Controller

**File: `app/Http/Controllers/Admin/AdminFormController.php`** (add method)

```php
/**
 * Export form submissions to CSV
 *
 * @param Form $form
 * @return \Symfony\Component\HttpFoundation\StreamedResponse
 */
public function export(Form $form)
{
    $submissions = $form->submissions()->latest()->get();

    $filename = $form->slug . '-submissions-' . date('Y-m-d') . '.csv';

    $headers = [
        'Content-Type' => 'text/csv',
        'Content-Disposition' => 'attachment; filename="' . $filename . '"',
    ];

    $callback = function() use ($submissions, $form) {
        $file = fopen('php://output', 'w');

        // Get all unique field names from all submissions
        $allFields = [];
        foreach ($submissions as $submission) {
            $allFields = array_merge($allFields, array_keys($submission->data));
        }
        $allFields = array_unique($allFields);

        // Write header
        $header = ['Submitted At', 'IP Address', 'User Agent'];
        $header = array_merge($header, $allFields);
        fputcsv($file, $header);

        // Write data
        foreach ($submissions as $submission) {
            $row = [
                $submission->created_at->format('Y-m-d H:i:s'),
                $submission->ip_address ?? '',
                $submission->user_agent ?? '',
            ];

            foreach ($allFields as $field) {
                $value = $submission->data[$field] ?? '';
                if (is_array($value)) {
                    $value = implode(', ', $value);
                }
                $row[] = $value;
            }

            fputcsv($file, $row);
        }

        fclose($file);
    };

    return response()->stream($callback, 200, $headers);
}
```

#### Step 2: Add Route

**File: `routes/admin.php`** (add)

```php
Route::get('/forms/{form}/submissions/export', [AdminFormController::class, 'export'])->name('forms.submissions.export');
```

### 7.3 Validation
- Test CSV export
- Verify all fields are included
- Check file downloads correctly
- Verify data formatting

## 8. Task P3.4.5: Add Email Notifications

### 8.1 Overview
Send email notifications when forms are submitted.

### 8.2 Step-by-Step Implementation

#### Step 1: Update FormService

**File: `app/Services/FormService.php`** (add method)

```php
/**
 * Submit form
 *
 * @param Form $form
 * @param array $data
 * @return FormSubmission
 */
public function submit(Form $form, array $data): FormSubmission
{
    // Validate data against form fields
    $this->validateSubmission($form, $data);

    // Create submission
    $submission = FormSubmission::create([
        'form_id' => $form->id,
        'user_id' => auth()->id(),
        'data' => $data,
        'ip_address' => request()->ip(),
        'user_agent' => request()->userAgent(),
        'is_read' => false,
    ]);

    // Send email notification
    if ($form->email_to) {
        $this->emailService->sendFormSubmissionNotification(
            $form->email_to,
            $form,
            $submission
        );
    }

    return $submission;
}

/**
 * Validate submission data against form fields
 *
 * @param Form $form
 * @param array $data
 * @return void
 * @throws \Illuminate\Validation\ValidationException
 */
protected function validateSubmission(Form $form, array $data): void
{
    $rules = [];
    
    foreach ($form->fields as $field) {
        $fieldRules = [];
        
        if ($field['required'] ?? false) {
            $fieldRules[] = 'required';
        } else {
            $fieldRules[] = 'nullable';
        }

        switch ($field['type']) {
            case 'email':
                $fieldRules[] = 'email';
                break;
            case 'file':
                $fieldRules[] = 'file';
                break;
            case 'number':
                $fieldRules[] = 'numeric';
                break;
            case 'date':
                $fieldRules[] = 'date';
                break;
        }

        $fieldName = $field['name'];
        if ($field['type'] === 'checkbox') {
            $fieldName .= '.*';
        }

        $rules[$fieldName] = $fieldRules;
    }

    \Validator::make($data, $rules)->validate();
}
```

#### Step 2: Verify Email Service

The `EmailService::sendFormSubmissionNotification` method should already exist from Phase 2. Verify it's working correctly.

### 8.3 Validation
- Submit a form
- Verify email is sent
- Check email content
- Test with different form configurations

## 9. Testing and Validation

### 9.1 Complete Workflow Test

1. **Create Form:**
   - Navigate to `/admin/forms/create`
   - Add various field types
   - Configure form settings
   - Save form

2. **View Form:**
   - Check form appears in list
   - View form details
   - Test form rendering

3. **Submit Form:**
   - Submit form on frontend
   - Verify submission is recorded
   - Check email notification

4. **View Submissions:**
   - View submission list
   - View individual submission
   - Export to CSV

### 9.2 Common Issues and Solutions

#### Issue: Form fields not saving
**Solution:**
- Verify JSON encoding in model
- Check field validation rules
- Review form builder JavaScript

#### Issue: Email not sending
**Solution:**
- Check email configuration
- Verify email_to field is set
- Check email service implementation
- Review mail logs

#### Issue: CSV export failing
**Solution:**
- Check file permissions
- Verify memory limits
- Test with small datasets first

## 10. References

### 10.1 Architecture Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`

### 10.2 External Resources
- [Laravel Validation](https://laravel.com/docs/10.x/validation)
- [Laravel Mail](https://laravel.com/docs/10.x/mail)

### 10.3 Related Tasks
- **Previous Task**: P3.3 - Media Library
- **Next Task**: P3.5 - Testimonial Management
- **Dependencies**: P2.3.8, P2.1.3, P2.1.5

---

**Document Version**: 1.0  
**Last Updated**: 2025  
**Status**: Ready for Implementation
