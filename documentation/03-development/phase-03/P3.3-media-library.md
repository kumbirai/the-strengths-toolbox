# P3.3 Media Library Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing the media library system in the admin panel for The Strengths Toolbox website. This includes file upload functionality, media library interface, image optimization, and media deletion.

### 1.2 Scope
This implementation plan covers tasks P3.3.1 through P3.3.4:
- **P3.3.1**: Create media upload functionality
- **P3.3.2**: Build media library interface
- **P3.3.3**: Implement image optimization
- **P3.3.4**: Add media deletion

### 1.3 Success Criteria
- Media files can be uploaded via admin interface
- Media library displays all uploaded files with thumbnails
- Image optimization working (resize, compress, WebP conversion)
- Media deletion functional with confirmation
- Integration with TinyMCE editor for image insertion
- All operations properly integrated with existing services

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel file storage
- Image manipulation (Intervention Image or similar)
- JavaScript for drag-and-drop uploads
- File validation and security

### 2.2 Dependencies
- Task P2.1.3 completed (FormService - for reference on file handling)
- Task P3.1.5 completed (WYSIWYG editor integration)
- Storage disk configured (public disk)
- PHP GD or Imagick extension for image processing

### 2.3 Reference Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`
- Laravel File Storage: https://laravel.com/docs/10.x/filesystem

## 3. Database Schema

### 3.1 Media Table Migration

**File: `database/migrations/YYYY_MM_DD_HHMMSS_create_media_table.php`**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('media', function (Blueprint $table) {
            $table->id();
            $table->string('filename');
            $table->string('original_filename');
            $table->string('path');
            $table->string('mime_type');
            $table->unsignedBigInteger('size');
            $table->string('disk')->default('public');
            $table->unsignedInteger('width')->nullable();
            $table->unsignedInteger('height')->nullable();
            $table->string('alt_text')->nullable();
            $table->text('description')->nullable();
            $table->unsignedBigInteger('uploaded_by')->nullable();
            $table->foreign('uploaded_by')->references('id')->on('users')->onDelete('set null');
            $table->timestamps();
            $table->softDeletes();
            
            $table->index('mime_type');
            $table->index('uploaded_by');
            $table->index('created_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('media');
    }
};
```

## 4. Task P3.3.1: Create Media Upload Functionality

### 4.1 Overview
Implement file upload functionality with validation, storage, and database recording.

### 4.2 Step-by-Step Implementation

#### Step 1: Create Media Model

**File: `app/Models/Media.php`**

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Support\Facades\Storage;

class Media extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'filename',
        'original_filename',
        'path',
        'mime_type',
        'size',
        'disk',
        'width',
        'height',
        'alt_text',
        'description',
        'uploaded_by',
    ];

    protected function casts(): array
    {
        return [
            'size' => 'integer',
            'width' => 'integer',
            'height' => 'integer',
        ];
    }

    public function uploader()
    {
        return $this->belongsTo(User::class, 'uploaded_by');
    }

    public function getUrlAttribute(): string
    {
        return Storage::disk($this->disk)->url($this->path);
    }

    public function getFullPathAttribute(): string
    {
        return Storage::disk($this->disk)->path($this->path);
    }

    public function isImage(): bool
    {
        return str_starts_with($this->mime_type, 'image/');
    }

    public function getThumbnailUrlAttribute(): ?string
    {
        if (!$this->isImage()) {
            return null;
        }

        $thumbnailPath = 'thumbnails/' . $this->path;
        
        if (Storage::disk($this->disk)->exists($thumbnailPath)) {
            return Storage::disk($this->disk)->url($thumbnailPath);
        }

        return $this->url;
    }
}
```

#### Step 2: Create Media Service

**File: `app/Services/MediaService.php`**

```php
<?php

namespace App\Services;

use App\Models\Media;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Intervention\Image\Facades\Image;

class MediaService
{
    protected string $disk = 'public';
    protected string $basePath = 'media';

    /**
     * Upload a file
     *
     * @param UploadedFile $file
     * @param array $options
     * @return Media
     */
    public function upload(UploadedFile $file, array $options = []): Media
    {
        $originalFilename = $file->getClientOriginalName();
        $filename = $this->generateFilename($originalFilename);
        $path = $this->storeFile($file, $filename, $options);

        $mediaData = [
            'filename' => $filename,
            'original_filename' => $originalFilename,
            'path' => $path,
            'mime_type' => $file->getMimeType(),
            'size' => $file->getSize(),
            'disk' => $this->disk,
            'uploaded_by' => auth()->id(),
            'alt_text' => $options['alt_text'] ?? null,
            'description' => $options['description'] ?? null,
        ];

        // If image, get dimensions and optimize
        if ($this->isImage($file)) {
            $imageData = $this->processImage($file, $path, $options);
            $mediaData = array_merge($mediaData, $imageData);
        }

        return Media::create($mediaData);
    }

    /**
     * Store file on disk
     *
     * @param UploadedFile $file
     * @param string $filename
     * @param array $options
     * @return string
     */
    protected function storeFile(UploadedFile $file, string $filename, array $options): string
    {
        $directory = $options['directory'] ?? $this->basePath;
        $fullPath = $directory . '/' . $filename;

        $file->storeAs($directory, $filename, $this->disk);

        return $fullPath;
    }

    /**
     * Process image (resize, optimize, create thumbnails)
     *
     * @param UploadedFile $file
     * @param string $path
     * @param array $options
     * @return array
     */
    protected function processImage(UploadedFile $file, string $path, array $options): array
    {
        $image = Image::make($file);
        $data = [
            'width' => $image->width(),
            'height' => $image->height(),
        ];

        // Resize if max dimensions specified
        if (isset($options['max_width']) || isset($options['max_height'])) {
            $maxWidth = $options['max_width'] ?? 2000;
            $maxHeight = $options['max_height'] ?? 2000;
            
            if ($image->width() > $maxWidth || $image->height() > $maxHeight) {
                $image->resize($maxWidth, $maxHeight, function ($constraint) {
                    $constraint->aspectRatio();
                    $constraint->upsize();
                });
                
                // Save optimized image
                $fullPath = Storage::disk($this->disk)->path($path);
                $image->save($fullPath, $options['quality'] ?? 85);
                
                $data['width'] = $image->width();
                $data['height'] = $image->height();
            }
        }

        // Create thumbnail
        if ($options['create_thumbnail'] ?? true) {
            $this->createThumbnail($image, $path);
        }

        return $data;
    }

    /**
     * Create thumbnail
     *
     * @param \Intervention\Image\Image $image
     * @param string $originalPath
     * @return void
     */
    protected function createThumbnail($image, string $originalPath): void
    {
        $thumbnail = clone $image;
        $thumbnail->fit(300, 300);
        
        $thumbnailPath = 'thumbnails/' . $originalPath;
        $fullThumbnailPath = Storage::disk($this->disk)->path($thumbnailPath);
        
        // Ensure directory exists
        $directory = dirname($fullThumbnailPath);
        if (!is_dir($directory)) {
            mkdir($directory, 0755, true);
        }
        
        $thumbnail->save($fullThumbnailPath, 80);
    }

    /**
     * Generate unique filename
     *
     * @param string $originalFilename
     * @return string
     */
    protected function generateFilename(string $originalFilename): string
    {
        $extension = pathinfo($originalFilename, PATHINFO_EXTENSION);
        $name = pathinfo($originalFilename, PATHINFO_FILENAME);
        $slug = Str::slug($name);
        
        $filename = $slug . '-' . time() . '.' . $extension;
        
        // Ensure uniqueness
        $counter = 1;
        while (Storage::disk($this->disk)->exists($this->basePath . '/' . $filename)) {
            $filename = $slug . '-' . time() . '-' . $counter . '.' . $extension;
            $counter++;
        }
        
        return $filename;
    }

    /**
     * Check if file is an image
     *
     * @param UploadedFile $file
     * @return bool
     */
    protected function isImage(UploadedFile $file): bool
    {
        return str_starts_with($file->getMimeType(), 'image/');
    }

    /**
     * Delete media file
     *
     * @param Media $media
     * @return bool
     */
    public function delete(Media $media): bool
    {
        // Delete file from storage
        Storage::disk($media->disk)->delete($media->path);
        
        // Delete thumbnail if exists
        $thumbnailPath = 'thumbnails/' . $media->path;
        if (Storage::disk($media->disk)->exists($thumbnailPath)) {
            Storage::disk($media->disk)->delete($thumbnailPath);
        }
        
        // Delete from database
        return $media->delete();
    }
}
```

#### Step 3: Create Media Controller

**File: `app/Http/Controllers/Admin/AdminMediaController.php`**

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Media;
use App\Services\MediaService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class AdminMediaController extends Controller
{
    protected MediaService $mediaService;

    public function __construct(MediaService $mediaService)
    {
        $this->mediaService = $mediaService;
    }

    /**
     * Display media library
     *
     * @param Request $request
     * @return \Illuminate\View\View
     */
    public function index(Request $request)
    {
        $query = Media::query();

        // Filter by type
        if ($request->has('type')) {
            if ($request->type === 'images') {
                $query->where('mime_type', 'like', 'image/%');
            } elseif ($request->type === 'documents') {
                $query->whereNotIn('mime_type', ['image/%']);
            }
        }

        // Search
        if ($request->has('search')) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('filename', 'like', "%{$search}%")
                  ->orWhere('original_filename', 'like', "%{$search}%")
                  ->orWhere('alt_text', 'like', "%{$search}%");
            });
        }

        $media = $query->latest()->paginate(24);

        return view('admin.media.index', compact('media'));
    }

    /**
     * Upload media file
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function upload(Request $request)
    {
        $validated = $request->validate([
            'file' => 'required|file|max:10240', // 10MB max
            'alt_text' => 'nullable|string|max:255',
            'description' => 'nullable|string|max:1000',
            'directory' => 'nullable|string|max:255',
        ]);

        try {
            $file = $request->file('file');
            $options = [
                'alt_text' => $validated['alt_text'] ?? null,
                'description' => $validated['description'] ?? null,
                'directory' => $validated['directory'] ?? null,
                'max_width' => 2000,
                'max_height' => 2000,
                'create_thumbnail' => true,
            ];

            $media = $this->mediaService->upload($file, $options);

            return response()->json([
                'success' => true,
                'media' => $media,
                'url' => $media->url,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 422);
        }
    }

    /**
     * Show media details
     *
     * @param Media $media
     * @return \Illuminate\View\View
     */
    public function show(Media $media)
    {
        return view('admin.media.show', compact('media'));
    }

    /**
     * Update media metadata
     *
     * @param Request $request
     * @param Media $media
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, Media $media)
    {
        $validated = $request->validate([
            'alt_text' => 'nullable|string|max:255',
            'description' => 'nullable|string|max:1000',
        ]);

        $media->update($validated);

        return redirect()->route('admin.media.show', $media)
            ->with('success', 'Media updated successfully.');
    }

    /**
     * Delete media
     *
     * @param Media $media
     * @return \Illuminate\Http\RedirectResponse
     */
    public function destroy(Media $media)
    {
        try {
            $this->mediaService->delete($media);

            return redirect()->route('admin.media.index')
                ->with('success', 'Media deleted successfully.');
        } catch (\Exception $e) {
            return redirect()->back()
                ->withErrors(['error' => 'Failed to delete media: ' . $e->getMessage()]);
        }
    }
}
```

#### Step 4: Add Routes

**File: `routes/admin.php`** (add)

```php
Route::resource('media', AdminMediaController::class);
Route::post('/media/upload', [AdminMediaController::class, 'upload'])->name('media.upload');
```

### 4.3 Install Intervention Image

```bash
composer require intervention/image
```

Publish config:
```bash
php artisan vendor:publish --provider="Intervention\Image\ImageServiceProvider"
```

### 4.4 Validation
- Test file upload via API endpoint
- Verify files are stored correctly
- Check database records are created
- Verify image optimization works

## 5. Task P3.3.2: Build Media Library Interface

### 5.1 Overview
Create a user-friendly interface for browsing, searching, and managing media files.

### 5.2 Step-by-Step Implementation

#### Step 1: Create Media Library Index View

**File: `resources/views/admin/media/index.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Media Library')

@section('content')
<div class="space-y-6">
    {{-- Header --}}
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Media Library</h1>
            <p class="mt-1 text-sm text-gray-600">Manage your media files</p>
        </div>
        <button 
            type="button"
            onclick="openUploadModal()"
            class="btn btn-primary"
        >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Upload Media
        </button>
    </div>

    {{-- Filters --}}
    <div class="bg-white rounded-lg shadow p-6">
        <form method="GET" action="{{ route('admin.media.index') }}" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <label for="search" class="form-label">Search</label>
                <input 
                    type="text" 
                    id="search" 
                    name="search" 
                    value="{{ request('search') }}"
                    placeholder="Search files..."
                    class="form-input"
                >
            </div>
            
            <div class="w-48">
                <label for="type" class="form-label">Type</label>
                <select id="type" name="type" class="form-input">
                    <option value="">All</option>
                    <option value="images" {{ request('type') === 'images' ? 'selected' : '' }}>Images</option>
                    <option value="documents" {{ request('type') === 'documents' ? 'selected' : '' }}>Documents</option>
                </select>
            </div>
            
            <div class="flex items-end gap-2">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="{{ route('admin.media.index') }}" class="btn btn-outline">Clear</a>
            </div>
        </form>
    </div>

    {{-- Media Grid --}}
    <div class="bg-white rounded-lg shadow p-6">
        @if($media->count() > 0)
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                @foreach($media as $item)
                <div class="group relative bg-gray-100 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
                    @if($item->isImage())
                        <a href="{{ route('admin.media.show', $item) }}">
                            <img 
                                src="{{ $item->thumbnail_url }}" 
                                alt="{{ $item->alt_text ?? $item->filename }}"
                                class="w-full h-32 object-cover"
                            >
                        </a>
                    @else
                        <a href="{{ route('admin.media.show', $item) }}" class="flex items-center justify-center h-32 bg-gray-200">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </a>
                    @endif
                    
                    <div class="p-2">
                        <p class="text-xs text-gray-600 truncate" title="{{ $item->filename }}">
                            {{ $item->filename }}
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            {{ $this->formatBytes($item->size) }}
                        </p>
                    </div>

                    {{-- Actions --}}
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex gap-1">
                            <a 
                                href="{{ route('admin.media.show', $item) }}"
                                class="bg-white p-1 rounded shadow hover:bg-gray-50"
                                title="View"
                            >
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </a>
                            <button 
                                type="button"
                                onclick="confirmDelete({{ $item->id }}, '{{ addslashes($item->filename) }}')"
                                class="bg-white p-1 rounded shadow hover:bg-red-50"
                                title="Delete"
                            >
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                @endforeach
            </div>

            {{-- Pagination --}}
            <div class="mt-6">
                {{ $media->links() }}
            </div>
        @else
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No media files</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by uploading your first file.</p>
            </div>
        @endif
    </div>
</div>

{{-- Upload Modal --}}
<div id="uploadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 text-center">Upload Media</h3>
            <form id="uploadForm" enctype="multipart/form-data" class="mt-4 space-y-4">
                @csrf
                <div>
                    <label for="file" class="form-label">File</label>
                    <input 
                        type="file" 
                        id="file" 
                        name="file" 
                        required
                        class="form-input"
                        accept="image/*,application/pdf"
                    >
                </div>
                <div>
                    <label for="alt_text" class="form-label">Alt Text</label>
                    <input 
                        type="text" 
                        id="alt_text" 
                        name="alt_text" 
                        class="form-input"
                        placeholder="Image alt text"
                    >
                </div>
                <div class="flex items-center justify-end gap-3">
                    <button 
                        type="button"
                        onclick="closeUploadModal()"
                        class="btn btn-outline"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{-- Delete Confirmation Modal --}}
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 text-center">Delete Media</h3>
            <p class="text-sm text-gray-500 text-center mt-2">
                Are you sure you want to delete "<span id="mediaFilename"></span>"? This action cannot be undone.
            </p>
            <div class="flex items-center justify-end gap-3 mt-4">
                <button 
                    type="button"
                    onclick="closeDeleteModal()"
                    class="btn btn-outline"
                >
                    Cancel
                </button>
                <form id="deleteForm" method="POST" class="inline">
                    @csrf
                    @method('DELETE')
                    <button type="submit" class="btn btn-primary bg-red-600 hover:bg-red-700">
                        Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@push('scripts')
<script>
function openUploadModal() {
    document.getElementById('uploadModal').classList.remove('hidden');
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
}

function confirmDelete(id, filename) {
    document.getElementById('mediaFilename').textContent = filename;
    document.getElementById('deleteForm').action = `/admin/media/${id}`;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

// Handle upload form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const response = await fetch('{{ route("admin.media.upload") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        }
    });
    
    const data = await response.json();
    
    if (data.success) {
        closeUploadModal();
        window.location.reload();
    } else {
        alert('Upload failed: ' + data.message);
    }
});

// Close modals when clicking outside
document.getElementById('uploadModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUploadModal();
    }
});

document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
@endpush
@endsection
```

#### Step 2: Add Helper Method to View

Create a view composer or add to AppServiceProvider:

**File: `app/Providers/AppServiceProvider.php`** (add method)

```php
use Illuminate\Support\Facades\View;

public function boot(): void
{
    View::composer('admin.media.index', function ($view) {
        $view->with('formatBytes', function ($bytes) {
            $units = ['B', 'KB', 'MB', 'GB'];
            $bytes = max($bytes, 0);
            $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
            $pow = min($pow, count($units) - 1);
            $bytes /= pow(1024, $pow);
            return round($bytes, 2) . ' ' . $units[$pow];
        });
    });
}
```

### 5.3 Validation
- Test media library interface
- Verify thumbnails display
- Test search and filtering
- Test upload modal
- Verify pagination

## 6. Task P3.3.3: Implement Image Optimization

### 6.1 Overview
The image optimization is already implemented in MediaService. This section covers additional optimization features.

### 6.2 Step-by-Step Implementation

#### Step 1: Add WebP Conversion (Optional)

Update `MediaService::processImage()` to create WebP versions:

```php
protected function processImage(UploadedFile $file, string $path, array $options): array
{
    $image = Image::make($file);
    $data = [
        'width' => $image->width(),
        'height' => $image->height(),
    ];

    // ... existing resize logic ...

    // Create WebP version if supported
    if ($options['create_webp'] ?? false) {
        $webpPath = str_replace(['.jpg', '.jpeg', '.png'], '.webp', $path);
        $fullWebpPath = Storage::disk($this->disk)->path($webpPath);
        
        $image->encode('webp', 85)->save($fullWebpPath);
    }

    // ... rest of method ...
}
```

### 6.3 Validation
- Upload large images and verify resizing
- Check thumbnail creation
- Verify file sizes are reduced
- Test WebP conversion if implemented

## 7. Task P3.3.4: Add Media Deletion

### 7.1 Overview
The deletion functionality is already implemented. This section ensures proper cleanup.

### 7.2 Step-by-Step Implementation

The `destroy` method in `AdminMediaController` and `delete` method in `MediaService` are already implemented. Verify they work correctly.

### 7.3 Create Media Show View

**File: `resources/views/admin/media/show.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Media Details')

@section('content')
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {{-- Preview --}}
            <div>
                @if($media->isImage())
                    <img src="{{ $media->url }}" alt="{{ $media->alt_text ?? $media->filename }}" class="w-full rounded-lg">
                @else
                    <div class="flex items-center justify-center h-64 bg-gray-100 rounded-lg">
                        <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                @endif
            </div>

            {{-- Details --}}
            <div>
                <h2 class="text-xl font-bold mb-4">Media Details</h2>
                
                <form method="POST" action="{{ route('admin.media.update', $media) }}">
                    @csrf
                    @method('PUT')
                    
                    <div class="space-y-4">
                        <div>
                            <label for="alt_text" class="form-label">Alt Text</label>
                            <input 
                                type="text" 
                                id="alt_text" 
                                name="alt_text" 
                                value="{{ old('alt_text', $media->alt_text) }}"
                                class="form-input"
                            >
                        </div>

                        <div>
                            <label for="description" class="form-label">Description</label>
                            <textarea 
                                id="description" 
                                name="description" 
                                rows="3"
                                class="form-input"
                            >{{ old('description', $media->description) }}</textarea>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                            <div><strong>Filename:</strong> {{ $media->filename }}</div>
                            <div><strong>Original:</strong> {{ $media->original_filename }}</div>
                            <div><strong>Size:</strong> {{ number_format($media->size / 1024, 2) }} KB</div>
                            <div><strong>Type:</strong> {{ $media->mime_type }}</div>
                            @if($media->isImage())
                                <div><strong>Dimensions:</strong> {{ $media->width }} Ã— {{ $media->height }}px</div>
                            @endif
                            <div><strong>Uploaded:</strong> {{ $media->created_at->format('M d, Y g:i A') }}</div>
                        </div>

                        <div class="flex items-center gap-3">
                            <button type="submit" class="btn btn-primary">Update</button>
                            <a href="{{ route('admin.media.index') }}" class="btn btn-outline">Back</a>
                            <button 
                                type="button"
                                onclick="confirmDelete({{ $media->id }}, '{{ addslashes($media->filename) }}')"
                                class="btn btn-outline text-red-600 border-red-600 hover:bg-red-50"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{{-- Delete Modal (same as index) --}}
@endsection
```

### 7.4 Validation
- Test media deletion
- Verify files are removed from storage
- Check thumbnails are deleted
- Verify database records are soft-deleted

## 8. Integration with TinyMCE

### 8.1 Update TinyMCE Configuration

In page and blog post forms, ensure TinyMCE is configured to use the media upload endpoint:

```javascript
tinymce.init({
    // ... other config ...
    images_upload_url: '{{ route("admin.media.upload") }}',
    automatic_uploads: true,
    file_picker_types: 'image',
});
```

## 9. Testing and Validation

### 9.1 Complete Workflow Test

1. **Upload Media:**
   - Navigate to `/admin/media`
   - Click "Upload Media"
   - Select file and upload
   - Verify file appears in library

2. **View Media:**
   - Click on media item
   - Verify details display
   - Update alt text and description

3. **Use in Content:**
   - Create/edit page or blog post
   - Insert image via TinyMCE
   - Verify image displays correctly

4. **Delete Media:**
   - Click delete on media item
   - Confirm deletion
   - Verify file is removed

### 9.2 Common Issues and Solutions

#### Issue: Images not uploading
**Solution:**
- Check file permissions on storage directory
- Verify max file size in PHP config
- Check disk configuration
- Verify Intervention Image is installed

#### Issue: Thumbnails not generating
**Solution:**
- Check GD or Imagick extension is enabled
- Verify storage permissions
- Check thumbnail directory exists
- Review error logs

#### Issue: Files not accessible
**Solution:**
- Run `php artisan storage:link`
- Verify public disk URL is correct
- Check file permissions

## 10. References

### 10.1 Architecture Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`

### 10.2 External Resources
- [Laravel File Storage](https://laravel.com/docs/10.x/filesystem)
- [Intervention Image](https://image.intervention.io/v2)

### 10.3 Related Tasks
- **Previous Task**: P3.2 - Blog Management
- **Next Task**: P3.4 - Form Management
- **Dependencies**: P3.1.5, P3.2.6

---

**Document Version**: 1.0  
**Last Updated**: 2025  
**Status**: Ready for Implementation
