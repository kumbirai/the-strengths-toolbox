# P6.2.1-P6.2.3 Caching Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing config, route, and view caching in The Strengths Toolbox website to improve performance.

### 1.2 Scope
This implementation plan covers tasks P6.2.1 through P6.2.3:
- **P6.2.1**: Implement config caching
- **P6.2.2**: Implement route caching
- **P6.2.3**: Implement view caching

### 1.3 Success Criteria
- Config cache working in production
- Route cache working in production
- View cache working in production
- Cache cleared appropriately during development
- Cache invalidation on deployment
- Performance improvements measurable

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel caching mechanisms
- Artisan commands
- Production deployment practices

### 2.2 Dependencies
- Laravel framework installed
- File system writable for cache storage
- Production environment configured

### 2.3 Reference Documents
- Performance Architecture: `documentation/01-architecture/07-performance-optimization-architecture.md`
- Laravel Caching: https://laravel.com/docs/cache

## 3. Existing Implementation Review

### 3.1 Current State
- CacheService exists with cache clearing methods
- Some query result caching in services
- Config and route caching not explicitly implemented
- View caching not implemented

### 3.2 What Needs to Be Done
- Implement config caching for production
- Implement route caching for production
- Implement view caching for production
- Create deployment scripts to handle caching
- Document cache clearing procedures

## 4. Task P6.2.1: Implement Config Caching

### 4.1 Overview
Cache configuration files to avoid reading and parsing them on every request.

### 4.2 Step-by-Step Implementation

#### Step 1: Create Config Cache Command for Production

**File: `app/Console/Commands/CacheConfig.php`**

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;

class CacheConfig extends Command
{
    protected $signature = 'config:cache-production';
    protected $description = 'Cache configuration files for production';

    public function handle(): int
    {
        if (!app()->environment('production')) {
            $this->warn('Config caching should only be used in production!');
            if (!$this->confirm('Continue anyway?')) {
                return 1;
            }
        }

        $this->info('Caching configuration files...');
        $this->call('config:cache');
        $this->info('Configuration cached successfully!');

        return 0;
    }
}
```

#### Step 2: Update Deployment Script

**File: `deploy.sh`**

**Update required:**
Add config caching to deployment:

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache
```

#### Step 3: Document Config Cache Clearing

**Note:** Config cache must be cleared when:
- Environment variables change
- Config files are modified
- During development

**Command:**
```bash
php artisan config:clear
```

## 5. Task P6.2.2: Implement Route Caching

### 5.1 Overview
Cache route definitions to avoid scanning route files on every request.

### 5.2 Step-by-Step Implementation

#### Step 1: Create Route Cache Command for Production

**File: `app/Console/Commands/CacheRoutes.php`**

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;

class CacheRoutes extends Command
{
    protected $signature = 'route:cache-production';
    protected $description = 'Cache routes for production';

    public function handle(): int
    {
        if (!app()->environment('production')) {
            $this->warn('Route caching should only be used in production!');
            if (!$this->confirm('Continue anyway?')) {
                return 1;
            }
        }

        $this->info('Caching routes...');
        $this->call('route:cache');
        $this->info('Routes cached successfully!');

        return 0;
    }
}
```

#### Step 2: Verify Route Caching Compatibility

**Action:** Ensure all routes use:
- Controller classes (not closures)
- Named routes
- Route model binding properly configured

#### Step 3: Document Route Cache Clearing

**Note:** Route cache must be cleared when:
- Routes are added/modified
- Route files change
- During development

**Command:**
```bash
php artisan route:clear
```

## 6. Task P6.2.3: Implement View Caching

### 6.1 Overview
Cache compiled Blade views to avoid recompiling on every request.

### 6.2 Step-by-Step Implementation

#### Step 1: Create View Cache Command for Production

**File: `app/Console/Commands/CacheViews.php`**

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;

class CacheViews extends Command
{
    protected $signature = 'view:cache-production';
    protected $description = 'Cache views for production';

    public function handle(): int
    {
        if (!app()->environment('production')) {
            $this->warn('View caching should only be used in production!');
            if (!$this->confirm('Continue anyway?')) {
                return 1;
            }
        }

        $this->info('Caching views...');
        $this->call('view:cache');
        $this->info('Views cached successfully!');

        return 0;
    }
}
```

#### Step 2: Update CacheService

**File: `app/Services/CacheService.php`**

**Update required:**
Add method to cache all:

```php
/**
 * Cache all (config, routes, views)
 *
 * @return void
 */
public function cacheAll(): void
{
    if (app()->environment('production')) {
        Artisan::call('config:cache');
        Artisan::call('route:cache');
        Artisan::call('view:cache');
    }
}

/**
 * Clear all caches
 *
 * @return void
 */
public function clearAll(): void
{
    Artisan::call('cache:clear');
    Artisan::call('config:clear');
    Artisan::call('route:clear');
    Artisan::call('view:clear');
}
```

#### Step 3: Create Production Cache Command

**File: `app/Console/Commands/CacheProduction.php`**

```php
<?php

namespace App\Console\Commands;

use App\Services\CacheService;
use Illuminate\Console\Command;

class CacheProduction extends Command
{
    protected $signature = 'cache:production';
    protected $description = 'Cache all for production (config, routes, views)';

    protected CacheService $cacheService;

    public function __construct(CacheService $cacheService)
    {
        parent::__construct();
        $this->cacheService = $cacheService;
    }

    public function handle(): int
    {
        if (!app()->environment('production')) {
            $this->warn('This command is intended for production use!');
            if (!$this->confirm('Continue anyway?')) {
                return 1;
            }
        }

        $this->info('Caching all for production...');
        $this->cacheService->cacheAll();
        $this->info('All caches created successfully!');

        return 0;
    }
}
```

## 7. Testing Instructions

### 7.1 Development Testing

1. **Test Cache Clearing:**
   ```bash
   php artisan cache:clear
   php artisan config:clear
   php artisan route:clear
   php artisan view:clear
   ```

2. **Verify No Cache in Development:**
   - Ensure caches are not created in development
   - Verify routes work without cache

### 7.2 Production Testing

1. **Test Cache Creation:**
   ```bash
   php artisan cache:production
   ```

2. **Verify Performance:**
   - Measure page load times before caching
   - Measure page load times after caching
   - Verify improvements

3. **Test Cache Clearing:**
   - Clear caches
   - Verify site still works
   - Recreate caches

## 8. Success Criteria Validation

- [ ] Config cache working in production
- [ ] Route cache working in production
- [ ] View cache working in production
- [ ] Cache cleared in development
- [ ] Deployment script handles caching
- [ ] Performance improvements measurable

## 9. Notes and Considerations

1. **Development vs Production:**
   - Never use config/route/view cache in development
   - Always clear caches in development
   - Only cache in production

2. **Cache Invalidation:**
   - Clear caches when deploying
   - Recreate caches after deployment
   - Monitor for stale cache issues

3. **Performance Impact:**
   - Config cache: Significant improvement
   - Route cache: Moderate improvement
   - View cache: Moderate improvement

4. **Troubleshooting:**
   - If routes don't work: Clear route cache
   - If config changes don't apply: Clear config cache
   - If views don't update: Clear view cache

---

**Document Version:** 1.0  
**Date Created:** 2025-01-27  
**Status:** Ready for Implementation
