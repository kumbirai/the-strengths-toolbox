# P6.2.6 Image Lazy Loading Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing image lazy loading across The Strengths Toolbox website to improve initial page load times and Core Web Vitals.

### 1.2 Scope
This implementation plan covers task P6.2.6:
- **P6.2.6**: Implement image lazy loading
  - Add native lazy loading attributes
  - Implement Intersection Observer for older browsers
  - Add loading placeholders
  - Optimize above-the-fold images
  - Ensure proper image dimensions

### 1.3 Success Criteria
- All below-the-fold images lazy loaded
- Above-the-fold images load immediately
- Proper image dimensions set
- Loading placeholders implemented
- Browser compatibility ensured
- Performance improvements measurable

## 2. Prerequisites

### 2.1 Required Knowledge
- HTML image attributes
- Intersection Observer API
- Core Web Vitals
- Image optimization

### 2.2 Dependencies
- Images optimized (from Phase 5)
- Image components/helpers exist

### 2.3 Reference Documents
- Performance Architecture: `documentation/01-architecture/07-performance-optimization-architecture.md`

## 3. Existing Implementation Review

### 3.1 Current State
- Some images may have lazy loading
- May need comprehensive implementation
- Image optimization exists

### 3.2 What Needs to Be Done
- Add lazy loading to all appropriate images
- Implement fallback for older browsers
- Add loading placeholders
- Ensure proper dimensions

## 4. Task P6.2.6: Implement Image Lazy Loading

### 4.1 Overview
Implement native lazy loading with Intersection Observer fallback for comprehensive browser support.

### 4.2 Step-by-Step Implementation

#### Step 1: Create Image Component

**File: `resources/views/components/image.blade.php`**

```blade
@props([
    'src',
    'alt' => '',
    'width' => null,
    'height' => null,
    'lazy' => true,
    'class' => '',
    'placeholder' => true,
])

@php
    $isAboveFold = $lazy === false;
    $loading = $isAboveFold ? 'eager' : 'lazy';
    $decoding = 'async';
@endphp

<img 
    src="{{ $src }}"
    alt="{{ $alt }}"
    @if($width) width="{{ $width }}" @endif
    @if($height) height="{{ $height }}" @endif
    loading="{{ $loading }}"
    decoding="{{ $decoding }}"
    class="{{ $class }}"
    @if($placeholder && $lazy)
        style="background-color: #f3f4f6; min-height: {{ $height ?? 200 }}px;"
    @endif
>
```

#### Step 2: Update All Image Tags

**Files to update:**
- All Blade views with images
- Blog post views
- Page views
- Component views

**Action:** Replace `<img>` tags with `<x-image>` component:

```blade
{{-- Before --}}
<img src="{{ $image }}" alt="Description">

{{-- After --}}
<x-image 
    src="{{ $image }}" 
    alt="Description"
    width="800"
    height="600"
    :lazy="true"
/>
```

#### Step 3: Add Intersection Observer Fallback

**File: `resources/js/app.js`**

**Update required:**
```javascript
// Lazy load images with Intersection Observer (fallback for older browsers)
document.addEventListener('DOMContentLoaded', function() {
    // Check if native lazy loading is supported
    if ('loading' in HTMLImageElement.prototype) {
        // Native lazy loading is supported, no need for Intersection Observer
        return;
    }

    // Fallback: Use Intersection Observer
    const images = document.querySelectorAll('img[data-src]');
    
    if (images.length === 0) {
        return;
    }

    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                if (img.dataset.srcset) {
                    img.srcset = img.dataset.srcset;
                }
                img.removeAttribute('data-src');
                img.removeAttribute('data-srcset');
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: '50px', // Start loading 50px before image enters viewport
    });

    images.forEach(img => imageObserver.observe(img));
});
```

#### Step 4: Update Image Component for Fallback

**File: `resources/views/components/image.blade.php`**

**Update for Intersection Observer:**
```blade
@props([
    'src',
    'alt' => '',
    'width' => null,
    'height' => null,
    'lazy' => true,
    'class' => '',
    'placeholder' => true,
])

@php
    $isAboveFold = $lazy === false;
    $supportsLazy = true; // Assume modern browser
    $loading = $isAboveFold ? 'eager' : 'lazy';
    $decoding = 'async';
    
    // For fallback, use data-src
    $actualSrc = $isAboveFold || !$lazy ? $src : null;
    $dataSrc = !$isAboveFold && $lazy ? $src : null;
@endphp

<img 
    @if($actualSrc) src="{{ $actualSrc }}" @endif
    @if($dataSrc) data-src="{{ $dataSrc }}" @endif
    alt="{{ $alt }}"
    @if($width) width="{{ $width }}" @endif
    @if($height) height="{{ $height }}" @endif
    @if($lazy && !$isAboveFold) loading="lazy" @endif
    decoding="{{ $decoding }}"
    class="{{ $class }}"
    @if($placeholder && $lazy)
        style="background-color: #f3f4f6; min-height: {{ $height ?? 200 }}px;"
    @endif
>
```

#### Step 5: Identify Above-the-Fold Images

**Files to update:**
- `resources/views/pages/home.blade.php` (hero image)
- `resources/views/components/header.blade.php` (logo)

**Action:** Mark above-the-fold images as `:lazy="false"`:

```blade
{{-- Hero image - above the fold --}}
<x-image 
    src="{{ asset('images/hero.jpg') }}" 
    alt="Hero"
    width="1200"
    height="600"
    :lazy="false"
/>
```

#### Step 6: Add Image Dimensions

**Action:** Ensure all images have width and height attributes to prevent layout shift:

```blade
<x-image 
    src="{{ $post->featured_image }}" 
    alt="{{ $post->title }}"
    width="800"
    height="450"
/>
```

## 5. Testing Instructions

### 5.1 Browser Testing

1. **Test in modern browsers:**
   - Chrome (supports native lazy loading)
   - Firefox (supports native lazy loading)
   - Safari (supports native lazy loading)
   - Edge (supports native lazy loading)

2. **Test in older browsers:**
   - Verify Intersection Observer fallback works
   - Check images load when scrolled into view

### 5.2 Performance Testing

1. **Measure LCP:**
   - Use PageSpeed Insights
   - Verify LCP image loads immediately
   - Verify other images lazy load

2. **Check Network Tab:**
   - Verify images don't load until needed
   - Check loading="lazy" attribute present

## 6. Success Criteria Validation

- [ ] All below-the-fold images have lazy loading
- [ ] Above-the-fold images load immediately
- [ ] Image dimensions set to prevent layout shift
- [ ] Intersection Observer fallback works
- [ ] Performance improvements measurable

## 7. Notes and Considerations

1. **Above-the-Fold Images:**
   - Hero images: Load immediately
   - Logo: Load immediately
   - First content image: Load immediately

2. **Below-the-Fold Images:**
   - Blog post images: Lazy load
   - Gallery images: Lazy load
   - Footer images: Lazy load

3. **Image Dimensions:**
   - Always set width and height
   - Prevents Cumulative Layout Shift (CLS)
   - Improves Core Web Vitals

4. **Browser Support:**
   - Native lazy loading: Chrome 76+, Firefox 75+, Safari 15.4+
   - Intersection Observer: All modern browsers
   - Fallback needed for older browsers

---

**Document Version:** 1.0  
**Date Created:** 2025-01-27  
**Status:** Ready for Implementation
