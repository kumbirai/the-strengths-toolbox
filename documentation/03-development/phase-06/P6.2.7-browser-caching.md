# P6.2.7 Browser Caching Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing HTTP caching headers to enable browser caching and improve performance for returning visitors.

### 1.2 Scope
This implementation plan covers task P6.2.7:
- **P6.2.7**: Configure browser caching
  - Set Cache-Control headers
  - Configure ETag headers
  - Set appropriate cache durations
  - Handle cache invalidation
  - Configure for different asset types

### 1.3 Success Criteria
- Static assets cached by browsers
- HTML pages cached appropriately
- Cache-Control headers set correctly
- ETag headers implemented
- Cache invalidation working
- Performance improvements for returning visitors

## 2. Prerequisites

### 2.1 Required Knowledge
- HTTP caching headers
- Cache-Control directives
- ETag implementation
- Web server configuration

### 2.2 Dependencies
- Web server (Apache/Nginx)
- Laravel middleware capability

### 2.3 Reference Documents
- Performance Architecture: `documentation/01-architecture/07-performance-optimization-architecture.md`

## 3. Existing Implementation Review

### 3.1 Current State
- May have basic caching headers
- May need comprehensive implementation

### 3.2 What Needs to Be Done
- Implement Cache-Control headers
- Add ETag support
- Configure different cache durations for different content types
- Handle cache invalidation

## 4. Task P6.2.7: Configure Browser Caching

### 4.1 Overview
Implement HTTP caching headers to enable browser caching for static assets and dynamic content.

### 4.2 Step-by-Step Implementation

#### Step 1: Create Cache Headers Middleware

**File: `app/Http/Middleware/SetCacheHeaders.php`**

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class SetCacheHeaders
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        $response = $next($request);

        // Don't cache in development
        if (app()->environment('local')) {
            return $response;
        }

        // Don't cache admin area
        if ($request->is('admin*')) {
            $response->headers->set('Cache-Control', 'no-cache, no-store, must-revalidate');
            $response->headers->set('Pragma', 'no-cache');
            $response->headers->set('Expires', '0');
            return $response;
        }

        // Static assets (handled by web server, but set headers as fallback)
        if ($request->is('build/*') || $request->is('images/*') || $request->is('css/*') || $request->is('js/*')) {
            $response->headers->set('Cache-Control', 'public, max-age=31536000, immutable');
            return $response;
        }

        // HTML pages - shorter cache with revalidation
        if ($response->headers->get('Content-Type') && str_contains($response->headers->get('Content-Type'), 'text/html')) {
            // Cache for 1 hour, but allow revalidation
            $response->headers->set('Cache-Control', 'public, max-age=3600, must-revalidate');
            
            // Set ETag based on content hash
            $etag = md5($response->getContent());
            $response->setEtag($etag);
            
            // Check if client has cached version
            if ($response->isNotModified($request)) {
                return $response;
            }
        }

        return $response;
    }
}
```

#### Step 2: Register Middleware

**File: `bootstrap/app.php` or `app/Http/Kernel.php`**

**Update required:**
```php
use App\Http\Middleware\SetCacheHeaders;

// In web middleware group
->middleware([
    // ... other middleware
    SetCacheHeaders::class,
])
```

#### Step 3: Configure Apache .htaccess

**File: `public/.htaccess`**

**Update required:**
```apache
# Browser Caching for Static Assets
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML - shorter cache
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Cache-Control Headers
<IfModule mod_headers.c>
    # Static assets - long cache
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico|css|js|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # HTML - shorter cache with revalidation
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
    </FilesMatch>
    
    # Disable caching for admin
    <FilesMatch "^admin">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>
```

#### Step 4: Configure Nginx (Alternative)

**File: `nginx.conf`**

**If using Nginx:**
```nginx
# Static assets
location ~* \.(jpg|jpeg|png|gif|webp|svg|ico|css|js|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
}

# HTML
location ~* \.(html|htm)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600, must-revalidate";
}

# Admin area
location /admin {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}
```

#### Step 5: Update Controllers for ETag Support

**File: `app/Http/Controllers/Web/PageController.php`**

**Update required:**
```php
public function show(Request $request, string $slug = null)
{
    // ... existing code to get page ...
    
    $seo = $this->seoService->getPageMeta($page);
    
    $response = response()->view('web.pages.show', compact('page', 'seo'));
    
    // Set ETag based on page content and last modified
    $etag = md5($page->id . $page->updated_at->timestamp);
    $response->setEtag($etag);
    $response->setLastModified($page->updated_at);
    
    // Check if not modified
    if ($response->isNotModified($request)) {
        return $response;
    }
    
    return $response;
}
```

## 5. Testing Instructions

### 5.1 Browser Testing

1. **Test Cache Headers:**
   - Open browser DevTools
   - Go to Network tab
   - Reload page
   - Check Response Headers for Cache-Control

2. **Test Caching:**
   - Load page first time
   - Reload page (should be faster)
   - Check Network tab shows "from cache"

### 5.2 Header Validation

1. **Check Static Assets:**
   ```bash
   curl -I https://www.thestrengthstoolbox.com/build/app.css
   ```
   - Verify Cache-Control header
   - Verify max-age is set

2. **Check HTML Pages:**
   ```bash
   curl -I https://www.thestrengthstoolbox.com/
   ```
   - Verify Cache-Control header
   - Verify ETag header

## 6. Success Criteria Validation

- [ ] Static assets have long cache headers
- [ ] HTML pages have appropriate cache headers
- [ ] ETag headers implemented
- [ ] Cache invalidation working
- [ ] Admin area not cached
- [ ] Performance improved for returning visitors

## 7. Notes and Considerations

1. **Cache Durations:**
   - Static assets: 1 year (immutable)
   - HTML pages: 1 hour (with revalidation)
   - API responses: Varies by endpoint

2. **Cache Invalidation:**
   - Use versioned filenames for assets
   - Use ETag for content-based invalidation
   - Clear cache on content updates

3. **Security:**
   - Don't cache sensitive content
   - Don't cache admin area
   - Use appropriate cache directives

---

**Document Version:** 1.0  
**Date Created:** 2025-01-27  
**Status:** Ready for Implementation
