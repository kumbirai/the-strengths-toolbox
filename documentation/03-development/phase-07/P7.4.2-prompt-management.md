# P7.4.2 Prompt Management Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing prompt management in the admin panel. This allows administrators to create, edit, and manage system prompts for the chatbot.

### 1.2 Scope
This implementation plan covers task P7.4.2:
- **P7.4.2**: Implement prompt management
  - Prompt CRUD operations
  - Prompt templates
  - Prompt variables
  - Prompt testing
  - Prompt versioning

### 1.3 Success Criteria
- Prompts can be created and edited
- Templates available
- Variables work correctly
- Testing functional
- Versioning implemented

## 2. Prerequisites

### 2.1 Required Knowledge
- CRUD operations
- Form handling
- Template systems
- Variable substitution

### 2.2 Dependencies
- Task P7.4.1 completed (Admin configuration)
- ChatbotConfig model exists
- Admin panel functional

### 2.3 Reference Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`
- ChatbotContextService: `app/Services/ChatbotContextService.php`

## 3. Existing Implementation Review

### 3.1 Current State
- Basic system prompt in configuration
- No prompt management interface
- Prompts hardcoded in service

### 3.2 What Needs to Be Done
- Create prompt model
- Build prompt management interface
- Implement template system
- Add variable substitution
- Add testing functionality

## 4. Task P7.4.2: Implement Prompt Management

### 4.1 Overview
Implement prompt management by:
1. Creating prompt model
2. Building management interface
3. Implementing templates
4. Adding variable substitution
5. Creating testing functionality

### 4.2 Step-by-Step Implementation

#### Step 1: Create Prompt Model

**File: `app/Models/ChatbotPrompt.php`**

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ChatbotPrompt extends Model
{
    protected $fillable = [
        'name',
        'description',
        'template',
        'variables',
        'is_active',
        'is_default',
        'version',
    ];

    protected $casts = [
        'variables' => 'array',
        'is_active' => 'boolean',
        'is_default' => 'boolean',
    ];

    /**
     * Get active default prompt
     */
    public static function getDefault(): ?self
    {
        return static::where('is_default', true)
            ->where('is_active', true)
            ->latest('version')
            ->first();
    }

    /**
     * Render prompt with variables
     */
    public function render(array $variables = []): string
    {
        $template = $this->template;
        $allVariables = array_merge($this->variables ?? [], $variables);

        foreach ($allVariables as $key => $value) {
            $template = str_replace('{' . $key . '}', $value, $template);
        }

        return $template;
    }
}
```

#### Step 2: Create Migration

**File: `database/migrations/YYYY_MM_DD_HHMMSS_create_chatbot_prompts_table.php`**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('chatbot_prompts', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->text('description')->nullable();
            $table->text('template');
            $table->json('variables')->nullable();
            $table->boolean('is_active')->default(true);
            $table->boolean('is_default')->default(false);
            $table->integer('version')->default(1);
            $table->timestamps();
            
            $table->index(['is_active', 'is_default']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('chatbot_prompts');
    }
};
```

#### Step 3: Create Prompt Controller

**File: `app/Http/Controllers/Admin/AdminChatbotPromptController.php`**

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ChatbotPrompt;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class AdminChatbotPromptController extends Controller
{
    /**
     * List all prompts
     */
    public function index()
    {
        $prompts = ChatbotPrompt::orderBy('created_at', 'desc')->get();
        return view('admin.chatbot.prompts.index', compact('prompts'));
    }

    /**
     * Show create form
     */
    public function create()
    {
        return view('admin.chatbot.prompts.create');
    }

    /**
     * Store new prompt
     */
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|string|max:255',
            'description' => 'nullable|string|max:500',
            'template' => 'required|string|max:5000',
            'variables' => 'nullable|array',
            'is_active' => 'boolean',
            'is_default' => 'boolean',
        ]);

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }

        // If setting as default, unset other defaults
        if ($request->input('is_default')) {
            ChatbotPrompt::where('is_default', true)->update(['is_default' => false]);
        }

        $prompt = ChatbotPrompt::create([
            'name' => $request->input('name'),
            'description' => $request->input('description'),
            'template' => $request->input('template'),
            'variables' => $request->input('variables', []),
            'is_active' => $request->input('is_active', true),
            'is_default' => $request->input('is_default', false),
            'version' => 1,
        ]);

        return redirect()->route('admin.chatbot.prompts.index')
            ->with('success', 'Prompt created successfully.');
    }

    /**
     * Show edit form
     */
    public function edit(ChatbotPrompt $prompt)
    {
        return view('admin.chatbot.prompts.edit', compact('prompt'));
    }

    /**
     * Update prompt
     */
    public function update(Request $request, ChatbotPrompt $prompt)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|string|max:255',
            'description' => 'nullable|string|max:500',
            'template' => 'required|string|max:5000',
            'variables' => 'nullable|array',
            'is_active' => 'boolean',
            'is_default' => 'boolean',
        ]);

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }

        // If setting as default, unset other defaults
        if ($request->input('is_default') && !$prompt->is_default) {
            ChatbotPrompt::where('is_default', true)->update(['is_default' => false]);
        }

        $prompt->update([
            'name' => $request->input('name'),
            'description' => $request->input('description'),
            'template' => $request->input('template'),
            'variables' => $request->input('variables', []),
            'is_active' => $request->input('is_active', $prompt->is_active),
            'is_default' => $request->input('is_default', $prompt->is_default),
            'version' => $prompt->version + 1,
        ]);

        return redirect()->route('admin.chatbot.prompts.index')
            ->with('success', 'Prompt updated successfully.');
    }

    /**
     * Delete prompt
     */
    public function destroy(ChatbotPrompt $prompt)
    {
        $prompt->delete();

        return redirect()->route('admin.chatbot.prompts.index')
            ->with('success', 'Prompt deleted successfully.');
    }

    /**
     * Test prompt
     */
    public function test(Request $request, ChatbotPrompt $prompt)
    {
        $variables = $request->input('variables', []);
        $rendered = $prompt->render($variables);

        return response()->json([
            'success' => true,
            'rendered' => $rendered,
        ]);
    }
}
```

#### Step 4: Add Routes

**File: `routes/admin.php`**

```php
Route::prefix('chatbot/prompts')->name('chatbot.prompts.')->group(function () {
    Route::get('/', [AdminChatbotPromptController::class, 'index'])->name('index');
    Route::get('/create', [AdminChatbotPromptController::class, 'create'])->name('create');
    Route::post('/', [AdminChatbotPromptController::class, 'store'])->name('store');
    Route::get('/{prompt}/edit', [AdminChatbotPromptController::class, 'edit'])->name('edit');
    Route::put('/{prompt}', [AdminChatbotPromptController::class, 'update'])->name('update');
    Route::delete('/{prompt}', [AdminChatbotPromptController::class, 'destroy'])->name('destroy');
    Route::post('/{prompt}/test', [AdminChatbotPromptController::class, 'test'])->name('test');
});
```

#### Step 5: Create Views

**File: `resources/views/admin/chatbot/prompts/index.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Chatbot Prompts')

@section('content')
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Chatbot Prompts</h1>
            <p class="text-gray-600 mt-2">Manage system prompts for the chatbot</p>
        </div>
        <a href="{{ route('admin.chatbot.prompts.create') }}" 
           class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700">
            Create Prompt
        </a>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Version</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @foreach($prompts as $prompt)
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ $prompt->name }}</div>
                        <div class="text-sm text-gray-500">{{ Str::limit($prompt->description, 50) }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full {{ $prompt->is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' }}">
                            {{ $prompt->is_active ? 'Active' : 'Inactive' }}
                        </span>
                        @if($prompt->is_default)
                            <span class="ml-2 px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Default</span>
                        @endif
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        v{{ $prompt->version }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ route('admin.chatbot.prompts.edit', $prompt) }}" 
                           class="text-primary-600 hover:text-primary-900">Edit</a>
                        <form action="{{ route('admin.chatbot.prompts.destroy', $prompt) }}" 
                              method="POST" class="inline">
                            @csrf
                            @method('DELETE')
                            <button type="submit" 
                                    class="text-red-600 hover:text-red-900 ml-4"
                                    onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                    </td>
                </tr>
                @endforeach
            </tbody>
        </table>
    </div>
</div>
@endsection
```

**File: `resources/views/admin/chatbot/prompts/create.blade.php`**

Similar structure to edit form with empty values.

**File: `resources/views/admin/chatbot/prompts/edit.blade.php`**

Form with prompt editing fields, variable management, and test functionality.

## 5. Update ChatbotContextService

**File: `app/Services/ChatbotContextService.php`**

Update to use prompts from database:

```php
use App\Models\ChatbotPrompt;

protected function getSystemPromptTemplate(string $template, ChatbotConversation $conversation): string
{
    $prompt = ChatbotPrompt::getDefault();
    
    if ($prompt) {
        $context = $conversation->context ?? [];
        $variables = [
            'company_name' => $context['company'] ?? 'The Strengths Toolbox',
            'phone' => $context['contact']['phone'] ?? '+27 83 294 8033',
            'email' => $context['contact']['email'] ?? 'welcome@eberhardniklaus.co.za',
        ];
        
        return $prompt->render($variables);
    }
    
    // Fallback to default
    return parent::getSystemPromptTemplate($template, $conversation);
}
```

## 6. Validation Steps

### 6.1 Code Validation

1. **Check model exists:**
   ```bash
   test -f app/Models/ChatbotPrompt.php && echo "Model exists"
   ```

2. **Verify routes:**
   ```bash
   php artisan route:list | grep prompts
   ```

### 6.2 Functional Testing

1. **Test prompt creation:**
   - Create new prompt
   - Set as default
   - Verify saved

2. **Test variable substitution:**
   - Create prompt with variables
   - Test rendering
   - Verify variables replaced

## 7. Next Steps

After completing this task:
- **P7.4.3**: Build conversation history viewer

## 8. Notes

- Prompts support versioning
- Variables can be customized
- Default prompt is used automatically
- Testing helps verify prompt rendering

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
