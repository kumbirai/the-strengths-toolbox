# P7.2.2 Conversation Storage Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing conversation storage in the chatbot system. This includes message persistence, conversation management, and data integrity.

### 1.2 Scope
This implementation plan covers task P7.2.2:
- **P7.2.2**: Implement conversation storage
  - Message persistence
  - Conversation lifecycle management
  - Data integrity checks
  - Storage optimization

### 1.3 Success Criteria
- Messages properly stored in database
- Conversations correctly managed
- Data integrity maintained
- Storage optimized for performance
- Proper indexing in place

## 2. Prerequisites

### 2.1 Required Knowledge
- Database operations
- Eloquent ORM
- Data persistence patterns
- Database indexing

### 2.2 Dependencies
- Task P1.2.3 completed (Database migrations)
- Task P7.1.1 completed (ChatbotService)
- Database tables created

### 2.3 Reference Documents
- Database Architecture: `documentation/01-architecture/03-database-architecture.md`
- ChatbotService: `app/Services/ChatbotService.php`
- Models: `app/Models/ChatbotConversation.php`, `app/Models/ChatbotMessage.php`

## 3. Existing Implementation Review

### 3.1 Current State
- Database migrations exist
- Models created with relationships
- Basic saveMessage() method exists
- Conversation creation working

### 3.2 What Needs to Be Done
- Enhance message storage
- Add conversation archiving
- Implement data cleanup
- Add storage validation
- Optimize queries

## 4. Task P7.2.2: Implement Conversation Storage

### 4.1 Overview
Enhance conversation storage by:
1. Improving message persistence
2. Adding conversation archiving
3. Implementing cleanup strategies
4. Adding data validation
5. Optimizing storage queries

### 4.2 Step-by-Step Implementation

#### Step 1: Enhance ChatbotMessage Model

**File: `app/Models/ChatbotMessage.php`**

Add scopes and methods:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;

class ChatbotMessage extends Model
{
    use HasFactory;

    const UPDATED_AT = null;

    protected $fillable = [
        'conversation_id',
        'role',
        'message',
        'tokens_used',
    ];

    protected function casts(): array
    {
        return [
            'tokens_used' => 'integer',
            'created_at' => 'datetime',
        ];
    }

    public function conversation()
    {
        return $this->belongsTo(ChatbotConversation::class, 'conversation_id');
    }

    /**
     * Scope: Get messages by role
     */
    public function scopeByRole(Builder $query, string $role): Builder
    {
        return $query->where('role', $role);
    }

    /**
     * Scope: Get recent messages
     */
    public function scopeRecent(Builder $query, int $limit = 10): Builder
    {
        return $query->orderBy('created_at', 'desc')->limit($limit);
    }

    /**
     * Scope: Get messages in date range
     */
    public function scopeInDateRange(Builder $query, $startDate, $endDate): Builder
    {
        return $query->whereBetween('created_at', [$startDate, $endDate]);
    }

    /**
     * Get message length
     */
    public function getLengthAttribute(): int
    {
        return strlen($this->message);
    }

    /**
     * Check if message is from user
     */
    public function isUserMessage(): bool
    {
        return $this->role === 'user';
    }

    /**
     * Check if message is from assistant
     */
    public function isAssistantMessage(): bool
    {
        return $this->role === 'assistant';
    }
}
```

#### Step 2: Enhance ChatbotConversation Model

**File: `app/Models/ChatbotConversation.php`**

Add methods and scopes:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;

class ChatbotConversation extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'session_id',
        'context',
    ];

    protected function casts(): array
    {
        return [
            'context' => 'array',
        ];
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function messages()
    {
        return $this->hasMany(ChatbotMessage::class, 'conversation_id');
    }

    /**
     * Scope: Get conversations by user
     */
    public function scopeByUser(Builder $query, int $userId): Builder
    {
        return $query->where('user_id', $userId);
    }

    /**
     * Scope: Get conversations by session
     */
    public function scopeBySession(Builder $query, string $sessionId): Builder
    {
        return $query->where('session_id', $sessionId);
    }

    /**
     * Scope: Get active conversations
     */
    public function scopeActive(Builder $query): Builder
    {
        return $query->whereHas('messages', function ($q) {
            $q->where('created_at', '>=', now()->subDays(30));
        });
    }

    /**
     * Scope: Get old conversations
     */
    public function scopeOld(Builder $query, int $days = 90): Builder
    {
        return $query->whereDoesntHave('messages', function ($q) use ($days) {
            $q->where('created_at', '>=', now()->subDays($days));
        });
    }

    /**
     * Get total messages count
     */
    public function getTotalMessagesAttribute(): int
    {
        return $this->messages()->count();
    }

    /**
     * Get total tokens used
     */
    public function getTotalTokensAttribute(): int
    {
        return $this->messages()->sum('tokens_used') ?? 0;
    }

    /**
     * Get last message
     */
    public function getLastMessageAttribute(): ?ChatbotMessage
    {
        return $this->messages()->latest()->first();
    }

    /**
     * Check if conversation is active
     */
    public function isActive(int $days = 30): bool
    {
        $lastMessage = $this->lastMessage;
        if (!$lastMessage) {
            return false;
        }
        return $lastMessage->created_at->isAfter(now()->subDays($days));
    }
}
```

#### Step 3: Add Storage Service Methods

**File: `app/Services/ChatbotService.php`**

Add storage-related methods:

```php
<?php

namespace App\Services;

// ... existing code ...

class ChatbotService extends BaseService
{
    // ... existing properties and methods ...

    /**
     * Save message with validation
     *
     * @param int $conversationId
     * @param string $role
     * @param string $message
     * @param int|null $tokensUsed
     * @return ChatbotMessage
     */
    public function saveMessage(int $conversationId, string $role, string $message, ?int $tokensUsed = null): ChatbotMessage
    {
        try {
            $this->validateRole($role);
            $this->validateMessage($message);

            // Verify conversation exists
            $conversation = ChatbotConversation::findOrFail($conversationId);

            $chatbotMessage = ChatbotMessage::create([
                'conversation_id' => $conversationId,
                'role' => $role,
                'message' => $message,
                'tokens_used' => $tokensUsed,
            ]);

            // Clear conversation cache
            Cache::forget("chatbot.conversation.{$conversationId}");

            // Update conversation updated_at timestamp
            $conversation->touch();

            Log::debug('Chatbot message saved', [
                'message_id' => $chatbotMessage->id,
                'conversation_id' => $conversationId,
                'role' => $role,
                'message_length' => strlen($message),
                'tokens_used' => $tokensUsed,
            ]);

            return $chatbotMessage;
        } catch (\Exception $e) {
            $this->handleError($e, 'Failed to save chatbot message');
            throw $e;
        }
    }

    /**
     * Archive old conversations
     *
     * @param int $daysOld
     * @return int Number of conversations archived
     */
    public function archiveOldConversations(int $daysOld = 90): int
    {
        $conversations = ChatbotConversation::old($daysOld)->get();
        $count = 0;

        foreach ($conversations as $conversation) {
            // Update context to mark as archived
            $context = $conversation->context ?? [];
            $context['archived'] = true;
            $context['archived_at'] = now()->toIso8601String();
            
            $conversation->update(['context' => $context]);
            $count++;
        }

        Log::info('Chatbot conversations archived', [
            'count' => $count,
            'days_old' => $daysOld,
        ]);

        return $count;
    }

    /**
     * Clean up old messages
     *
     * @param int $daysOld
     * @return int Number of messages deleted
     */
    public function cleanupOldMessages(int $daysOld = 365): int
    {
        $deleted = ChatbotMessage::where('created_at', '<', now()->subDays($daysOld))
            ->delete();

        Log::info('Chatbot messages cleaned up', [
            'deleted' => $deleted,
            'days_old' => $daysOld,
        ]);

        return $deleted;
    }

    /**
     * Get storage statistics
     *
     * @return array
     */
    public function getStorageStats(): array
    {
        return [
            'total_conversations' => ChatbotConversation::count(),
            'active_conversations' => ChatbotConversation::active()->count(),
            'total_messages' => ChatbotMessage::count(),
            'total_tokens' => ChatbotMessage::sum('tokens_used') ?? 0,
            'old_conversations' => ChatbotConversation::old()->count(),
            'messages_last_30_days' => ChatbotMessage::where('created_at', '>=', now()->subDays(30))->count(),
        ];
    }
}
```

#### Step 4: Create Artisan Command for Cleanup

**File: `app/Console/Commands/CleanupChatbotData.php`**

```php
<?php

namespace App\Console\Commands;

use App\Services\ChatbotService;
use Illuminate\Console\Command;

class CleanupChatbotData extends Command
{
    protected $signature = 'chatbot:cleanup 
                            {--days=90 : Number of days old to consider for archiving}
                            {--delete-messages : Delete old messages instead of archiving}';

    protected $description = 'Clean up old chatbot conversations and messages';

    protected ChatbotService $chatbotService;

    public function __construct(ChatbotService $chatbotService)
    {
        parent::__construct();
        $this->chatbotService = $chatbotService;
    }

    public function handle(): int
    {
        $days = (int) $this->option('days');
        $deleteMessages = $this->option('delete-messages');

        $this->info("Cleaning up chatbot data older than {$days} days...");

        // Archive old conversations
        $archived = $this->chatbotService->archiveOldConversations($days);
        $this->info("Archived {$archived} conversations.");

        // Optionally delete old messages
        if ($deleteMessages) {
            $deleted = $this->chatbotService->cleanupOldMessages($days);
            $this->info("Deleted {$deleted} old messages.");
        }

        // Show statistics
        $stats = $this->chatbotService->getStorageStats();
        $this->table(
            ['Metric', 'Value'],
            [
                ['Total Conversations', $stats['total_conversations']],
                ['Active Conversations', $stats['active_conversations']],
                ['Total Messages', $stats['total_messages']],
                ['Total Tokens', $stats['total_tokens']],
            ]
        );

        $this->info('Cleanup completed successfully.');

        return Command::SUCCESS;
    }
}
```

#### Step 5: Add Database Indexes (Migration)

**File: `database/migrations/YYYY_MM_DD_HHMMSS_add_chatbot_indexes.php`**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('chatbot_messages', function (Blueprint $table) {
            $table->index(['conversation_id', 'created_at']);
            $table->index(['role', 'created_at']);
            $table->index('created_at');
        });

        Schema::table('chatbot_conversations', function (Blueprint $table) {
            $table->index(['user_id', 'created_at']);
            $table->index(['session_id', 'created_at']);
            $table->index('created_at');
        });
    }

    public function down(): void
    {
        Schema::table('chatbot_messages', function (Blueprint $table) {
            $table->dropIndex(['conversation_id', 'created_at']);
            $table->dropIndex(['role', 'created_at']);
            $table->dropIndex(['created_at']);
        });

        Schema::table('chatbot_conversations', function (Blueprint $table) {
            $table->dropIndex(['user_id', 'created_at']);
            $table->dropIndex(['session_id', 'created_at']);
            $table->dropIndex(['created_at']);
        });
    }
};
```

## 5. Validation Steps

### 5.1 Code Validation

1. **Check models have new methods:**
   ```bash
   grep -n "scopeByRole\|getTotalMessages" app/Models/ChatbotMessage.php
   ```

2. **Verify command exists:**
   ```bash
   php artisan list | grep chatbot:cleanup
   ```

### 5.2 Functional Testing

1. **Test message storage:**
   ```php
   $service = app(\App\Services\ChatbotService::class);
   $conversation = $service->createConversation('test_session');
   $message = $service->saveMessage($conversation->id, 'user', 'Test message');
   assert($message->id > 0);
   ```

2. **Test cleanup command:**
   ```bash
   php artisan chatbot:cleanup --days=90
   ```

## 6. Next Steps

After completing this task:
- **P7.2.3**: Add conversation retrieval

## 7. Notes

- Messages are immutable (no updates)
- Conversations track last activity
- Cleanup should be run regularly
- Indexes improve query performance

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
