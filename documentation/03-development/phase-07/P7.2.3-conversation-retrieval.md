# P7.2.3 Conversation Retrieval Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing conversation retrieval functionality. This includes retrieving conversation history, pagination, filtering, and efficient data loading.

### 1.2 Scope
This implementation plan covers task P7.2.3:
- **P7.2.3**: Add conversation retrieval
  - Retrieve conversation with messages
  - Implement pagination
  - Add filtering options
  - Optimize queries
  - Cache retrieval results

### 1.3 Success Criteria
- Conversations retrieved efficiently
- Pagination working correctly
- Filtering options available
- Queries optimized
- Caching implemented
- Performance acceptable

## 2. Prerequisites

### 2.1 Required Knowledge
- Eloquent ORM queries
- Eager loading
- Pagination
- Caching strategies

### 2.2 Dependencies
- Task P7.2.2 completed (Conversation storage)
- Database indexes in place
- Cache system configured

### 2.3 Reference Documents
- ChatbotService: `app/Services/ChatbotService.php`
- Models: `app/Models/ChatbotConversation.php`, `app/Models/ChatbotMessage.php`

## 3. Existing Implementation Review

### 3.1 Current State
- Basic getConversation() method exists
- Messages loaded with conversation
- No pagination
- No filtering

### 3.2 What Needs to Be Done
- Add pagination support
- Implement filtering
- Optimize queries
- Add caching
- Improve response formatting

## 4. Task P7.2.3: Add Conversation Retrieval

### 4.1 Overview
Enhance conversation retrieval by:
1. Adding pagination
2. Implementing filtering
3. Optimizing queries
4. Adding caching
5. Improving response format

### 4.2 Step-by-Step Implementation

#### Step 1: Enhance ChatbotService Retrieval Methods

**File: `app/Services/ChatbotService.php`**

Add enhanced retrieval methods:

```php
<?php

namespace App\Services;

// ... existing code ...

class ChatbotService extends BaseService
{
    // ... existing properties and methods ...

    /**
     * Get conversation with messages (paginated)
     *
     * @param int $conversationId
     * @param int $perPage
     * @param int $page
     * @return array
     */
    public function getConversationPaginated(int $conversationId, int $perPage = 20, int $page = 1): array
    {
        $cacheKey = "chatbot.conversation.{$conversationId}.page.{$page}.perpage.{$perPage}";

        return Cache::remember($cacheKey, 300, function () use ($conversationId, $perPage, $page) {
            $conversation = ChatbotConversation::findOrFail($conversationId);

            $messages = $conversation->messages()
                ->orderBy('created_at', 'asc')
                ->paginate($perPage, ['*'], 'page', $page);

            return [
                'conversation' => [
                    'id' => $conversation->id,
                    'session_id' => $conversation->session_id,
                    'user_id' => $conversation->user_id,
                    'created_at' => $conversation->created_at->toIso8601String(),
                    'updated_at' => $conversation->updated_at->toIso8601String(),
                    'total_messages' => $conversation->messages()->count(),
                ],
                'messages' => $messages->items(),
                'pagination' => [
                    'current_page' => $messages->currentPage(),
                    'per_page' => $messages->perPage(),
                    'total' => $messages->total(),
                    'last_page' => $messages->lastPage(),
                    'from' => $messages->firstItem(),
                    'to' => $messages->lastItem(),
                ],
            ];
        });
    }

    /**
     * Get conversation messages with filters
     *
     * @param int $conversationId
     * @param array $filters
     * @param int $limit
     * @return \Illuminate\Database\Eloquent\Collection
     */
    public function getConversationMessages(
        int $conversationId,
        array $filters = [],
        int $limit = 50
    ): \Illuminate\Database\Eloquent\Collection {
        $query = ChatbotMessage::where('conversation_id', $conversationId);

        // Filter by role
        if (isset($filters['role'])) {
            $query->where('role', $filters['role']);
        }

        // Filter by date range
        if (isset($filters['start_date'])) {
            $query->where('created_at', '>=', $filters['start_date']);
        }

        if (isset($filters['end_date'])) {
            $query->where('created_at', '<=', $filters['end_date']);
        }

        // Filter by tokens used
        if (isset($filters['min_tokens'])) {
            $query->where('tokens_used', '>=', $filters['min_tokens']);
        }

        // Order and limit
        $query->orderBy('created_at', $filters['order'] ?? 'asc')
              ->limit($limit);

        return $query->get();
    }

    /**
     * Get recent conversations for user
     *
     * @param int|null $userId
     * @param int $limit
     * @return \Illuminate\Database\Eloquent\Collection
     */
    public function getRecentConversations(?int $userId = null, int $limit = 10): \Illuminate\Database\Eloquent\Collection
    {
        $query = ChatbotConversation::with(['messages' => function ($q) {
            $q->latest()->limit(1);
        }]);

        if ($userId) {
            $query->where('user_id', $userId);
        }

        return $query->orderBy('updated_at', 'desc')
                    ->limit($limit)
                    ->get();
    }

    /**
     * Search conversations
     *
     * @param string $searchTerm
     * @param array $filters
     * @param int $limit
     * @return \Illuminate\Database\Eloquent\Collection
     */
    public function searchConversations(
        string $searchTerm,
        array $filters = [],
        int $limit = 20
    ): \Illuminate\Database\Eloquent\Collection {
        $query = ChatbotConversation::whereHas('messages', function ($q) use ($searchTerm) {
            $q->where('message', 'like', "%{$searchTerm}%");
        });

        // Filter by user
        if (isset($filters['user_id'])) {
            $query->where('user_id', $filters['user_id']);
        }

        // Filter by date range
        if (isset($filters['start_date'])) {
            $query->where('created_at', '>=', $filters['start_date']);
        }

        if (isset($filters['end_date'])) {
            $query->where('created_at', '<=', $filters['end_date']);
        }

        return $query->with('messages')
                    ->orderBy('updated_at', 'desc')
                    ->limit($limit)
                    ->get();
    }

    /**
     * Get conversation summary
     *
     * @param int $conversationId
     * @return array
     */
    public function getConversationSummary(int $conversationId): array
    {
        $cacheKey = "chatbot.conversation.summary.{$conversationId}";

        return Cache::remember($cacheKey, 600, function () use ($conversationId) {
            $conversation = ChatbotConversation::findOrFail($conversationId);
            $messages = $conversation->messages;

            return [
                'id' => $conversation->id,
                'session_id' => $conversation->session_id,
                'user_id' => $conversation->user_id,
                'total_messages' => $messages->count(),
                'user_messages' => $messages->where('role', 'user')->count(),
                'assistant_messages' => $messages->where('role', 'assistant')->count(),
                'total_tokens' => $messages->sum('tokens_used') ?? 0,
                'first_message_at' => $messages->first()?->created_at?->toIso8601String(),
                'last_message_at' => $messages->last()?->created_at?->toIso8601String(),
                'created_at' => $conversation->created_at->toIso8601String(),
                'updated_at' => $conversation->updated_at->toIso8601String(),
            ];
        });
    }

    /**
     * Clear conversation cache
     *
     * @param int $conversationId
     * @return void
     */
    public function clearConversationCache(int $conversationId): void
    {
        $patterns = [
            "chatbot.conversation.{$conversationId}",
            "chatbot.conversation.{$conversationId}.*",
            "chatbot.conversation.summary.{$conversationId}",
        ];

        foreach ($patterns as $pattern) {
            Cache::forget($pattern);
        }

        // Clear all paginated cache entries (if using tag-based cache)
        if (method_exists(Cache::getStore(), 'tags')) {
            Cache::tags(["chatbot.conversation.{$conversationId}"])->flush();
        }
    }
}
```

#### Step 2: Update ChatbotController

**File: `app/Http/Controllers/Api/ChatbotController.php`**

Add retrieval endpoints:

```php
<?php

namespace App\Http\Controllers\Api;

// ... existing code ...

class ChatbotController extends Controller
{
    // ... existing methods ...

    /**
     * Get conversation with pagination
     *
     * @param Request $request
     * @param int $conversationId
     * @return JsonResponse
     */
    public function getConversationPaginated(Request $request, int $conversationId): JsonResponse
    {
        $perPage = (int) $request->input('per_page', 20);
        $page = (int) $request->input('page', 1);

        try {
            $data = $this->chatbotService->getConversationPaginated($conversationId, $perPage, $page);

            return response()->json([
                'success' => true,
                ...$data,
            ]);
        } catch (\Exception $e) {
            Log::error('Chatbot conversation retrieval error', [
                'conversation_id' => $conversationId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'An error occurred retrieving the conversation.',
                'error_code' => 'CONVERSATION_RETRIEVAL_ERROR',
            ], 500);
        }
    }

    /**
     * Search conversations
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function searchConversations(Request $request): JsonResponse
    {
        $validator = Validator::make($request->all(), [
            'search' => 'required|string|min:1|max:255',
            'user_id' => 'nullable|integer|exists:users,id',
            'start_date' => 'nullable|date',
            'end_date' => 'nullable|date|after_or_equal:start_date',
            'limit' => 'nullable|integer|min:1|max:100',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Invalid search parameters.',
                'errors' => $validator->errors(),
            ], 422);
        }

        try {
            $filters = $request->only(['user_id', 'start_date', 'end_date']);
            $limit = (int) $request->input('limit', 20);
            $searchTerm = $request->input('search');

            $conversations = $this->chatbotService->searchConversations($searchTerm, $filters, $limit);

            return response()->json([
                'success' => true,
                'conversations' => $conversations,
                'count' => $conversations->count(),
            ]);
        } catch (\Exception $e) {
            Log::error('Chatbot search error', [
                'error' => $e->getMessage(),
                'search' => $request->input('search'),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'An error occurred searching conversations.',
                'error_code' => 'SEARCH_ERROR',
            ], 500);
        }
    }

    /**
     * Get conversation summary
     *
     * @param Request $request
     * @param int $conversationId
     * @return JsonResponse
     */
    public function getConversationSummary(Request $request, int $conversationId): JsonResponse
    {
        try {
            $summary = $this->chatbotService->getConversationSummary($conversationId);

            return response()->json([
                'success' => true,
                'summary' => $summary,
            ]);
        } catch (\Exception $e) {
            Log::error('Chatbot summary retrieval error', [
                'conversation_id' => $conversationId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'An error occurred retrieving conversation summary.',
                'error_code' => 'SUMMARY_RETRIEVAL_ERROR',
            ], 500);
        }
    }
}
```

#### Step 3: Update API Routes

**File: `routes/api.php`**

Add new routes:

```php
<?php

use App\Http\Controllers\Api\ChatbotController;
use Illuminate\Support\Facades\Route;

Route::prefix('chatbot')->name('api.chatbot.')->group(function () {
    // ... existing routes ...

    // Get conversation with pagination
    Route::get('/conversation/{conversationId}/messages', [ChatbotController::class, 'getConversationPaginated'])
        ->middleware(['throttle:20,1'])
        ->name('conversation.messages');
    
    // Search conversations
    Route::get('/conversations/search', [ChatbotController::class, 'searchConversations'])
        ->middleware(['throttle:10,1'])
        ->name('conversations.search');
    
    // Get conversation summary
    Route::get('/conversation/{conversationId}/summary', [ChatbotController::class, 'getConversationSummary'])
        ->middleware(['throttle:20,1'])
        ->name('conversation.summary');
});
```

## 5. Validation Steps

### 5.1 Code Validation

1. **Check methods exist:**
   ```bash
   grep -n "getConversationPaginated\|searchConversations" app/Services/ChatbotService.php
   ```

2. **Verify routes:**
   ```bash
   php artisan route:list | grep chatbot
   ```

### 5.2 Functional Testing

1. **Test pagination:**
   ```bash
   curl "http://localhost:8000/api/chatbot/conversation/1/messages?per_page=10&page=1"
   ```

2. **Test search:**
   ```bash
   curl "http://localhost:8000/api/chatbot/conversations/search?search=hello"
   ```

## 6. Next Steps

After completing this task:
- **P7.3.1**: Build chatbot widget UI
- **P7.3.2**: Implement chat interface

## 7. Notes

- Pagination improves performance for long conversations
- Caching reduces database load
- Search is case-insensitive
- Filters can be combined

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
