# P7.4.1 Admin Configuration Interface Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for building the admin configuration interface for the chatbot. This allows administrators to configure chatbot settings, system prompts, and behavior.

### 1.2 Scope
This implementation plan covers task P7.4.1:
- **P7.4.1**: Build chatbot configuration interface
  - Configuration form
  - Settings management
  - System prompt configuration
  - Rate limit settings
  - API settings

### 1.3 Success Criteria
- Configuration interface created
- Settings can be updated
- Validation working
- Changes persist
- UI is intuitive

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel admin panel structure
- Form handling
- Validation
- Blade templating

### 2.2 Dependencies
- Task P1.4.3 completed (Admin authentication)
- Admin panel structure exists
- Chatbot services implemented

### 2.3 Reference Documents
- Admin Panel Architecture: `documentation/01-architecture/09-admin-panel-architecture.md`
- ChatbotService: `app/Services/ChatbotService.php`

## 3. Existing Implementation Review

### 3.1 Current State
- Admin panel structure exists
- Authentication working
- Dashboard functional
- No chatbot configuration yet

### 3.2 What Needs to Be Done
- Create configuration controller
- Build configuration form
- Add settings storage
- Implement validation
- Add update functionality

## 4. Task P7.4.1: Build Chatbot Configuration Interface

### 4.1 Overview
Create admin configuration interface by:
1. Creating configuration controller
2. Building configuration form
3. Implementing settings storage
4. Adding validation
5. Creating update functionality

### 4.2 Step-by-Step Implementation

#### Step 1: Create Configuration Model

**File: `app/Models/ChatbotConfig.php`**

Create model for storing configuration:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ChatbotConfig extends Model
{
    protected $fillable = [
        'key',
        'value',
        'type',
        'group',
    ];

    protected $casts = [
        'value' => 'array',
    ];

    /**
     * Get configuration value
     */
    public static function get(string $key, $default = null)
    {
        $config = static::where('key', $key)->first();
        return $config ? $config->value : $default;
    }

    /**
     * Set configuration value
     */
    public static function set(string $key, $value, string $type = 'string', string $group = 'general'): void
    {
        static::updateOrCreate(
            ['key' => $key],
            [
                'value' => $value,
                'type' => $type,
                'group' => $group,
            ]
        );
    }

    /**
     * Get all configurations by group
     */
    public static function getByGroup(string $group): array
    {
        return static::where('group', $group)
            ->get()
            ->pluck('value', 'key')
            ->toArray();
    }
}
```

#### Step 2: Create Migration

**File: `database/migrations/YYYY_MM_DD_HHMMSS_create_chatbot_configs_table.php`**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('chatbot_configs', function (Blueprint $table) {
            $table->id();
            $table->string('key')->unique();
            $table->text('value');
            $table->string('type')->default('string');
            $table->string('group')->default('general');
            $table->timestamps();
            
            $table->index('group');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('chatbot_configs');
    }
};
```

#### Step 3: Create Admin Controller

**File: `app/Http/Controllers/Admin/AdminChatbotController.php`**

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ChatbotConfig;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class AdminChatbotController extends Controller
{
    /**
     * Show chatbot configuration
     */
    public function index()
    {
        $config = [
            'general' => ChatbotConfig::getByGroup('general'),
            'openai' => ChatbotConfig::getByGroup('openai'),
            'rate_limiting' => ChatbotConfig::getByGroup('rate_limiting'),
            'system_prompt' => ChatbotConfig::getByGroup('system_prompt'),
        ];

        return view('admin.chatbot.index', compact('config'));
    }

    /**
     * Update chatbot configuration
     */
    public function update(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'enabled' => 'nullable|boolean',
            'max_context_messages' => 'nullable|integer|min:1|max:50',
            'max_message_length' => 'nullable|integer|min:1|max:5000',
            'openai_model' => 'nullable|string|in:gpt-4,gpt-3.5-turbo',
            'openai_max_tokens' => 'nullable|integer|min:1|max:4000',
            'openai_temperature' => 'nullable|numeric|min:0|max:2',
            'rate_limit_per_minute' => 'nullable|integer|min:1|max:100',
            'rate_limit_per_hour' => 'nullable|integer|min:1|max:1000',
            'system_prompt' => 'nullable|string|max:2000',
        ]);

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }

        // Update general settings
        ChatbotConfig::set('enabled', $request->input('enabled', true), 'boolean', 'general');
        ChatbotConfig::set('max_context_messages', $request->input('max_context_messages', 10), 'integer', 'general');
        ChatbotConfig::set('max_message_length', $request->input('max_message_length', 1000), 'integer', 'general');

        // Update OpenAI settings
        ChatbotConfig::set('model', $request->input('openai_model', 'gpt-4'), 'string', 'openai');
        ChatbotConfig::set('max_tokens', $request->input('openai_max_tokens', 500), 'integer', 'openai');
        ChatbotConfig::set('temperature', $request->input('openai_temperature', 0.7), 'float', 'openai');

        // Update rate limiting
        ChatbotConfig::set('per_minute', $request->input('rate_limit_per_minute', 10), 'integer', 'rate_limiting');
        ChatbotConfig::set('per_hour', $request->input('rate_limit_per_hour', 60), 'integer', 'rate_limiting');

        // Update system prompt
        ChatbotConfig::set('default_prompt', $request->input('system_prompt', ''), 'string', 'system_prompt');

        return redirect()->route('admin.chatbot.index')
            ->with('success', 'Chatbot configuration updated successfully.');
    }

    /**
     * Test chatbot configuration
     */
    public function test(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'test_message' => 'required|string|max:500',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Invalid test message.',
            ], 422);
        }

        try {
            $chatbotService = app(\App\Services\ChatbotService::class);
            $conversation = $chatbotService->createConversation('test_' . time());
            
            $response = $chatbotService->sendMessage(
                $conversation->id,
                $request->input('test_message')
            );

            return response()->json([
                'success' => true,
                'response' => $response,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 500);
        }
    }
}
```

#### Step 4: Create Admin Routes

**File: `routes/admin.php`**

Add chatbot routes:

```php
<?php

use App\Http\Controllers\Admin\AdminChatbotController;
// ... existing imports ...

Route::middleware('admin.auth')->group(function () {
    // ... existing routes ...
    
    // Chatbot management
    Route::prefix('chatbot')->name('chatbot.')->group(function () {
        Route::get('/', [AdminChatbotController::class, 'index'])->name('index');
        Route::post('/update', [AdminChatbotController::class, 'update'])->name('update');
        Route::post('/test', [AdminChatbotController::class, 'test'])->name('test');
    });
});
```

#### Step 5: Create Configuration View

**File: `resources/views/admin/chatbot/index.blade.php`**

```blade
@extends('layouts.admin')

@section('title', 'Chatbot Configuration')

@section('content')
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Chatbot Configuration</h1>
        <p class="text-gray-600 mt-2">Configure chatbot settings and behavior</p>
    </div>

    @if(session('success'))
        <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded mb-4">
            {{ session('success') }}
        </div>
    @endif

    <form action="{{ route('admin.chatbot.update') }}" method="POST" class="space-y-6">
        @csrf
        @method('PUT')

        {{-- General Settings --}}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">General Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <input type="checkbox" name="enabled" value="1" 
                               {{ ($config['general']['enabled'] ?? true) ? 'checked' : '' }}
                               class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Enable Chatbot
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Max Context Messages
                    </label>
                    <input type="number" name="max_context_messages" 
                           value="{{ $config['general']['max_context_messages'] ?? 10 }}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="1" max="50">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Max Message Length
                    </label>
                    <input type="number" name="max_message_length" 
                           value="{{ $config['general']['max_message_length'] ?? 1000 }}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="1" max="5000">
                </div>
            </div>
        </div>

        {{-- OpenAI Settings --}}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">OpenAI Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Model
                    </label>
                    <select name="openai_model" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="gpt-4" {{ ($config['openai']['model'] ?? 'gpt-4') === 'gpt-4' ? 'selected' : '' }}>GPT-4</option>
                        <option value="gpt-3.5-turbo" {{ ($config['openai']['model'] ?? '') === 'gpt-3.5-turbo' ? 'selected' : '' }}>GPT-3.5 Turbo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Max Tokens
                    </label>
                    <input type="number" name="openai_max_tokens" 
                           value="{{ $config['openai']['max_tokens'] ?? 500 }}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="1" max="4000">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Temperature (0-2)
                    </label>
                    <input type="number" name="openai_temperature" 
                           value="{{ $config['openai']['temperature'] ?? 0.7 }}"
                           step="0.1"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="0" max="2">
                </div>
            </div>
        </div>

        {{-- Rate Limiting --}}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Rate Limiting</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Requests Per Minute
                    </label>
                    <input type="number" name="rate_limit_per_minute" 
                           value="{{ $config['rate_limiting']['per_minute'] ?? 10 }}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="1" max="100">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Requests Per Hour
                    </label>
                    <input type="number" name="rate_limit_per_hour" 
                           value="{{ $config['rate_limiting']['per_hour'] ?? 60 }}"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           min="1" max="1000">
                </div>
            </div>
        </div>

        {{-- System Prompt --}}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">System Prompt</h2>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Default System Prompt
                </label>
                <textarea name="system_prompt" rows="6"
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                          maxlength="2000">{{ $config['system_prompt']['default_prompt'] ?? '' }}</textarea>
                <p class="text-sm text-gray-500 mt-1">Maximum 2000 characters</p>
            </div>
        </div>

        {{-- Submit Button --}}
        <div class="flex justify-end">
            <button type="submit" 
                    class="bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors">
                Save Configuration
            </button>
        </div>
    </form>

    {{-- Test Section --}}
    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4">Test Configuration</h2>
        <div x-data="{ testing: false, message: '', response: null }">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Test Message
                    </label>
                    <input type="text" x-model="message" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="Enter a test message">
                </div>
                <button @click="testing = true; fetch('{{ route('admin.chatbot.test') }}', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': '{{ csrf_token() }}' }, body: JSON.stringify({ test_message: message }) }).then(r => r.json()).then(d => { response = d; testing = false; })"
                        :disabled="testing || !message"
                        class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 disabled:opacity-50">
                    <span x-show="!testing">Test Chatbot</span>
                    <span x-show="testing">Testing...</span>
                </button>
                <div x-show="response" class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <pre x-text="JSON.stringify(response, null, 2)" class="text-sm"></pre>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection
```

## 5. Validation Steps

### 5.1 Code Validation

1. **Check controller exists:**
   ```bash
   test -f app/Http/Controllers/Admin/AdminChatbotController.php && echo "Controller exists"
   ```

2. **Verify routes:**
   ```bash
   php artisan route:list | grep chatbot
   ```

### 5.2 Functional Testing

1. **Test configuration update:**
   - Log into admin
   - Navigate to chatbot configuration
   - Update settings
   - Verify changes saved

## 6. Next Steps

After completing this task:
- **P7.4.2**: Implement prompt management
- **P7.4.3**: Build conversation history viewer

## 7. Notes

- Configuration stored in database
- Settings can be updated without code changes
- Test functionality helps verify configuration
- Validation ensures data integrity

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
