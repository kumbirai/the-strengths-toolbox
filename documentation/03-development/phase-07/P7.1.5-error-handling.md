# P7.1.5 Error Handling Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing comprehensive error handling in the chatbot service. This includes error classification, user-friendly error messages, logging, and graceful degradation.

### 1.2 Scope
This implementation plan covers task P7.1.5:
- **P7.1.5**: Implement error handling
  - Error classification and types
  - User-friendly error messages
  - Comprehensive logging
  - Graceful error recovery
  - Error response formatting

### 1.3 Success Criteria
- All errors properly classified
- User-friendly error messages
- Comprehensive error logging
- Graceful error recovery
- Consistent error response format
- No sensitive data exposed in errors

## 2. Prerequisites

### 2.1 Required Knowledge
- Exception handling in PHP
- Error logging best practices
- User experience considerations
- Security best practices

### 2.2 Dependencies
- Task P7.1.1 completed (ChatbotService)
- Task P7.1.2 completed (OpenAI integration)
- Task P7.1.4 completed (Rate limiting)
- Logging system configured

### 2.3 Reference Documents
- AI Chatbot Architecture: `documentation/01-architecture/06-ai-chatbot-architecture.md`
- ChatbotService: `app/Services/ChatbotService.php`
- OpenAIClient: `app/Services/OpenAIClient.php`

## 3. Existing Implementation Review

### 3.1 Current State
- Basic try-catch blocks in place
- Some error logging
- Generic error messages
- No error classification

### 3.2 What Needs to Be Done
- Create error classification system
- Implement custom exceptions
- Add user-friendly error messages
- Enhance error logging
- Implement error recovery strategies
- Add error response formatting

## 4. Task P7.1.5: Implement Error Handling

### 4.1 Overview
Implement comprehensive error handling by:
1. Creating custom exceptions
2. Classifying error types
3. Adding user-friendly messages
4. Enhancing logging
5. Implementing recovery strategies

### 4.2 Step-by-Step Implementation

#### Step 1: Create Custom Exceptions

**File: `app/Exceptions/ChatbotException.php`**

Base exception class:

```php
<?php

namespace App\Exceptions;

use Exception;

class ChatbotException extends Exception
{
    protected string $userMessage;
    protected string $errorCode;
    protected array $context;

    public function __construct(
        string $message = '',
        string $userMessage = '',
        string $errorCode = 'CHATBOT_ERROR',
        array $context = [],
        int $code = 0,
        Exception $previous = null
    ) {
        parent::__construct($message, $code, $previous);
        
        $this->userMessage = $userMessage ?: 'An error occurred. Please try again later.';
        $this->errorCode = $errorCode;
        $this->context = $context;
    }

    public function getUserMessage(): string
    {
        return $this->userMessage;
    }

    public function getErrorCode(): string
    {
        return $this->errorCode;
    }

    public function getContext(): array
    {
        return $this->context;
    }

    public function toArray(): array
    {
        return [
            'error_code' => $this->errorCode,
            'message' => $this->userMessage,
            'context' => $this->context,
        ];
    }
}
```

**File: `app/Exceptions/ChatbotApiException.php`**

API-specific exceptions:

```php
<?php

namespace App\Exceptions;

class ChatbotApiException extends ChatbotException
{
    public function __construct(
        string $message = '',
        string $userMessage = 'I\'m having trouble connecting right now. Please try again in a moment.',
        array $context = [],
        int $code = 0,
        Exception $previous = null
    ) {
        parent::__construct($message, $userMessage, 'CHATBOT_API_ERROR', $context, $code, $previous);
    }
}
```

**File: `app/Exceptions/ChatbotRateLimitException.php`**

Rate limit exception:

```php
<?php

namespace App\Exceptions;

class ChatbotRateLimitException extends ChatbotException
{
    protected int $resetAt;

    public function __construct(
        string $message = '',
        int $resetAt = 0,
        array $context = [],
        int $code = 0,
        Exception $previous = null
    ) {
        $userMessage = 'You\'ve sent too many messages. Please wait a moment before trying again.';
        
        parent::__construct($message, $userMessage, 'CHATBOT_RATE_LIMIT', $context, $code, $previous);
        
        $this->resetAt = $resetAt;
    }

    public function getResetAt(): int
    {
        return $this->resetAt;
    }
}
```

**File: `app/Exceptions/ChatbotValidationException.php`**

Validation exception:

```php
<?php

namespace App\Exceptions;

class ChatbotValidationException extends ChatbotException
{
    public function __construct(
        string $message = '',
        string $userMessage = 'Invalid message. Please check your input and try again.',
        array $context = [],
        int $code = 0,
        Exception $previous = null
    ) {
        parent::__construct($message, $userMessage, 'CHATBOT_VALIDATION_ERROR', $context, $code, $previous);
    }
}
```

#### Step 2: Create Error Handler Service

**File: `app/Services/ChatbotErrorHandler.php`**

Create service for error handling:

```php
<?php

namespace App\Services;

use App\Exceptions\ChatbotException;
use App\Exceptions\ChatbotApiException;
use App\Exceptions\ChatbotRateLimitException;
use App\Exceptions\ChatbotValidationException;
use Illuminate\Support\Facades\Log;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\ServerException;
use GuzzleHttp\Exception\RequestException;

class ChatbotErrorHandler extends BaseService
{
    /**
     * Handle exception and return user-friendly response
     *
     * @param \Exception $exception
     * @param array $context
     * @return array
     */
    public function handleException(\Exception $exception, array $context = []): array
    {
        // Log the error
        $this->logError($exception, $context);

        // Handle specific exception types
        if ($exception instanceof ChatbotException) {
            return $this->handleChatbotException($exception);
        }

        if ($exception instanceof ClientException) {
            return $this->handleClientException($exception, $context);
        }

        if ($exception instanceof ServerException) {
            return $this->handleServerException($exception, $context);
        }

        if ($exception instanceof RequestException) {
            return $this->handleRequestException($exception, $context);
        }

        // Handle generic exceptions
        return $this->handleGenericException($exception, $context);
    }

    /**
     * Handle ChatbotException
     *
     * @param ChatbotException $exception
     * @return array
     */
    protected function handleChatbotException(ChatbotException $exception): array
    {
        $response = [
            'success' => false,
            'message' => $exception->getUserMessage(),
            'error_code' => $exception->getErrorCode(),
        ];

        if ($exception instanceof ChatbotRateLimitException) {
            $response['rate_limit'] = [
                'reset_at' => \Carbon\Carbon::createFromTimestamp($exception->getResetAt())->toIso8601String(),
            ];
        }

        if (config('app.debug')) {
            $response['debug'] = [
                'message' => $exception->getMessage(),
                'context' => $exception->getContext(),
            ];
        }

        return $response;
    }

    /**
     * Handle HTTP client exceptions (4xx)
     *
     * @param ClientException $exception
     * @param array $context
     * @return array
     */
    protected function handleClientException(ClientException $exception, array $context): array
    {
        $statusCode = $exception->getResponse()->getStatusCode();
        $body = $exception->getResponse()->getBody()->getContents();
        $data = json_decode($body, true);

        $errorMessage = $data['error']['message'] ?? 'API request failed';

        if ($statusCode === 401) {
            return [
                'success' => false,
                'message' => 'I\'m having trouble connecting right now. Please try again later.',
                'error_code' => 'CHATBOT_API_AUTH_ERROR',
            ];
        }

        if ($statusCode === 429) {
            return [
                'success' => false,
                'message' => 'I\'m receiving too many requests. Please wait a moment and try again.',
                'error_code' => 'CHATBOT_API_RATE_LIMIT',
            ];
        }

        return [
            'success' => false,
            'message' => 'I encountered an error processing your request. Please try again.',
            'error_code' => 'CHATBOT_API_CLIENT_ERROR',
        ];
    }

    /**
     * Handle HTTP server exceptions (5xx)
     *
     * @param ServerException $exception
     * @param array $context
     * @return array
     */
    protected function handleServerException(ServerException $exception, array $context): array
    {
        return [
            'success' => false,
            'message' => 'The AI service is temporarily unavailable. Please try again in a moment.',
            'error_code' => 'CHATBOT_API_SERVER_ERROR',
        ];
    }

    /**
     * Handle request exceptions
     *
     * @param RequestException $exception
     * @param array $context
     * @return array
     */
    protected function handleRequestException(RequestException $exception, array $context): array
    {
        if ($exception->hasResponse()) {
            return [
                'success' => false,
                'message' => 'I\'m having trouble connecting. Please check your internet connection and try again.',
                'error_code' => 'CHATBOT_API_CONNECTION_ERROR',
            ];
        }

        return [
            'success' => false,
            'message' => 'I\'m having trouble connecting right now. Please try again later.',
            'error_code' => 'CHATBOT_API_NETWORK_ERROR',
        ];
    }

    /**
     * Handle generic exceptions
     *
     * @param \Exception $exception
     * @param array $context
     * @return array
     */
    protected function handleGenericException(\Exception $exception, array $context): array
    {
        return [
            'success' => false,
            'message' => 'An unexpected error occurred. Please try again later.',
            'error_code' => 'CHATBOT_UNKNOWN_ERROR',
        ];
    }

    /**
     * Log error with context
     *
     * @param \Exception $exception
     * @param array $context
     * @return void
     */
    protected function logError(\Exception $exception, array $context): void
    {
        $logData = [
            'exception' => get_class($exception),
            'message' => $exception->getMessage(),
            'file' => $exception->getFile(),
            'line' => $exception->getLine(),
            'trace' => $exception->getTraceAsString(),
            'context' => $context,
        ];

        // Add additional context for specific exceptions
        if ($exception instanceof ClientException) {
            $logData['status_code'] = $exception->getResponse()->getStatusCode();
            $logData['response_body'] = $exception->getResponse()->getBody()->getContents();
        }

        Log::error('Chatbot error', $logData);
    }

    /**
     * Get user-friendly error message
     *
     * @param string $errorCode
     * @return string
     */
    public function getUserMessage(string $errorCode): string
    {
        $messages = [
            'CHATBOT_API_ERROR' => 'I\'m having trouble connecting right now. Please try again in a moment.',
            'CHATBOT_API_AUTH_ERROR' => 'I\'m having trouble connecting right now. Please try again later.',
            'CHATBOT_API_RATE_LIMIT' => 'I\'m receiving too many requests. Please wait a moment and try again.',
            'CHATBOT_API_SERVER_ERROR' => 'The AI service is temporarily unavailable. Please try again in a moment.',
            'CHATBOT_API_CONNECTION_ERROR' => 'I\'m having trouble connecting. Please check your internet connection and try again.',
            'CHATBOT_API_NETWORK_ERROR' => 'I\'m having trouble connecting right now. Please try again later.',
            'CHATBOT_RATE_LIMIT' => 'You\'ve sent too many messages. Please wait a moment before trying again.',
            'CHATBOT_VALIDATION_ERROR' => 'Invalid message. Please check your input and try again.',
            'CHATBOT_UNKNOWN_ERROR' => 'An unexpected error occurred. Please try again later.',
        ];

        return $messages[$errorCode] ?? 'An error occurred. Please try again later.';
    }
}
```

#### Step 3: Update ChatbotService to Use Error Handler

**File: `app/Services/ChatbotService.php`**

Update error handling:

```php
<?php

namespace App\Services;

use App\Exceptions\ChatbotException;
use App\Exceptions\ChatbotApiException;
use App\Exceptions\ChatbotValidationException;
use App\Models\ChatbotConversation;
use App\Models\ChatbotMessage;
use Illuminate\Support\Facades\Log;

class ChatbotService extends BaseService
{
    protected OpenAIClient $openAIClient;
    protected ChatbotContextService $contextService;
    protected ChatbotRateLimitService $rateLimitService;
    protected ChatbotErrorHandler $errorHandler;
    // ... other properties ...

    public function __construct(
        OpenAIClient $openAIClient,
        ChatbotContextService $contextService,
        ChatbotRateLimitService $rateLimitService,
        ChatbotErrorHandler $errorHandler
    ) {
        $this->openAIClient = $openAIClient;
        $this->contextService = $contextService;
        $this->rateLimitService = $rateLimitService;
        $this->errorHandler = $errorHandler;
        // ... rest of initialization ...
    }

    /**
     * Send a message and get response
     *
     * @param int $conversationId
     * @param string $message
     * @param string|null $sessionId
     * @param int|null $userId
     * @param string|null $ipAddress
     * @return array
     */
    public function sendMessage(
        int $conversationId,
        string $message,
        ?string $sessionId = null,
        ?int $userId = null,
        ?string $ipAddress = null
    ): array {
        $context = [
            'conversation_id' => $conversationId,
            'session_id' => $sessionId,
            'user_id' => $userId,
            'ip_address' => $ipAddress,
        ];

        try {
            $conversation = ChatbotConversation::findOrFail($conversationId);
            
            // Validate message
            try {
                $this->validateMessage($message);
            } catch (\InvalidArgumentException $e) {
                throw new ChatbotValidationException($e->getMessage(), $e->getMessage(), $context);
            }

            // Check rate limits
            // ... rate limit checks ...

            // Save user message
            $userMessage = $this->saveMessage(
                $conversationId,
                'user',
                $message
            );

            // Build context
            $conversationHistory = $this->contextService->buildContext($conversation, $message);

            // Get system prompt
            $systemPrompt = $this->contextService->getSystemPrompt($conversation);

            // Build messages array
            $messages = $this->openAIClient->buildMessagesArray(
                $systemPrompt,
                $conversationHistory,
                $message
            );

            // Call OpenAI API
            try {
                $aiResponse = $this->openAIClient->chatCompletion($messages);
            } catch (\Exception $e) {
                throw new ChatbotApiException($e->getMessage(), null, $context, 0, $e);
            }

            // Save AI response
            $aiMessage = $this->saveMessage(
                $conversationId,
                'assistant',
                $aiResponse['content'],
                $aiResponse['tokens_used']
            );

            // Clear context cache
            $this->contextService->clearContextCache($conversationId);

            // Update conversation context
            $this->updateConversationContext($conversation);

            Log::info('Chatbot message processed', [
                'conversation_id' => $conversationId,
                'user_message_id' => $userMessage->id,
                'ai_message_id' => $aiMessage->id,
                'tokens_used' => $aiResponse['tokens_used'],
            ]);

            return [
                'success' => true,
                'message' => $aiResponse['content'],
                'conversation_id' => $conversationId,
                'user_message_id' => $userMessage->id,
                'ai_message_id' => $aiMessage->id,
                'tokens_used' => $aiResponse['tokens_used'],
            ];
        } catch (ChatbotException $e) {
            return $this->errorHandler->handleException($e, $context);
        } catch (\Exception $e) {
            return $this->errorHandler->handleException($e, $context);
        }
    }

    // ... rest of methods ...
}
```

#### Step 4: Update OpenAIClient Error Handling

**File: `app/Services/OpenAIClient.php`**

Update to throw custom exceptions:

```php
<?php

namespace App\Services;

use App\Exceptions\ChatbotApiException;
use GuzzleHttp\Client;
use GuzzleHttp\Exception\ClientException;
use GuzzleHttp\Exception\ServerException;
use GuzzleHttp\Exception\RequestException;

class OpenAIClient extends BaseService
{
    // ... existing code ...

    /**
     * Send chat completion request
     *
     * @param array $messages
     * @param array $options
     * @return array
     * @throws ChatbotApiException
     */
    public function chatCompletion(array $messages, array $options = []): array
    {
        try {
            // ... existing implementation ...
        } catch (ClientException $e) {
            $this->handleClientError($e);
            throw new ChatbotApiException('OpenAI API client error', null, ['status_code' => $e->getResponse()->getStatusCode()], 0, $e);
        } catch (ServerException $e) {
            $this->handleServerError($e);
            throw new ChatbotApiException('OpenAI API server error', null, [], 0, $e);
        } catch (RequestException $e) {
            $this->handleRequestError($e);
            throw new ChatbotApiException('OpenAI API request error', null, [], 0, $e);
        } catch (\Exception $e) {
            Log::error('OpenAI API error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            throw new ChatbotApiException('OpenAI API error', null, [], 0, $e);
        }
    }

    // ... rest of methods ...
}
```

## 5. Validation Steps

### 5.1 Code Validation

1. **Check exceptions exist:**
   ```bash
   ls -la app/Exceptions/Chatbot*.php
   ```

2. **Verify error handler exists:**
   ```bash
   test -f app/Services/ChatbotErrorHandler.php && echo "Error handler exists"
   ```

### 5.2 Functional Testing

1. **Test error handling:**
   ```php
   $handler = app(\App\Services\ChatbotErrorHandler::class);
   $exception = new \Exception('Test error');
   $response = $handler->handleException($exception);
   assert(isset($response['success']));
   assert($response['success'] === false);
   ```

## 6. Next Steps

After completing this task:
- **P7.2.1**: Build chatbot API endpoint
- **P7.2.2**: Implement conversation storage
- **P7.2.3**: Add conversation retrieval

## 7. Notes

- All errors are logged with full context
- User-friendly messages don't expose technical details
- Error codes help with debugging
- Debug mode shows additional information

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
