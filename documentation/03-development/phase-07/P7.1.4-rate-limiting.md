# P7.1.4 Rate Limiting Implementation Plan

## 1. Overview and Objectives

### 1.1 Purpose
This document provides detailed step-by-step instructions for implementing rate limiting for the chatbot service. Rate limiting prevents abuse and manages API costs by limiting the number of requests per user/session.

### 1.2 Scope
This implementation plan covers task P7.1.4:
- **P7.1.4**: Add rate limiting
  - Per-session rate limiting
  - Per-user rate limiting
  - Per-IP rate limiting
  - Rate limit middleware
  - Rate limit configuration

### 1.3 Success Criteria
- Rate limiting implemented at multiple levels
- Configurable rate limits
- Proper error messages for rate limit exceeded
- Rate limit headers in responses
- Rate limit tracking and logging

## 2. Prerequisites

### 2.1 Required Knowledge
- Laravel rate limiting
- Cache usage for rate limiting
- Middleware implementation
- HTTP headers

### 2.2 Dependencies
- Task P7.1.1 completed (ChatbotService)
- Task P2.4.3 completed (Middleware setup)
- Cache system configured
- Laravel throttling middleware

### 2.3 Reference Documents
- AI Chatbot Architecture: `documentation/01-architecture/06-ai-chatbot-architecture.md`
- ChatbotService: `app/Services/ChatbotService.php`
- Middleware: `app/Http/Middleware/`

## 3. Existing Implementation Review

### 3.1 Current State
- Basic route throttling in `routes/api.php` (10 requests per minute)
- No service-level rate limiting
- No per-conversation rate limiting

### 3.2 What Needs to Be Done
- Implement service-level rate limiting
- Add per-conversation rate limits
- Add per-user rate limits
- Create rate limit middleware
- Add rate limit configuration
- Implement rate limit responses

## 4. Task P7.1.4: Add Rate Limiting

### 4.1 Overview
Implement comprehensive rate limiting by:
1. Adding rate limit configuration
2. Creating rate limit service
3. Implementing rate limit checks
4. Adding rate limit middleware
5. Updating API responses with rate limit headers

### 4.2 Step-by-Step Implementation

#### Step 1: Add Rate Limit Configuration

**File: `config/chatbot.php`**

Add rate limiting configuration:

```php
<?php

return [
    // ... existing config ...

    /*
    |--------------------------------------------------------------------------
    | Rate Limiting Configuration
    |--------------------------------------------------------------------------
    */

    'rate_limiting' => [
        'enabled' => env('CHATBOT_RATE_LIMIT_ENABLED', true),
        'per_minute' => env('CHATBOT_RATE_LIMIT_PER_MINUTE', 10),
        'per_hour' => env('CHATBOT_RATE_LIMIT_PER_HOUR', 60),
        'per_day' => env('CHATBOT_RATE_LIMIT_PER_DAY', 200),
        'per_conversation_per_minute' => env('CHATBOT_RATE_LIMIT_CONVERSATION_PER_MINUTE', 20),
        'per_user_per_hour' => env('CHATBOT_RATE_LIMIT_USER_PER_HOUR', 100),
    ],
];
```

#### Step 2: Create Rate Limit Service

**File: `app/Services/ChatbotRateLimitService.php`**

Create service for rate limit management:

```php
<?php

namespace App\Services;

use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;

class ChatbotRateLimitService extends BaseService
{
    protected bool $enabled;
    protected int $perMinute;
    protected int $perHour;
    protected int $perDay;
    protected int $perConversationPerMinute;
    protected int $perUserPerHour;

    public function __construct()
    {
        $this->enabled = config('chatbot.rate_limiting.enabled', true);
        $this->perMinute = config('chatbot.rate_limiting.per_minute', 10);
        $this->perHour = config('chatbot.rate_limiting.per_hour', 60);
        $this->perDay = config('chatbot.rate_limiting.per_day', 200);
        $this->perConversationPerMinute = config('chatbot.rate_limiting.per_conversation_per_minute', 20);
        $this->perUserPerHour = config('chatbot.rate_limiting.per_user_per_hour', 100);
    }

    /**
     * Check if request is within rate limits
     *
     * @param string $identifier Session ID, user ID, or IP address
     * @param string $type Type of rate limit (session, user, ip, conversation)
     * @return array ['allowed' => bool, 'remaining' => int, 'reset_at' => int]
     */
    public function checkRateLimit(string $identifier, string $type = 'session'): array
    {
        if (!$this->enabled) {
            return [
                'allowed' => true,
                'remaining' => PHP_INT_MAX,
                'reset_at' => now()->addHour()->timestamp,
            ];
        }

        switch ($type) {
            case 'conversation':
                return $this->checkConversationRateLimit($identifier);
            case 'user':
                return $this->checkUserRateLimit($identifier);
            case 'ip':
                return $this->checkIpRateLimit($identifier);
            default:
                return $this->checkSessionRateLimit($identifier);
        }
    }

    /**
     * Check session rate limit
     *
     * @param string $sessionId
     * @return array
     */
    protected function checkSessionRateLimit(string $sessionId): array
    {
        $minuteKey = "chatbot.ratelimit.session.minute.{$sessionId}";
        $hourKey = "chatbot.ratelimit.session.hour.{$sessionId}";
        $dayKey = "chatbot.ratelimit.session.day.{$sessionId}";

        // Check per minute
        $minuteCount = Cache::get($minuteKey, 0);
        if ($minuteCount >= $this->perMinute) {
            return $this->rateLimitExceeded('minute', $this->perMinute, 60);
        }

        // Check per hour
        $hourCount = Cache::get($hourKey, 0);
        if ($hourCount >= $this->perHour) {
            return $this->rateLimitExceeded('hour', $this->perHour, 3600);
        }

        // Check per day
        $dayCount = Cache::get($dayKey, 0);
        if ($dayCount >= $this->perDay) {
            return $this->rateLimitExceeded('day', $this->perDay, 86400);
        }

        // Increment counters
        Cache::put($minuteKey, $minuteCount + 1, 60);
        Cache::put($hourKey, $hourCount + 1, 3600);
        Cache::put($dayKey, $dayCount + 1, 86400);

        return [
            'allowed' => true,
            'remaining' => min(
                $this->perMinute - $minuteCount - 1,
                $this->perHour - $hourCount - 1,
                $this->perDay - $dayCount - 1
            ),
            'reset_at' => now()->addMinute()->timestamp,
        ];
    }

    /**
     * Check conversation rate limit
     *
     * @param int $conversationId
     * @return array
     */
    protected function checkConversationRateLimit(int $conversationId): array
    {
        $key = "chatbot.ratelimit.conversation.minute.{$conversationId}";
        $count = Cache::get($key, 0);

        if ($count >= $this->perConversationPerMinute) {
            return $this->rateLimitExceeded('conversation_minute', $this->perConversationPerMinute, 60);
        }

        Cache::put($key, $count + 1, 60);

        return [
            'allowed' => true,
            'remaining' => $this->perConversationPerMinute - $count - 1,
            'reset_at' => now()->addMinute()->timestamp,
        ];
    }

    /**
     * Check user rate limit
     *
     * @param int $userId
     * @return array
     */
    protected function checkUserRateLimit(int $userId): array
    {
        $key = "chatbot.ratelimit.user.hour.{$userId}";
        $count = Cache::get($key, 0);

        if ($count >= $this->perUserPerHour) {
            return $this->rateLimitExceeded('user_hour', $this->perUserPerHour, 3600);
        }

        Cache::put($key, $count + 1, 3600);

        return [
            'allowed' => true,
            'remaining' => $this->perUserPerHour - $count - 1,
            'reset_at' => now()->addHour()->timestamp,
        ];
    }

    /**
     * Check IP rate limit
     *
     * @param string $ipAddress
     * @return array
     */
    protected function checkIpRateLimit(string $ipAddress): array
    {
        $key = "chatbot.ratelimit.ip.hour." . md5($ipAddress);
        $count = Cache::get($key, 0);

        // Use same limits as session for IP
        if ($count >= $this->perHour) {
            return $this->rateLimitExceeded('ip_hour', $this->perHour, 3600);
        }

        Cache::put($key, $count + 1, 3600);

        return [
            'allowed' => true,
            'remaining' => $this->perHour - $count - 1,
            'reset_at' => now()->addHour()->timestamp,
        ];
    }

    /**
     * Rate limit exceeded response
     *
     * @param string $type
     * @param int $limit
     * @param int $resetSeconds
     * @return array
     */
    protected function rateLimitExceeded(string $type, int $limit, int $resetSeconds): array
    {
        Log::warning('Chatbot rate limit exceeded', [
            'type' => $type,
            'limit' => $limit,
        ]);

        return [
            'allowed' => false,
            'remaining' => 0,
            'reset_at' => now()->addSeconds($resetSeconds)->timestamp,
            'limit' => $limit,
            'type' => $type,
        ];
    }

    /**
     * Get rate limit status
     *
     * @param string $identifier
     * @param string $type
     * @return array
     */
    public function getRateLimitStatus(string $identifier, string $type = 'session'): array
    {
        return $this->checkRateLimit($identifier, $type);
    }

    /**
     * Reset rate limit for identifier
     *
     * @param string $identifier
     * @param string $type
     * @return void
     */
    public function resetRateLimit(string $identifier, string $type = 'session'): void
    {
        $patterns = [
            "chatbot.ratelimit.{$type}.minute.{$identifier}",
            "chatbot.ratelimit.{$type}.hour.{$identifier}",
            "chatbot.ratelimit.{$type}.day.{$identifier}",
        ];

        foreach ($patterns as $pattern) {
            Cache::forget($pattern);
        }
    }
}
```

#### Step 3: Update ChatbotService to Use Rate Limiting

**File: `app/Services/ChatbotService.php`**

Add rate limiting checks:

```php
<?php

namespace App\Services;

use App\Models\ChatbotConversation;
use App\Models\ChatbotMessage;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;

class ChatbotService extends BaseService
{
    protected OpenAIClient $openAIClient;
    protected ChatbotContextService $contextService;
    protected ChatbotRateLimitService $rateLimitService;
    // ... other properties ...

    public function __construct(
        OpenAIClient $openAIClient,
        ChatbotContextService $contextService,
        ChatbotRateLimitService $rateLimitService
    ) {
        $this->openAIClient = $openAIClient;
        $this->contextService = $contextService;
        $this->rateLimitService = $rateLimitService;
        // ... rest of initialization ...
    }

    /**
     * Send a message and get response
     *
     * @param int $conversationId
     * @param string $message
     * @param string|null $sessionId
     * @param int|null $userId
     * @param string|null $ipAddress
     * @return array
     */
    public function sendMessage(
        int $conversationId,
        string $message,
        ?string $sessionId = null,
        ?int $userId = null,
        ?string $ipAddress = null
    ): array {
        try {
            // Check rate limits
            if ($sessionId) {
                $rateLimit = $this->rateLimitService->checkRateLimit($sessionId, 'session');
                if (!$rateLimit['allowed']) {
                    return $this->rateLimitExceededResponse($rateLimit);
                }
            }

            if ($conversationId) {
                $rateLimit = $this->rateLimitService->checkRateLimit($conversationId, 'conversation');
                if (!$rateLimit['allowed']) {
                    return $this->rateLimitExceededResponse($rateLimit);
                }
            }

            if ($userId) {
                $rateLimit = $this->rateLimitService->checkRateLimit($userId, 'user');
                if (!$rateLimit['allowed']) {
                    return $this->rateLimitExceededResponse($rateLimit);
                }
            }

            if ($ipAddress) {
                $rateLimit = $this->rateLimitService->checkRateLimit($ipAddress, 'ip');
                if (!$rateLimit['allowed']) {
                    return $this->rateLimitExceededResponse($rateLimit);
                }
            }

            // ... rest of sendMessage implementation ...
        } catch (\Exception $e) {
            // ... error handling ...
        }
    }

    /**
     * Rate limit exceeded response
     *
     * @param array $rateLimit
     * @return array
     */
    protected function rateLimitExceededResponse(array $rateLimit): array
    {
        $resetAt = \Carbon\Carbon::createFromTimestamp($rateLimit['reset_at']);
        $secondsUntilReset = $resetAt->diffInSeconds(now());

        return [
            'success' => false,
            'message' => 'Rate limit exceeded. Please try again later.',
            'error' => 'rate_limit_exceeded',
            'rate_limit' => [
                'limit' => $rateLimit['limit'],
                'remaining' => 0,
                'reset_at' => $resetAt->toIso8601String(),
                'reset_in_seconds' => $secondsUntilReset,
            ],
        ];
    }

    // ... rest of methods ...
}
```

#### Step 4: Create Rate Limit Middleware

**File: `app/Http/Middleware/ChatbotRateLimit.php`**

```php
<?php

namespace App\Http\Middleware;

use App\Services\ChatbotRateLimitService;
use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class ChatbotRateLimit
{
    protected ChatbotRateLimitService $rateLimitService;

    public function __construct(ChatbotRateLimitService $rateLimitService)
    {
        $this->rateLimitService = $rateLimitService;
    }

    /**
     * Handle an incoming request.
     *
     * @param Request $request
     * @param Closure $next
     * @return Response
     */
    public function handle(Request $request, Closure $next): Response
    {
        $sessionId = $request->input('session_id') ?? session()->getId();
        $userId = auth()->id();
        $ipAddress = $request->ip();

        // Check session rate limit
        $rateLimit = $this->rateLimitService->checkRateLimit($sessionId, 'session');
        
        if (!$rateLimit['allowed']) {
            return response()->json([
                'success' => false,
                'message' => 'Rate limit exceeded. Please try again later.',
                'error' => 'rate_limit_exceeded',
                'rate_limit' => [
                    'limit' => $rateLimit['limit'],
                    'remaining' => 0,
                    'reset_at' => \Carbon\Carbon::createFromTimestamp($rateLimit['reset_at'])->toIso8601String(),
                ],
            ], 429)->withHeaders([
                'X-RateLimit-Limit' => $rateLimit['limit'],
                'X-RateLimit-Remaining' => 0,
                'X-RateLimit-Reset' => $rateLimit['reset_at'],
                'Retry-After' => $rateLimit['reset_at'] - now()->timestamp,
            ]);
        }

        $response = $next($request);

        // Add rate limit headers
        return $response->withHeaders([
            'X-RateLimit-Limit' => $rateLimit['limit'] ?? 10,
            'X-RateLimit-Remaining' => $rateLimit['remaining'] ?? 0,
            'X-RateLimit-Reset' => $rateLimit['reset_at'] ?? now()->addMinute()->timestamp,
        ]);
    }
}
```

#### Step 5: Register Middleware

**File: `bootstrap/app.php`**

Add middleware alias:

```php
->withMiddleware(function (Middleware $middleware) {
    // ... existing middleware ...
    
    $middleware->alias([
        'chatbot.ratelimit' => \App\Http\Middleware\ChatbotRateLimit::class,
    ]);
})
```

#### Step 6: Update API Routes

**File: `routes/api.php`**

Apply rate limit middleware:

```php
Route::prefix('chatbot')->group(function () {
    Route::post('/message', [ChatbotController::class, 'sendMessage'])
        ->middleware(['throttle:10,1', 'chatbot.ratelimit'])
        ->name('api.chatbot.message');
    
    Route::get('/conversation/{conversationId}', [ChatbotController::class, 'getConversation'])
        ->middleware(['throttle:20,1'])
        ->name('api.chatbot.conversation');
});
```

## 5. Validation Steps

### 5.1 Code Validation

1. **Check rate limit service exists:**
   ```bash
   test -f app/Services/ChatbotRateLimitService.php && echo "Rate limit service exists"
   ```

2. **Verify middleware registered:**
   ```bash
   php artisan route:list | grep chatbot
   ```

### 5.2 Functional Testing

1. **Test rate limiting:**
   ```php
   $service = app(\App\Services\ChatbotRateLimitService::class);
   $result = $service->checkRateLimit('test_session', 'session');
   assert(isset($result['allowed']));
   ```

2. **Test rate limit exceeded:**
   ```php
   // Make 11 requests in quick succession
   for ($i = 0; $i < 11; $i++) {
       $result = $service->checkRateLimit('test_session', 'session');
   }
   assert($result['allowed'] === false);
   ```

## 6. Next Steps

After completing this task:
- **P7.1.5**: Implement comprehensive error handling

## 7. Notes

- Rate limits are configurable via environment variables
- Multiple rate limit types can be checked simultaneously
- Rate limit headers are included in API responses
- Rate limits use cache for storage

---

**Document Version:** 1.0  
**Last Updated:** 2025-01-27  
**Status:** Ready for Implementation
